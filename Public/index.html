<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Personal Finance App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="css/styles.css?v=20251206c">
  <link rel="stylesheet" href="css/enhancements.css?v=20251206c">
  <!-- Add Bootstrap Icons CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
<!-- Add Clusterize.js CDN before your main script -->
  <script src="https://unpkg.com/clusterize.js@0.18.1/clusterize.min.js"></script>
  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
  <!-- Initial Loading Screen -->
  <div id="initialScreen" style="display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
    <div style="text-align:center;color:white;">
      <h1 style="font-size:3em;margin-bottom:0.5em;text-shadow:0 4px 10px rgba(0,0,0,0.3);">ğŸ’° Personal Finance</h1>
      <p style="font-size:1.3em;margin-bottom:2em;opacity:0.9;">Track your income, expenses, and savings</p>
      <div style="display:flex;gap:1em;justify-content:center;flex-wrap:wrap;padding:0 1em;">
        <button onclick="openAuthModal('login')" style="background:white;color:#667eea;border:none;padding:1em 2em;font-size:1.1em;border-radius:50px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.2);transition:transform 0.2s;white-space:nowrap;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          ğŸ”‘ Sign In
        </button>
        <button onclick="openAuthModal('register')" style="background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:1em 2em;font-size:1.1em;border-radius:50px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.2);transition:transform 0.2s;white-space:nowrap;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          ğŸ“ Sign Up
        </button>
      </div>
    </div>
  </div>

  <div class="theme-selector">
  </div>

<div id="sidebarBackdrop"></div>
<!-- Enhanced Sidebar Menu -->
<nav id="sidebar" aria-label="Main menu" data-mini-mode="false">
  <button id="sidebarToggle" class="hamburger-btn" aria-label="Open menu" title="Open Menu (Alt+M)">
    <span class="hamburger-box">
      <span class="hamburger-inner"></span>
    </span>
  </button>
  
  <!-- Privacy Mode Toggle -->
  <div class="privacy-toggle" id="privacyToggle" title="Toggle Privacy Mode" onclick="togglePrivacyMode()">
    <span class="privacy-icon" id="privacyIcon">ğŸ‘ï¸</span>
    <span class="privacy-label">Privacy</span>
  </div>

  <div class="sidebar-links">
    <!-- Notifications Bell -->
    <div id="notificationBell" class="notification-bell" title="Notifications" onclick="toggleNotifications()">
      <span class="bell-icon">ğŸ””</span>
      <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
    </div>

    <!-- Session Timer -->
    <div id="sessionTimer" class="session-timer" style="display:none;">
      <span class="timer-icon">â±ï¸</span>
      <span id="sessionTimeRemaining">30:00</span>
    </div>

    <!-- Menu Width Toggle -->
    <button id="menuWidthToggle" class="menu-width-toggle" title="Toggle Mini Mode" onclick="toggleMiniMode()">â—€</button>
    <!-- Dashboard Section (New!) -->
    <a href="#" class="menu-link" data-section="dashboard" onclick="showSection('dashboard')" title="Dashboard (Alt+0)">
      <span class="menu-icon">ğŸ </span>
      <span class="menu-text">Dashboard</span>
      <span class="menu-badge new-badge">New</span>
    </a>

    <!-- Menu Group: Transactions -->
    <div class="menu-group">
      <div class="menu-group-header" onclick="toggleMenuGroup(this)">
        <span class="group-icon">ğŸ’°</span>
        <span class="group-title">Transactions</span>
        <span class="group-arrow">â–¼</span>
      </div>
      <div class="menu-group-content expanded">
        <a href="#" class="menu-link" data-section="income" onclick="showSection('income')" title="Income (Alt+1)">
          <span class="menu-icon">ğŸ’µ</span>
          <span class="menu-text">Income</span>
          <span class="menu-counter" id="incomeCounter"></span>
        </a>
        <a href="#" class="menu-link" data-section="expenses" onclick="showSection('expenses')" title="Expenses (Alt+2)">
          <span class="menu-icon">ğŸ’¸</span>
          <span class="menu-text">Expenses</span>
          <span class="menu-counter" id="expensesCounter"></span>
        </a>
        <a href="#" class="menu-link" data-section="transfers" onclick="showSection('transfers')" title="Transfers (Alt+5)">
          <span class="menu-icon">ğŸ”„</span>
          <span class="menu-text">Transfers</span>
        </a>
      </div>
    </div>

    <!-- Menu Group: Management -->
    <div class="menu-group">
      <div class="menu-group-header" onclick="toggleMenuGroup(this)">
        <span class="group-icon">ğŸ“Š</span>
        <span class="group-title">Management</span>
        <span class="group-arrow">â–¼</span>
      </div>
      <div class="menu-group-content expanded">
        <a href="#" class="menu-link" data-section="types" onclick="showSection('types')" title="Types (Alt+3)">
          <span class="menu-icon">ğŸ“</span>
          <span class="menu-text">Types</span>
        </a>
        <a href="#" class="menu-link" data-section="savings" onclick="showSection('savings')" title="Savings (Alt+4)">
          <span class="menu-icon">ğŸ¦</span>
          <span class="menu-text">Savings</span>
        </a>
        <a href="#" class="menu-link" data-section="balances" onclick="showSection('balances')" title="Balances (Alt+7)">
          <span class="menu-icon">ğŸ’¼</span>
          <span class="menu-text">Balances</span>
        </a>
      </div>
    </div>

    <!-- Menu Group: Analysis -->
    <div class="menu-group">
      <div class="menu-group-header" onclick="toggleMenuGroup(this)">
        <span class="group-icon">ğŸ“ˆ</span>
        <span class="group-title">Analysis</span>
        <span class="group-arrow">â–¼</span>
      </div>
      <div class="menu-group-content expanded">
        <a href="#" class="menu-link" data-section="reports" onclick="showSection('reports')" title="Reports (Alt+6)">
          <span class="menu-icon">ğŸ“Š</span>
          <span class="menu-text">Reports</span>
        </a>
      </div>
    </div>

    <!-- Menu Group: Settings -->
    <div class="menu-group">
      <div class="menu-group-header" onclick="toggleMenuGroup(this)">
        <span class="group-icon">âš™ï¸</span>
        <span class="group-title">Settings</span>
        <span class="group-arrow">â–¼</span>
      </div>
      <div class="menu-group-content expanded">
        <a href="#" class="menu-link" data-section="settings" onclick="showSection('settings')" title="Settings (Alt+8)">
          <span class="menu-icon">âš™ï¸</span>
          <span class="menu-text">Settings</span>
        </a>
      </div>
    </div>

    <!-- Recent Entries Widget -->
    <div class="recent-entries-widget" id="recentEntriesWidget">
      <div class="widget-header">
        <span class="widget-icon">ğŸ“‹</span>
        <span class="widget-title">Recent</span>
      </div>
      <div class="widget-content" id="recentEntriesContent">
        <div class="widget-loading">Loading...</div>
      </div>
    </div>

    <!-- Menu Footer Controls -->
    <div class="menu-footer">
      <!-- Language Selector -->
      <div class="language-selector">
        <label for="languageSelect"><span class="lang-icon">ğŸŒ</span> <span data-i18n="language">Language</span>:</label>
        <select id="languageSelect" onchange="changeLanguage(this.value)">
          <option value="en">ğŸ‡¬ğŸ‡§ English</option>
          <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
          <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        </select>
      </div>

      <!-- Dark Mode Toggle -->
      <div class="dark-mode-toggle">
        <label for="darkModeSwitch">
          <span class="dark-mode-icon">ğŸŒ™</span> <span data-i18n="dark_mode">Dark Mode</span>
        </label>
        <label class="switch">
          <input type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode(this.checked)">
          <span class="slider"></span>
        </label>
      </div>

      <!-- Theme selector -->
      <div class="theme-selector menu-theme-selector">
        <label for="themeSelect"><span class="theme-icon">ğŸ¨</span> <span data-i18n="theme">Theme</span>:</label>
        <select id="themeSelect">
          <option value="fancy-table">Friendly (Default)</option>
          <option value="modern-table">Modern</option>
          <option value="classic-table">Classic</option>
          <option value="business-table">Business</option>
          <option value="dark-table">Dark</option>
          <option value="light-table">Light</option>
          <option value="childish-table">Childish</option>
          <option value="christmas-table">Christmas</option>
        </select>
      </div>

      <!-- App Version & What's New -->
      <div class="app-version">
        <a href="#" onclick="showWhatsNew(); return false;" class="whats-new-link">
          <span class="version-badge" id="appVersionBadge">v2.0.0</span>
          <span class="new-indicator">âœ¨ <span data-i18n="whats_new">What's New</span></span>
        </a>
      </div>
      
      <!-- Developer Credits -->
      <div style="text-align:center;padding:0.5em;color:#999;font-size:0.75em;border-top:1px solid #eee;margin-top:0.5em;">
        <span>Developed by <strong style="color:#667eea;">Fadee Attieh</strong></span>
        <span style="margin:0 0.5em;">|</span>
        <span>Powered by <strong style="color:#667eea;">ATTmoc</strong></span>
      </div>

      <!-- Help/Tutorial Link -->
      <div class="help-link">
        <a href="#" onclick="startOnboardingTour(); return false;">
          <span class="help-icon">â“</span>
          <span data-i18n="help">Help & Tutorial</span>
        </a>
      </div>

      <!-- Login/Register Links (shown when not logged in) -->
      <div class="auth-links" id="authLinks">
        <a href="#" class="menu-link" id="loginLink" onclick="showAuthModal('login'); return false;">
          <span class="menu-icon">ğŸ”‘</span>
          <span class="menu-text">Sign In</span>
        </a>
        <a href="#" class="menu-link" id="registerLink" onclick="showAuthModal('register'); return false;">
          <span class="menu-icon">ğŸ“</span>
          <span class="menu-text">Sign Up</span>
        </a>
      </div>

      <!-- Enhanced Profile Menu with Stats -->  
      <div id="profileMenu">
        <div class="profile-avatar">
          <img id="profilePicMenu" src="" alt="Profile">
          <span class="profile-status-dot"></span>
        </div>
        <span id="profileNameMenu" class="profile-name"></span>
        <div class="profile-stats">
          <div class="profile-stat">
            <span class="stat-value" id="profileEntriesCount">0</span>
            <span class="stat-label">Entries</span>
          </div>
          <div class="profile-stat">
            <span class="stat-value" id="profileBalanceCount">$0</span>
            <span class="stat-label">Balance</span>
          </div>
        </div>
        <button onclick="logout()" class="button logout-btn">Logout</button>
      </div>
    </div>
  </div>
  </nav>

  <!-- Currency picker modal (outside sidebar) -->
  <div id="currencyPickerModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:400px;">
      <h3>ğŸ’° Select Your Currencies</h3>
      <p style="color:#666; font-size:0.9em; margin-bottom:1em;">Choose 1 or 2 currencies to manage your finances</p>
      <div id="currencyOptions" style="max-height:300px; overflow-y:auto; margin-bottom:1em;"></div>
      <div style="display:flex; gap:0.5em;">
        <button id="saveCurrenciesBtn" class="button" style="flex:1;">âœ“ Save & Continue</button>
        <button id="closeCurrencyPicker" class="button" style="flex:1; background:#dc3545;">âœ• Cancel</button>
      </div>
    </div>
  </div>

<!-- Notification Panel Modal -->
<div id="notificationPanel" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:500px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1em;">
      <h3>ğŸ”” Notifications</h3>
      <button onclick="closeNotifications()" style="background:none;border:none;font-size:1.5em;cursor:pointer;">âœ•</button>
    </div>
    <div id="notificationList" style="max-height:400px;overflow-y:auto;">
      <!-- Notifications will be populated here -->
      <div class="notification-item unread" data-type="info">
        <span class="notif-icon">â„¹ï¸</span>
        <div class="notif-content">
          <strong class="notif-title">Welcome to Personal Finance v2.0!</strong>
          <p class="notif-message">Check out the new features including Dashboard, Dark Mode, and Multi-language support.</p>
          <span class="notif-time">Just now</span>
        </div>
      </div>
    </div>
    <div style="margin-top:1em;text-align:center;">
      <button onclick="markAllNotificationsRead()" class="button" style="width:auto;">Mark All as Read</button>
    </div>
  </div>
</div>

<!-- What's New Modal -->
<div id="whatsNewModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:700px;max-height:80vh;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1em;position:sticky;top:0;background:white;padding-bottom:1em;z-index:10;">
      <h3>âœ¨ Release Notes</h3>
      <button onclick="closeWhatsNew()" style="background:none;border:none;font-size:1.5em;cursor:pointer;">âœ•</button>
    </div>
    <div class="whats-new-content">
      
      <!-- Version 2.2.1 -->
      <div class="version-section">
        <h4 style="color:#667eea;margin-bottom:0.5em;">v2.2.1 <span style="color:#999;font-size:0.8em;font-weight:normal;">December 2025</span></h4>
        <ul style="line-height:1.8;color:#666;">
          <li>ğŸ”§ Fixed menu counters not loading after login</li>
          <li>ğŸ” Fixed dashboard API authentication</li>
          <li>ğŸ“ Fixed menu text and profile overflow issues</li>
          <li>ğŸ“Š Fixed dashboard numbers wrapping - now uses responsive sizing</li>
          <li>ğŸ”„ Fixed recent entries widget token check</li>
        </ul>
      </div>

      <!-- Version 2.2.0 -->
      <div class="version-section" style="margin-top:2em;">
        <h4 style="color:#667eea;margin-bottom:0.5em;">v2.2.0 <span style="color:#999;font-size:0.8em;font-weight:normal;">December 2025</span></h4>
        <ul style="line-height:1.8;color:#666;">
          <li>ğŸ’¬ Added live chat support (Tawk.to integration)</li>
          <li>ğŸ¢ Added ATTmoc branding to footer and auth modals</li>
          <li>ğŸ”’ Chat widget hidden until signed in</li>
        </ul>
      </div>

      <!-- Version 2.1.0 -->
      <div class="version-section" style="margin-top:2em;">
        <h4 style="color:#667eea;margin-bottom:0.5em;">v2.1.0 <span style="color:#999;font-size:0.8em;font-weight:normal;">December 2025</span></h4>
        <ul style="line-height:1.8;color:#666;">
          <li>ğŸ“§ Spam folder reminder on registration</li>
          <li>âš ï¸ Email disclaimer for unintended recipients</li>
          <li>ğŸ‘¨â€ğŸ’» Developer credits in footer</li>
        </ul>
      </div>

      <!-- Version 2.0.0 -->
      <div class="version-section" style="margin-top:2em;">
        <h4 style="color:#667eea;margin-bottom:0.5em;">v2.0.0 <span style="color:#999;font-size:0.8em;font-weight:normal;">Major Release</span></h4>
        <ul style="line-height:1.8;color:#666;">
          <li>ğŸ  Dashboard overview with real-time stats</li>
          <li>ğŸŒ™ Dark mode support</li>
          <li>ğŸŒ Multi-language (English, French, Arabic)</li>
          <li>ğŸ“Š Enhanced menu with organized groups</li>
          <li>ğŸ‘ï¸ Privacy mode for hiding sensitive data</li>
          <li>âŒ¨ï¸ Keyboard shortcuts (Alt+0-8)</li>
          <li>ğŸ“± Mobile-optimized bottom navigation</li>
          <li>ğŸ” Cloudflare Turnstile bot protection</li>
        </ul>
      </div>
      
    </div>
    <div style="margin-top:2em;padding-top:1em;border-top:1px solid #eee;text-align:center;">
      <button onclick="closeWhatsNew()" class="button">Got it!</button>
    </div>
  </div>
</div>

<!-- Onboarding Tour Overlay -->
<div id="onboardingOverlay" class="onboarding-overlay" style="display:none;">
  <div class="onboarding-spotlight"></div>
  <div class="onboarding-tooltip" id="onboardingTooltip">
    <div class="tooltip-content">
      <h4 id="tourTitle"></h4>
      <p id="tourMessage"></p>
      <div class="tour-controls">
        <button onclick="skipTour()" class="button" style="background:#6c757d;">Skip Tour</button>
        <button onclick="nextTourStep()" class="button">Next</button>
      </div>
      <div class="tour-progress">
        <span id="tourStep"></span>
      </div>
    </div>
  </div>
</div>

<!-- Bottom Navigation for Mobile -->
<nav id="bottomNav" class="bottom-nav" style="display:none;">
  <a href="#" class="bottom-nav-item" data-section="dashboard" onclick="showSection('dashboard')">
    <span class="bottom-nav-icon">ğŸ </span>
    <span class="bottom-nav-label">Home</span>
  </a>
  <a href="#" class="bottom-nav-item" data-section="income" onclick="showSection('income')">
    <span class="bottom-nav-icon">ğŸ’µ</span>
    <span class="bottom-nav-label">Income</span>
  </a>
  <a href="#" class="bottom-nav-item" data-section="expenses" onclick="showSection('expenses')">
    <span class="bottom-nav-icon">ğŸ’¸</span>
    <span class="bottom-nav-label">Expenses</span>
  </a>
  <a href="#" class="bottom-nav-item" data-section="reports" onclick="showSection('reports')">
    <span class="bottom-nav-icon">ğŸ“Š</span>
    <span class="bottom-nav-label">Reports</span>
  </a>
  <a href="#" class="bottom-nav-item" onclick="document.getElementById('sidebar').classList.toggle('show')">
    <span class="bottom-nav-icon">â˜°</span>
    <span class="bottom-nav-label">More</span>
  </a>
</nav>

<!-- Quick Action FAB -->
<div id="quickActionFAB" class="quick-action-fab" style="display:none;">
  <button id="fabMainButton" class="fab-main-button" onclick="toggleQuickActions()">+</button>
  <div id="fabMenu" class="fab-menu" style="display:none;">
    <button class="fab-action" onclick="quickAddIncome()" title="Quick Add Income">
      <span class="fab-icon">ğŸ’µ</span>
      <span class="fab-label">Add Income</span>
    </button>
    <button class="fab-action" onclick="quickAddExpense()" title="Quick Add Expense">
      <span class="fab-icon">ğŸ’¸</span>
      <span class="fab-label">Add Expense</span>
    </button>
    <button class="fab-action" onclick="quickAddTransfer()" title="Quick Add Transfer">
      <span class="fab-icon">ğŸ”„</span>
      <span class="fab-label">Transfer</span>
    </button>
  </div>
</div>

<!-- Close month modal -->
<div id="closeMonthModal" class="modal">
  <div class="modal-content">
    <h3>Close Month</h3>
    <div id="closeMonthSummary"></div>
    <form id="closeMonthForm">
      <div id="closeMonthCurrencies"></div>
      <button type="submit" class="button">Confirm & Start New Month</button>
    </form>
    <div id="closeMonthError"></div>
  </div>
</div>

  <div class="container">
    <!-- Dashboard Section (New!) -->
    <section id="dashboard" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5em;">
        <h2>ğŸ  Dashboard</h2>
        <button onclick="showTutorial('dashboard')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:35px;height:35px;cursor:pointer;font-size:1.2em;box-shadow:0 2px 8px rgba(102,126,234,0.3);" title="Help">?</button>
      </div>

      <!-- Quick Stats Cards -->
      <div class="dashboard-stats">
        <div class="stat-card income-card">
          <div class="stat-icon">ğŸ’µ</div>
          <div class="stat-info">
            <h3 class="stat-title">Total Income</h3>
            <div id="dashTotalIncome" class="stat-value-list"></div>
            <span id="dashIncomeChange" class="stat-change"></span>
          </div>
        </div>
        <div class="stat-card expense-card">
          <div class="stat-icon">ğŸ’¸</div>
          <div class="stat-info">
            <h3 class="stat-title">Total Expenses</h3>
            <div id="dashTotalExpenses" class="stat-value-list"></div>
            <span id="dashExpensesChange" class="stat-change"></span>
          </div>
        </div>
        <div class="stat-card balance-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-info">
            <h3 class="stat-title">Current Balance</h3>
            <div id="dashCurrentBalance" class="stat-value-list"></div>
            <span id="dashBalanceChange" class="stat-change"></span>
          </div>
        </div>
        <div class="stat-card savings-card">
          <div class="stat-icon">ğŸ¦</div>
          <div class="stat-info">
            <h3 class="stat-title">Total Savings</h3>
            <div id="dashTotalSavings" class="stat-value-list"></div>
            <span id="dashSavingsChange" class="stat-change"></span>
          </div>
        </div>
      </div>

      <!-- Recent Activity & Quick Actions Row -->
      <div class="dashboard-row">
        <!-- Recent Activity -->
        <div class="dashboard-panel recent-activity-panel">
          <h3>ğŸ“‹ Recent Activity</h3>
          <div id="dashboardRecentActivity" class="activity-list">
            <p style="text-align:center;color:#666;padding:2em;">No recent activity</p>
          </div>
          <button onclick="showSection('reports')" class="button" style="width:100%;margin-top:1em;">View All Transactions</button>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-panel quick-actions-panel">
          <h3>âš¡ Quick Actions</h3>
          <div class="quick-action-grid">
            <button onclick="showSection('income')" class="quick-action-btn income-btn">
              <span class="qa-icon">ğŸ’µ</span>
              <span class="qa-label">Add Income</span>
            </button>
            <button onclick="showSection('expenses')" class="quick-action-btn expense-btn">
              <span class="qa-icon">ğŸ’¸</span>
              <span class="qa-label">Add Expense</span>
            </button>
            <button onclick="showSection('transfers')" class="quick-action-btn transfer-btn">
              <span class="qa-icon">ğŸ”„</span>
              <span class="qa-label">Transfer</span>
            </button>
            <button onclick="showSection('savings')" class="quick-action-btn savings-btn">
              <span class="qa-icon">ğŸ¦</span>
              <span class="qa-label">Save Money</span>
            </button>
            <button onclick="showSection('types')" class="quick-action-btn types-btn">
              <span class="qa-icon">ğŸ“</span>
              <span class="qa-label">Manage Types</span>
            </button>
            <button onclick="showSection('reports')" class="quick-action-btn reports-btn">
              <span class="qa-icon">ğŸ“Š</span>
              <span class="qa-label">View Reports</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Monthly Overview Chart Placeholder -->
      <div class="dashboard-panel chart-panel">
        <h3>ğŸ“ˆ Monthly Overview</h3>
        <div class="chart-placeholder" id="monthlyChart">
          <p style="text-align:center;color:#666;padding:3em;">Chart will be populated with your data</p>
        </div>
      </div>

      <!-- Top Categories -->
      <div class="dashboard-panel categories-panel">
        <h3>ğŸ† Top Expense Categories</h3>
        <div class="category-list">
          <p style="text-align:center;color:#666;padding:2em;">No expense data yet</p>
        </div>
      </div>
    </section>

    <!-- Settings Section -->
    <section id="settings" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>âš™ï¸ Settings</h2>
        <button onclick="showTutorial('settings')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:35px;height:35px;cursor:pointer;font-size:1.2em;box-shadow:0 2px 8px rgba(102,126,234,0.3);" title="Help">?</button>
      </div>
      
      <div style="background:#fff; padding:1.5em; border-radius:8px; margin-bottom:1em; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-top:0; border-bottom:2px solid #4caf50; padding-bottom:0.5em;">Monthly Cycle</h3>
        
        <div style="margin-top:1em;">
          <button onclick="manuallyCloseMonth()" class="button" style="width:auto; background:#ff9800;">
            ğŸ“… Close Current Month
          </button>
          <p style="color:#666; font-size:0.9em; margin-top:0.5em;">
            Close the current month cycle and set starting balances for the next month. 
            This is normally done automatically at the end of each month.
          </p>
        </div>
      </div>
      
      <div style="background:#fff; padding:1.5em; border-radius:8px; margin-bottom:1em; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-top:0; border-bottom:2px solid #2196f3; padding-bottom:0.5em;">ğŸ’¾ Backup & Restore</h3>
        
        <div style="margin-top:1em;">
          <button onclick="backupDatabase()" class="button" style="width:auto; background:#2196f3;">
            â¬‡ï¸ Backup Database
          </button>
          <p style="color:#666; font-size:0.9em; margin-top:0.5em;">
            Download all your data as a JSON file. This includes entries, balances, savings, transfers, types, and settings.
          </p>
        </div>
        
        <div style="margin-top:1em;">
          <button onclick="document.getElementById('restoreFileInput').click()" class="button" style="width:auto; background:#9c27b0;">
            â¬†ï¸ Restore Database
          </button>
          <input type="file" id="restoreFileInput" accept=".json" style="display:none;" onchange="restoreDatabase(this.files[0])">
          <p style="color:#666; font-size:0.9em; margin-top:0.5em;">
            <strong>Warning:</strong> This will replace all your current data with the backup file.
            Make sure to backup first!
          </p>
        </div>
      </div>
      
      <div style="background:#fff; padding:1.5em; border-radius:8px; margin-bottom:1em; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-top:0; border-bottom:2px solid #2196f3; padding-bottom:0.5em;">ğŸ’¾ Backup & Restore</h3>
        
        <div style="margin-top:1em;">
          <button onclick="backupDatabase()" class="button" style="width:auto; background:#2196f3;">
            â¬‡ï¸ Backup Database
          </button>
          <p style="color:#666; font-size:0.9em; margin-top:0.5em;">
            Download all your data as a JSON file. This includes entries, balances, savings, transfers, types, and settings.
          </p>
        </div>
        
        <div style="margin-top:1em;">
          <button onclick="document.getElementById('restoreFileInput').click()" class="button" style="width:auto; background:#9c27b0;">
            â¬†ï¸ Restore Database
          </button>
          <input type="file" id="restoreFileInput" accept=".json" style="display:none;" onchange="restoreDatabase(this.files[0])">
          <p style="color:#666; font-size:0.9em; margin-top:0.5em;">
            <strong>Warning:</strong> This will replace all your current data with the backup file.
            Make sure to backup first!
          </p>
        </div>
      </div>
      
      <div style="background:#fff; padding:1.5em; border-radius:8px; margin-bottom:1em; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-top:0; border-bottom:2px solid #f44336; padding-bottom:0.5em;">âš ï¸ Danger Zone</h3>
        
        <div style="margin-top:1em;">
          <button onclick="resetDatabase()" class="button" style="width:auto; background:#f44336;">
            ğŸ—‘ï¸ Reset Database
          </button>
          <p style="color:#666; font-size:0.9em; margin-top:0.5em;">
            <strong>Warning:</strong> This will permanently delete all your entries, balances, savings, transfers, and closed months.
            Your income/expense types and currency selections will be preserved.
          </p>
        </div>
      </div>
    </section>

    <!-- Income -->
    <section id="income" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Add Income</h2>
        <button onclick="showTutorial('income')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:35px;height:35px;cursor:pointer;font-size:1.2em;box-shadow:0 2px 8px rgba(102,126,234,0.3);" title="Help">?</button>
      </div>
      <div id="incomeBalances" class="balance-info"></div>
      <form id="incomeForm">
        <input name="amount" placeholder="Amount" required>
        <select name="currency" id="incomeCurrency" required>
          <option value="USD">USD</option>
          <option value="LBP">LBP</option>
        </select>
        <input name="date" type="datetime-local" id="incomeDate" required>
        <input name="note" placeholder="Note">
        <select name="typeId" id="incomeType" required>
          <!-- Populated by JS with income types -->
        </select>
        <button type="submit" class="button">Add Income</button>
      </form>
      <div id="incomeResult"></div>
      <div id="incomeGrid"></div> <!-- Data grid for income -->
    </section>

    <!-- Expenses -->
    <section id="expenses" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Add Expense</h2>
        <button onclick="showTutorial('expenses')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:35px;height:35px;cursor:pointer;font-size:1.2em;box-shadow:0 2px 8px rgba(102,126,234,0.3);" title="Help">?</button>
      </div>
      <div id="expensesBalances" class="balance-info"></div>
      <form id="expenseForm">
        <input name="amount" placeholder="Amount" required>
        <select name="currency" id="expenseCurrency" required>
          <option value="USD">USD</option>
          <option value="LBP">LBP</option>
        </select>
        <input name="date" type="datetime-local" id="expenseDate" required>
        <input name="note" placeholder="Note">
        <select name="typeId" id="expenseType" required>
          <!-- Populated by JS with expense types -->
        </select>
        <button type="submit" class="button">Add Expense</button>
      </form>
      <div id="expenseResult"></div>
      <div id="expenseGrid"></div> <!-- Data grid for expenses -->
    </section>
    <!-- Types -->
    <section id="types" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Add Type</h2>
        <button onclick="showTutorial('types')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:35px;height:35px;cursor:pointer;font-size:1.2em;box-shadow:0 2px 8px rgba(102,126,234,0.3);" title="Help">?</button>
      </div>
      <div style="display:flex; gap:1em; margin-bottom:1em; flex-wrap:wrap;">
        <button type="button" onclick="downloadTypesTemplate()" class="button" style="background:#2196F3; width:auto;">ğŸ“¥ Download Template</button>
        <button type="button" onclick="document.getElementById('typesFileInput').click()" class="button" style="background:#ff9800; width:auto;">ğŸ“¤ Import from Excel</button>
        <input type="file" id="typesFileInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="importTypesFromExcel(event)">
      </div>
      <form id="typeForm">
        <input name="name" placeholder="Type Name" required>
        <select name="category" required>
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>
        <input name="description" placeholder="Description (optional)">
        <button type="submit" class="button">Add Type</button>
      </form>
      <div id="typeResult"></div>
      <div id="typeGrid"></div> <!-- Data grid for types -->
    </section>
    <!-- Savings -->
    <section id="savings" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Add Savings</h2>
        <button onclick="showTutorial('savings')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:35px;height:35px;cursor:pointer;font-size:1.2em;box-shadow:0 2px 8px rgba(102,126,234,0.3);" title="Help">?</button>
      </div>
      <div id="savingsBalances" class="balance-info"></div>
      <form id="savingsForm">
        <input name="amount" placeholder="Amount" required>
        <select name="currency" id="savingsCurrency" required>
          <option value="USD">USD</option>
          <option value="LBP">LBP</option>
        </select>
        <input name="date" type="datetime-local" id="savingsDate" required>
        <input name="note" placeholder="Note">
        <button type="submit" class="button">Add Savings</button>
      </form>
      <div id="savingsResult"></div>
      <div id="savingsGrid"></div> <!-- Data grid for savings -->
    </section>
    <!-- Transfers -->
    <section id="transfers" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Add Transfer</h2>
        <button onclick="showTutorial('transfers')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:35px;height:35px;cursor:pointer;font-size:1.2em;box-shadow:0 2px 8px rgba(102,126,234,0.3);" title="Help">?</button>
      </div>
      <div id="transfersBalances" class="balance-info"></div>
      <form id="transferForm">
        <select name="from_account" id="transferFrom" required>
          <option value="money_on_hand">Money on Hand</option>
          <option value="savings">Savings</option>
        </select>
        <select name="to_account" id="transferTo" required>
          <option value="savings">Savings</option>
          <option value="money_on_hand">Money on Hand</option>
        </select>
        <input name="amount" placeholder="Amount" required>
        <select name="currency" id="transferCurrency" required>
          <option value="USD">USD</option>
          <option value="LBP">LBP</option>
        </select>
        <input name="date" type="datetime-local" id="transferDate" required>
        <input name="note" placeholder="Note">
        <button type="submit" class="button">Add Transfer</button>
      </form>
      <div id="transferResult"></div>
      <div id="transferGrid"></div> <!-- Data grid for transfers -->
    </section>
    <!-- Reports -->
    <section id="reports" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Monthly Report</h2>
        <button onclick="showTutorial('reports')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:35px;height:35px;cursor:pointer;font-size:1.2em;box-shadow:0 2px 8px rgba(102,126,234,0.3);" title="Help">?</button>
      </div>
      <form id="reportForm" style="display:flex;gap:1em;align-items:end;flex-wrap:wrap;background:linear-gradient(135deg,rgba(102,126,234,0.05),rgba(118,75,162,0.05));padding:1.5em;border-radius:12px;border:2px solid rgba(102,126,234,0.2);">
        <div style="flex:1;min-width:150px;">
          <label style="display:block;margin-bottom:0.5em;color:#667eea;font-weight:600;">Month</label>
          <select name="month" id="reportMonth" required style="width:100%;padding:0.7em;border-radius:8px;border:2px solid rgba(102,126,234,0.3);"></select>
        </div>
        <div style="flex:1;min-width:150px;">
          <label style="display:block;margin-bottom:0.5em;color:#667eea;font-weight:600;">Year</label>
          <select name="year" id="reportYear" required style="width:100%;padding:0.7em;border-radius:8px;border:2px solid rgba(102,126,234,0.3);"></select>
        </div>
        <div style="flex:1;min-width:150px;">
          <label style="display:block;margin-bottom:0.5em;color:#667eea;font-weight:600;">Currency</label>
          <select name="currency" id="reportCurrency" required style="width:100%;padding:0.7em;border-radius:8px;border:2px solid rgba(102,126,234,0.3);">
            <option value="USD">USD</option>
            <option value="LBP">LBP</option>
          </select>
        </div>
        <button type="submit" class="button" style="padding:0.7em 2em;margin-bottom:0;">ğŸ“Š Generate Report</button>
      </form>
      <div class="report-tabs" style="margin-top:2em;">
        <button class="report-tab active" id="tabBalance" onclick="showReportTab('balance')">ğŸ’° Balance Overview</button>
        <button class="report-tab" id="tabSavings" onclick="showReportTab('savings')">ğŸ¦ Savings Overview</button>
      </div>
      <div id="reportTabBalance" class="report-tab-content">
        <div id="reportResult"></div>
      </div>
      <div id="reportTabSavings" class="report-tab-content" style="display:none;">
        <div id="savingsReportResult"></div>
      </div>
    </section>
    <!-- Balances -->
    <section id="balances" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Balances</h2>
        <button onclick="showTutorial('balances')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:35px;height:35px;cursor:pointer;font-size:1.2em;box-shadow:0 2px 8px rgba(102,126,234,0.3);" title="Help">?</button>
      </div>
      <form id="balanceForm">
        <select name="currency" id="balanceCurrency" required>
          <!-- options will be filled dynamically -->
        </select>
        <input name="amount" placeholder="Amount" required>
        <button type="submit" class="button">Save Balance</button>
      </form>
      <div id="balanceResult"></div>
      <div id="actualBalances"></div>
      <div id="broughtForward"></div>
    </section>
    <!-- Profile -->
    <div id="profile" style="display:none;">
      <img id="profilePic" src="" alt="Profile" style="width:40px;height:40px;border-radius:50%;">
      <span id="profileName"></span>
      <button onclick="logout()" class="button">Logout</button>
    </div>
    
    <!-- Currency FAB -->
    <div id="currencyFabContainer">
      <button id="currencyFabBtn" class="currency-fab-btn"></button>
      <div id="currencyFabMenu" class="currency-fab-menu"></div>
    </div>
  </div>
</div>

<!-- Tutorial Modal -->
<div id="tutorialModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div style="background:white;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:600px;width:90%;max-height:80vh;overflow:auto;position:relative;">
    <div style="position:sticky;top:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:1.5em;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
      <h3 id="tutorialTitle" style="margin:0;font-size:1.5em;">Tutorial</h3>
      <button onclick="closeTutorial()" style="background:none;border:none;color:white;font-size:2em;cursor:pointer;line-height:0.8;">&times;</button>
    </div>
    <div id="tutorialContent" style="padding:2em;line-height:1.8;color:#333;">
      <!-- Content will be populated dynamically -->
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;overflow-y:auto;">
  <div style="background:white;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:450px;width:90%;position:relative;margin:2em auto;">
    <div style="position:sticky;top:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:1.5em;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;font-size:1.5em;">ğŸ”‘ Sign In</h3>
      <button onclick="closeAuthModal()" style="background:none;border:none;color:white;font-size:2em;cursor:pointer;line-height:0.8;">&times;</button>
    </div>
    <div style="padding:2em;">
      <form id="loginFormModal">
        <input name="username" placeholder="Username" required style="width:100%;padding:0.8em;margin-bottom:1em;border:1px solid #ddd;border-radius:8px;font-size:1em;box-sizing:border-box;">
        <input name="pin" type="password" placeholder="PIN" required style="width:100%;padding:0.8em;margin-bottom:1em;border:1px solid #ddd;border-radius:8px;font-size:1em;box-sizing:border-box;">
        <div style="margin-bottom:1em;width:100%;overflow:hidden;">
          <div class="cf-turnstile" data-sitekey="0x4AAAAAACCnWpf6Bemxz8VJ" data-callback="onTurnstileSuccess" data-error-callback="onTurnstileError" data-action="login" data-theme="light" data-size="normal" style="max-width:100%;"></div>
        </div>
        <button type="submit" class="button" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);border:none;padding:1em;font-size:1.1em;color:white;border-radius:8px;cursor:pointer;">Login</button>
      </form>
      <div id="loginResultModal" style="margin-top:1em;"></div>
      
      <!-- Footer Branding -->
      <div style="text-align:center;padding:1em 0 0;margin-top:1.5em;border-top:1px solid #eee;color:#999;font-size:0.75em;">
        <span>Developed by <strong style="color:#667eea;">Fadee Attieh</strong></span>
        <span style="margin:0 0.5em;">|</span>
        <span>Powered by <strong style="color:#667eea;">ATTmoc</strong></span>
      </div>
    </div>
  </div>
</div>

<!-- Register Modal -->
<div id="registerModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;overflow-y:auto;">
  <div style="background:white;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:600px;width:90%;position:relative;margin:2em auto;">
    <div style="position:sticky;top:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:1.5em;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;font-size:1.5em;">ğŸ“ Sign Up</h3>
      <button onclick="closeAuthModal()" style="background:none;border:none;color:white;font-size:2em;cursor:pointer;line-height:0.8;">&times;</button>
    </div>
    <div style="padding:2em;">
      <form id="registerFormModal">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1em;margin-bottom:1em;">
          <input name="username" placeholder="Username" required style="padding:0.8em;border:1px solid #ddd;border-radius:8px;font-size:1em;">
          <input name="email" type="email" placeholder="Email" required style="padding:0.8em;border:1px solid #ddd;border-radius:8px;font-size:1em;">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1em;margin-bottom:1em;">
          <input name="pin" type="password" placeholder="PIN" required style="padding:0.8em;border:1px solid #ddd;border-radius:8px;font-size:1em;">
          <input name="confirmPin" type="password" placeholder="Confirm PIN" required style="padding:0.8em;border:1px solid #ddd;border-radius:8px;font-size:1em;">
        </div>
        <div style="margin-bottom:1em;width:100%;overflow:hidden;">
          <div class="cf-turnstile" data-sitekey="0x4AAAAAACCnWpf6Bemxz8VJ" data-callback="onTurnstileSuccess" data-error-callback="onTurnstileError" data-action="register" data-theme="light" data-size="normal" style="max-width:100%;"></div>
        </div>
        <button type="submit" class="button" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);border:none;padding:1em;font-size:1.1em;color:white;border-radius:8px;cursor:pointer;">Register</button>
      </form>
      <div id="registerResultModal" style="margin-top:1em;"></div>
      <div id="verificationSectionModal" style="display:none;margin-top:2em;padding-top:2em;border-top:1px solid #ddd;">
        <h4>Email Verification</h4>
        <form id="verifyEmailFormModal">
          <input name="email" type="email" placeholder="Email" required style="width:100%;padding:0.8em;margin-bottom:1em;border:1px solid #ddd;border-radius:8px;font-size:1em;">
          <input name="code" placeholder="Verification Code" required style="width:100%;padding:0.8em;margin-bottom:1em;border:1px solid #ddd;border-radius:8px;font-size:1em;">
          <button type="submit" class="button" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);border:none;padding:1em;font-size:1.1em;color:white;border-radius:8px;cursor:pointer;">Verify</button>
        </form>
        <div id="verifyResultModal" style="margin-top:1em;"></div>
        <button type="button" id="resendCodeBtnModal" style="margin-top:1em;background:#f0f0f0;border:1px solid #ddd;padding:0.8em;width:100%;border-radius:8px;cursor:pointer;">Resend Code</button>
        <div id="resendResultModal" style="margin-top:0.5em;"></div>
      </div>
      
      <!-- Footer Branding -->
      <div style="text-align:center;padding:1em 0 0;margin-top:1.5em;border-top:1px solid #eee;color:#999;font-size:0.75em;">
        <span>Developed by <strong style="color:#667eea;">Fadee Attieh</strong></span>
        <span style="margin:0 0.5em;">|</span>
        <span>Powered by <strong style="color:#667eea;">ATTmoc</strong></span>
      </div>
    </div>
  </div>
</div>

  <script>
    const THEME_KEY = 'appTheme';
    
    // Currency constants - must be defined before any functions use them
    const CURRENCY_KEY = 'appCurrencies';
    const MAX_CURRENCIES = 2;
    
    const SUPPORTED_CURRENCIES = [
      { code: 'USD', label: 'US Dollar', icon: 'ğŸ‡ºğŸ‡¸' },
      { code: 'LBP', label: 'Lebanese Lira', icon: 'ğŸ‡±ğŸ‡§' },
      { code: 'EUR', label: 'Euro', icon: 'ğŸ‡ªğŸ‡º' },
      { code: 'GBP', label: 'British Pound', icon: 'ğŸ‡¬ğŸ‡§' },
      { code: 'CAD', label: 'Canadian Dollar', icon: 'ğŸ‡¨ğŸ‡¦' },
      { code: 'JPY', label: 'Japanese Yen', icon: 'ğŸ‡¯ğŸ‡µ' },
      { code: 'TRY', label: 'Turkish Lira', icon: 'ğŸ‡¹ğŸ‡·' }
    ];
    
    const CURRENCY_BILL_IMAGES = {
      USD: "img/currency_bills/usd.png",
      LBP: "img/currency_bills/lbp.png",
      EUR: "img/currency_bills/eur.png",
      GBP: "img/currency_bills/gbp.png",
      CAD: "img/currency_bills/cad.png",
      JPY: "img/currency_bills/jpy.png",
      TRY: "img/currency_bills/try.png"
    };
    
// Add this near the top of your <script> in index.html
// Fetch CSRF token on page load
async function fetchCsrfToken() {
  try {
    const response = await fetch('/csrf-token');
    const data = await response.json();
    // Store in a variable or cookie for later use
    if (data.csrfToken) {
      document.cookie = `XSRF-TOKEN=${data.csrfToken}; path=/; SameSite=Strict`;
    }
  } catch (err) {
    console.error('Failed to fetch CSRF token:', err);
  }
}

  async function authFetch(url, options = {}) {
  const token = localStorage.getItem('jwtToken');
  options.headers = options.headers || {};
  options.headers['Authorization'] = `Bearer ${token}`;
  // If CSRF token is needed for POST/PUT, add it here:
  const csrfToken = getCookie('XSRF-TOKEN');
  if (csrfToken && (options.method === 'POST' || options.method === 'PUT' || options.method === 'DELETE')) {
    options.headers['X-CSRF-Token'] = csrfToken;
  }
  
  const response = await fetch(url, options);
  
  // Only check for token expiration if user was logged in and it's not the initial load check
  if (response.status === 401 && token && options.showExpiredAlert !== false) {
    const data = await response.json();
    if (data.error && data.error.includes('Invalid token')) {
      alert('Your session has expired. Please log in again.');
      logout();
      return response;
    }
  }
  
  return response;
}

// Helper to get cookie value by name
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
    
  // --- Place this at the top of your main script block ---
  function forceLogoutOnError() {
   // localStorage.removeItem('user');
    //hideProfile();
    //disableApp();
    //showSection('login');
  logout();
  }



function applyAppTheme(theme) {
  document.body.classList.remove(
    'theme-fancy', 'theme-modern', 'theme-classic', 'theme-business',
    'theme-dark', 'theme-light', 'theme-childish', 'theme-christmas'
  );
  document.body.classList.add('theme-' + theme.replace('-table', ''));
}


document.getElementById('balanceForm').onsubmit = async function(e) {
  e.preventDefault();
  const form = this;
  const currency = form.currency.value;
  const amount = parseFloat(form.amount.value);
  const resultDiv = document.getElementById('balanceResult');
  resultDiv.innerText = '';
  try {
    const res = await authFetch('/balances', { // Changed Authorization to authFetch
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ currency, amount })
    });
    const data = await res.json();
    if (res.status === 201) {
      resultDiv.innerHTML = `<span style="color:green;">Initial balance for <b>${currency}</b> set to ${amount}.</span>`;
      form.querySelector('button[type="submit"]').disabled = true;
      form.querySelector('input[name="amount"]').disabled = true;
      showBalances();
    } else if (data && data.error) {
      resultDiv.innerHTML = `<span style="color:red;">${data.error}</span>`;
    } else {
      resultDiv.innerHTML = `<span style="color:red;">Could not save balance.</span>`;
    }
  } catch (err) {
    resultDiv.innerHTML = `<span style="color:red;">Error saving balance.</span>`;
  }
};

document.getElementById('themeSelect').addEventListener('change', function() {
  const theme = this.value;
  localStorage.setItem(THEME_KEY, theme);
  applyAppTheme(theme);
});

// Tutorial System
const tutorialContent = {
  reports: {
    title: 'ğŸ“Š Monthly Reports',
    content: `
      <p><strong>Purpose:</strong> View comprehensive financial summaries for any month.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li><strong>Balance Overview:</strong> See total income, expenses, transfers, and money on hand</li>
        <li><strong>Savings Overview:</strong> Track your savings growth over time</li>
        <li><strong>Currency Selection:</strong> View reports in different currencies</li>
      </ul>
      <p><strong>How to use:</strong> Select month, year, and currency, then click "Get Report".</p>
    `
  },
  income: {
    title: 'ğŸ’µ Income Management',
    content: `
      <p><strong>Purpose:</strong> Track all money coming in.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li><strong>Add Income:</strong> Record salary, freelance work, gifts, etc.</li>
        <li><strong>Grouped by Type:</strong> Entries are organized by income type (Salary, Freelance, etc.)</li>
        <li><strong>Record Count:</strong> See how many entries exist for each type</li>
        <li><strong>Currency Support:</strong> Record income in different currencies</li>
      </ul>
      <p><strong>Tip:</strong> Click on a type group to expand and view all entries.</p>
    `
  },
  expenses: {
    title: 'ğŸ’¸ Expense Tracking',
    content: `
      <p><strong>Purpose:</strong> Track all money going out.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li><strong>Add Expenses:</strong> Record bills, purchases, subscriptions, etc.</li>
        <li><strong>Grouped by Category:</strong> Entries organized by expense type (Food, Rent, Transport, etc.)</li>
        <li><strong>Record Count:</strong> See how many expenses in each category</li>
        <li><strong>Date & Notes:</strong> Track when and why you spent money</li>
      </ul>
      <p><strong>Tip:</strong> Regular expense tracking helps identify spending patterns.</p>
    `
  },
  types: {
    title: 'ğŸ·ï¸ Income & Expense Types',
    content: `
      <p><strong>Purpose:</strong> Create and manage categories for income and expenses.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li><strong>Income Types:</strong> Salary, Freelance, Gifts, Investment Returns, etc.</li>
        <li><strong>Expense Types:</strong> Food, Rent, Transport, Entertainment, Bills, etc.</li>
        <li><strong>Grouped Display:</strong> See income types (ğŸŸ¢) and expense types (ğŸ”´) separately</li>
        <li><strong>Record Count:</strong> Number of types in each category</li>
        <li><strong>Excel Import:</strong> Bulk import types from spreadsheet</li>
      </ul>
      <p><strong>Tip:</strong> Create types before adding income/expenses for better organization.</p>
    `
  },
  savings: {
    title: 'ğŸ¦ Savings Management',
    content: `
      <p><strong>Purpose:</strong> Track money set aside for future use.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li><strong>Add Savings:</strong> Record manual savings contributions</li>
        <li><strong>Transfer Integration:</strong> Savings from transfers are automatically tracked</li>
        <li><strong>Balance View:</strong> See current savings and money on hand</li>
        <li><strong>Historical Tracking:</strong> View savings growth over time</li>
      </ul>
      <p><strong>Tip:</strong> Use Transfers section to move money between accounts.</p>
    `
  },
  transfers: {
    title: 'ğŸ”„ Transfer Between Accounts',
    content: `
      <p><strong>Purpose:</strong> Move money between Money on Hand and Savings.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li><strong>Money on Hand â†’ Savings:</strong> Transfer money to savings account</li>
        <li><strong>Savings â†’ Money on Hand:</strong> Withdraw from savings for use</li>
        <li><strong>Grouped Display:</strong> See transfers organized by direction with counts</li>
        <li><strong>Automatic Updates:</strong> Balances update instantly after transfers</li>
      </ul>
      <p><strong>Note:</strong> Transfers affect both balances and are tracked in savings history.</p>
    `
  },
  balances: {
    title: 'ğŸ’° Balance Management',
    content: `
      <p><strong>Purpose:</strong> Set and track starting balances for each month.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li><strong>Initial Balance:</strong> Set starting money on hand at month beginning</li>
        <li><strong>Multi-Currency:</strong> Track balances in different currencies</li>
        <li><strong>Brought Forward:</strong> Balances carry over from previous month</li>
        <li><strong>Calculated Balance:</strong> See current balance based on income/expenses/transfers</li>
      </ul>
      <p><strong>Tip:</strong> Set balances at the start of each month for accurate tracking.</p>
    `
  },
  settings: {
    title: 'âš™ï¸ Settings & Management',
    content: `
      <p><strong>Purpose:</strong> Configure app settings and manage data.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li><strong>Close Month:</strong> Finalize current month and start new cycle</li>
        <li><strong>Backup Database:</strong> Export all data as JSON file</li>
        <li><strong>Restore Database:</strong> Import data from backup file</li>
        <li><strong>Reset Database:</strong> Delete all data (use with caution!)</li>
        <li><strong>Currency Picker:</strong> Select up to 2 active currencies</li>
        <li><strong>Theme Selection:</strong> Choose your preferred table style</li>
      </ul>
      <p><strong>Tip:</strong> Create regular backups to protect your financial data.</p>
    `
  }
};

function showTutorial(section) {
  const tutorial = tutorialContent[section];
  if (!tutorial) return;
  
  document.getElementById('tutorialTitle').textContent = tutorial.title;
  document.getElementById('tutorialContent').innerHTML = tutorial.content;
  document.getElementById('tutorialModal').style.display = 'flex';
}

function closeTutorial() {
  document.getElementById('tutorialModal').style.display = 'none';
}

// Close tutorial when clicking outside the content
document.getElementById('tutorialModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeTutorial();
  }
});

// Auth Modal System
function openAuthModal(type) {
  if (type === 'login') {
    document.getElementById('loginModal').style.display = 'flex';
  } else if (type === 'register') {
    document.getElementById('registerModal').style.display = 'flex';
  }
}

function closeAuthModal() {
  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('registerModal').style.display = 'none';
}

// Close auth modals when clicking outside
document.getElementById('loginModal').addEventListener('click', function(e) {
  if (e.target === this) closeAuthModal();
});
document.getElementById('registerModal').addEventListener('click', function(e) {
  if (e.target === this) closeAuthModal();
});

// Show app after successful login
function showApp() {
  document.getElementById('initialScreen').style.display = 'none';
  document.getElementById('sidebar').style.display = 'flex';
  document.querySelector('.container').style.display = 'block';
  document.body.classList.add('logged-in');
  closeAuthModal();
}

// Show initial screen on logout
function hideApp() {
  document.getElementById('initialScreen').style.display = 'flex';
  document.getElementById('sidebar').style.display = 'none';
  document.querySelector('.container').style.display = 'none';
}

// Modal Form Handlers
document.getElementById('loginFormModal').onsubmit = async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this));
  const turnstileToken = window.turnstileToken;
  
  if (!turnstileToken) {
    document.getElementById('loginResultModal').innerHTML = '<span style="color:red;">Please complete the security verification.</span>';
    return;
  }
  
  data.turnstileToken = turnstileToken;
  const res = await authFetch('/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  const result = await res.json();
  if (res.ok && result.token) {
    localStorage.setItem('jwtToken', result.token);
    localStorage.setItem('user', JSON.stringify({ username: data.username }));
    closeAuthModal();
    showApp();
    
    // Load Tawk.to chat widget after login
    if (typeof Tawk_API === 'undefined') {
      var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
      var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
      s1.async = true;
      s1.src = 'https://embed.tawk.to/6932679a1fe45f1982d312ef/1jbme9d75';
      s1.charset = 'UTF-8';
      s1.setAttribute('crossorigin', '*');
      s0.parentNode.insertBefore(s1, s0);
    } else if (Tawk_API.showWidget) {
      Tawk_API.showWidget();
    }
    
    await onLoginSuccess({ username: data.username });
    if (localStorage.getItem('jwtToken')) {
      checkMonthClose();
    }
    
    // Show onboarding tour for first-time users after successful login
    const tourCompleted = localStorage.getItem('tourCompleted') === 'true';
    if (!tourCompleted) {
      setTimeout(() => {
        if (confirm('Would you like a quick tour of the new features?')) {
          startOnboardingTour();
        } else {
          localStorage.setItem('tourCompleted', 'true');
        }
      }, 2000);
    }
  } else if (res.status === 403 && result.error && result.error.includes('Email not verified')) {
    document.getElementById('loginResultModal').innerHTML = `<span style="color:orange;">${result.error}</span>`;
    closeAuthModal();
    openAuthModal('register');
    document.getElementById('verificationSectionModal').style.display = 'block';
    document.querySelector('#verifyEmailFormModal [name="email"]').value = data.username.includes('@') ? data.username : '';
  } else {
    document.getElementById('loginResultModal').innerHTML = `<span style="color:red;">${result.error || result.message || 'Login failed'}</span>`;
  }
};

document.getElementById('registerFormModal').onsubmit = async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this));
  
  // Check if PINs match
  if (data.pin !== data.confirmPin) {
    document.getElementById('registerResultModal').innerHTML = '<span style="color:red;">PINs do not match!</span>';
    return;
  }
  
  // Get Turnstile token
  const turnstileToken = document.querySelector('#registerFormModal .cf-turnstile [name="cf-turnstile-response"]')?.value;
  if (!turnstileToken) {
    document.getElementById('registerResultModal').innerHTML = '<span style="color:red;">Please complete the verification</span>';
    return;
  }
  data.turnstileToken = turnstileToken;
  
  delete data.confirmPin; // Remove confirmPin before sending
  
  try {
    // Ensure CSRF token is available
    let csrfToken = getCookie('XSRF-TOKEN');
    if (!csrfToken) {
      console.log('CSRF token not found, fetching...');
      await fetchCsrfToken();
      csrfToken = getCookie('XSRF-TOKEN');
    }
    
    console.log('Submitting registration with CSRF token:', csrfToken ? 'present' : 'missing');
    
    // Use fetch directly for registration (no auth token needed)
    const res = await fetch('/auth/register', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken || ''
      },
      body: JSON.stringify(data)
    });
    
    console.log('Registration response status:', res.status);
    const result = await res.json();
    console.log('Registration response:', result);
    
    if (res.ok) {
      let message = '<span style="color:green;">Registration successful!</span><br>';
      
      // Check if verification code is in response (email not configured)
      if (result.verificationCode) {
        message += '<br><strong style="color:orange;">âš ï¸ Email service not configured</strong><br>';
        message += `Your verification code is: <strong style="font-size:1.5em;color:#667eea;">${result.verificationCode}</strong><br>`;
        message += '<small>Please enter this code below to verify your account.</small>';
      } else if (result.message) {
        message += `<br>${result.message}`;
        message += '<br><small style="color:#666;">ğŸ“§ Check your email inbox (and spam/junk folder)</small>';
      } else {
        message += '<br>Please check your email for verification code.';
        message += '<br><small style="color:#666;">ğŸ“§ Don\'t forget to check your spam/junk folder</small>';
      }
      
      document.getElementById('registerResultModal').innerHTML = message;
      document.getElementById('verificationSectionModal').style.display = 'block';
      document.querySelector('#verifyEmailFormModal [name="email"]').value = data.email;
      localStorage.setItem('pendingVerificationEmail', data.email);
    } else {
      document.getElementById('registerResultModal').innerHTML = `<span style="color:red;">${result.error || 'Registration failed'}</span>`;
    }
  } catch (err) {
    console.error('Registration error:', err);
    document.getElementById('registerResultModal').innerHTML = `<span style="color:red;">Registration failed: ${err.message}</span>`;
  }
};

document.getElementById('verifyEmailFormModal').onsubmit = async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this));
  
  try {
    // Ensure CSRF token is available
    let csrfToken = getCookie('XSRF-TOKEN');
    if (!csrfToken) {
      console.log('CSRF token not found, fetching...');
      await fetchCsrfToken();
      csrfToken = getCookie('XSRF-TOKEN');
    }
    
    const res = await fetch('/auth/verify-email', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken || ''
      },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    console.log('Verification response:', result);
    
    if (res.ok) {
      document.getElementById('verifyResultModal').innerHTML = '<span style="color:green;">Email verified! You can now log in.</span>';
      localStorage.removeItem('pendingVerificationEmail');
      setTimeout(() => {
        closeAuthModal();
        openAuthModal('login');
      }, 1500);
    } else {
      document.getElementById('verifyResultModal').innerHTML = `<span style="color:red;">${result.error || 'Verification failed'}</span>`;
    }
  } catch (err) {
    console.error('Verification error:', err);
    document.getElementById('verifyResultModal').innerHTML = `<span style="color:red;">Verification failed: ${err.message}</span>`;
  }
};

document.getElementById('resendCodeBtnModal').onclick = async function() {
  const email = document.querySelector('#verifyEmailFormModal [name="email"]').value;
  
  try {
    // Ensure CSRF token is available
    let csrfToken = getCookie('XSRF-TOKEN');
    if (!csrfToken) {
      console.log('CSRF token not found, fetching...');
      await fetchCsrfToken();
      csrfToken = getCookie('XSRF-TOKEN');
    }
    
    const res = await fetch('/auth/resend-verification', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken || ''
      },
      body: JSON.stringify({ email })
    });
    
    const result = await res.json();
    console.log('Resend verification response:', result);
    
    let message = result.message || result.error || 'Failed to resend code';
    
    // If verification code is in response (email not configured), show it prominently
    if (result.verificationCode) {
      message = `<strong style="color:orange;">âš ï¸ Email service not configured</strong><br>`;
      message += `Your new verification code is: <strong style="font-size:1.3em;color:#667eea;">${result.verificationCode}</strong>`;
    }
    
    document.getElementById('resendResultModal').innerHTML = message;
  } catch (err) {
    console.error('Resend verification error:', err);
    document.getElementById('resendResultModal').innerHTML = `<span style="color:red;">Failed to resend: ${err.message}</span>`;
  }
};

// Fetch and display app version
async function fetchAppVersion() {
  try {
    const res = await fetch('/api/version');
    if (res.ok) {
      const data = await res.json();
      document.getElementById('appVersionBadge').textContent = `v${data.version}`;
      console.log(`App version: ${data.version} | Build: ${data.buildDate}`);
    }
  } catch (err) {
    console.log('Could not fetch version');
  }
}

window.addEventListener('DOMContentLoaded', async () => {
  // Fetch app version
  fetchAppVersion();
  
  // Fetch CSRF token first
  fetchCsrfToken();
  
  // Check if user is already logged in
  const token = localStorage.getItem('jwtToken');
  if (token) {
    showApp();
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    // Try to load user data - if token is expired, this will fail silently
    try {
      await onLoginSuccess(user, true); // Pass true for isInitialLoad
    } catch (err) {
      // Token is invalid/expired - clear it and show login
      console.log('Session expired, clearing token');
      localStorage.removeItem('jwtToken');
      localStorage.removeItem('user');
      hideApp();
    }
  } else {
    hideApp();
  }
  
  // Theme setup
  const theme = localStorage.getItem('appTheme') || 'fancy-table';
  document.getElementById('themeSelect').value = theme;
  applyAppTheme(theme);

  // Currency FAB
  renderCurrencyFab();
  setCurrency(getCurrency());
  updateReportCurrencyDropdown();

  // Transfer dropdown sync
  const fromSelect = document.getElementById('transferFrom');
  const toSelect = document.getElementById('transferTo');
  function syncTransferDropdowns() {
    if (fromSelect.value === 'money_on_hand') {
      toSelect.value = 'savings';
    } else {
      toSelect.value = 'money_on_hand';
    }
  }
  fromSelect.addEventListener('change', syncTransferDropdowns);
  toSelect.addEventListener('change', () => {
    if (toSelect.value === 'money_on_hand') {
      fromSelect.value = 'savings';
    } else {
      fromSelect.value = 'money_on_hand';
    }
  });
  syncTransferDropdowns();

  // Month close check (only after login)
  /*if (localStorage.getItem('jwtToken')) {
    checkMonthClose();
  }*/
});

// --- Currency Switch Logic ---

// Render selected currencies as buttons
/*function renderCurrencySwitch() {
  const selected = getSelectedCurrencies();
  const container = document.querySelector('.currency-switch.menu-currency-switch');
  container.innerHTML = '';
  selected.forEach(code => {
    const currency = SUPPORTED_CURRENCIES.find(c => c.code === code);
    if (!currency) return;
    const btn = document.createElement('button');
    btn.className = 'currency-btn' + (getCurrency() === code ? ' active' : '');
    btn.type = 'button';
    btn.innerHTML = `<span style="font-size:1.2em;">${currency.icon}</span> ${currency.code}`;
    btn.disabled = getCurrency() === code;
    btn.onclick = () => setCurrency(code);
    container.appendChild(btn);
  });
}*/
function renderCurrencyFab() {
  const selected = getSelectedCurrencies();
  const fabBtn = document.getElementById('currencyFabBtn');
  const fabMenu = document.getElementById('currencyFabMenu');
  if (!fabBtn || !fabMenu) return;

  // Show the current currency flag/icon on the FAB
  const current = getCurrency();
  const currency = SUPPORTED_CURRENCIES.find(c => c.code === current);
  const billImg = CURRENCY_BILL_IMAGES[current];
  fabBtn.innerHTML = billImg
  ? `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%;">
        <img src="${billImg}" alt="${current} bill" style="width:28px;height:18px;object-fit:cover;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.13);margin-bottom:1px;">
        <span style="font-size:0.78em;font-weight:bold;color:#333;letter-spacing:1px;line-height:1;">${current}</span>
     </div>`
  : (currency ? `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%;">
        <span style="font-size:1.3em;">${currency.icon}</span>
        <span style="font-size:0.78em;font-weight:bold;color:#333;letter-spacing:1px;line-height:1;">${current}</span>
     </div>` : 'ğŸ’±');

  // Build the menu with all selected currencies
  fabMenu.innerHTML = '';
  selected.forEach(code => {
    const cur = SUPPORTED_CURRENCIES.find(c => c.code === code);
    if (!cur) return;
    const btn = document.createElement('button');
    btn.className = 'currency-menu-btn' + (current === code ? ' active' : '');
    btn.type = 'button';
    const menuImg = CURRENCY_BILL_IMAGES[code];
    btn.innerHTML = menuImg
  ? `<div class="currency-fab-menu-imgwrap">
        <img src="${menuImg}" alt="${code} bill" class="currency-fab-menu-img">
        <span class="currency-fab-menu-code">${code}</span>
     </div>`
  : `<div class="currency-fab-menu-imgwrap">
        <span style="font-size:2em;">${cur.icon}</span>
        <span class="currency-fab-menu-code">${code}</span>
     </div>`;
    btn.onclick = () => {
      setCurrency(code);
      fabMenu.style.display = 'none';
    };
    fabMenu.appendChild(btn);
  });
}

// Toggle menu on FAB click
document.addEventListener('DOMContentLoaded', () => {
  const fabBtn = document.getElementById('currencyFabBtn');
  const fabMenu = document.getElementById('currencyFabMenu');
  if (fabBtn && fabMenu) {
    fabBtn.onclick = (e) => {
      e.stopPropagation();
      fabMenu.style.display = fabMenu.style.display === 'none' ? 'block' : 'none';
    };
    // Hide menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!fabMenu.contains(e.target) && e.target !== fabBtn) {
        fabMenu.style.display = 'none';
      }
    });
  }
  renderCurrencyFab();
});

// Download Types Excel Template
function downloadTypesTemplate() {
  const templateData = [
    ['name', 'category', 'description'],
    ['Salary', 'income', 'Monthly salary payment'],
    ['Freelance', 'income', 'Freelance project income'],
    ['Groceries', 'expense', 'Food and groceries'],
    ['Rent', 'expense', 'Monthly rent payment'],
    ['Utilities', 'expense', 'Electric, water, internet bills']
  ];
  
  let csvContent = templateData.map(row => row.join(',')).join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', 'types_template.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Import Types from Excel/CSV
async function importTypesFromExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const text = e.target.result;
      const lines = text.split('\n').filter(line => line.trim());
      
      if (lines.length < 2) {
        alert('File is empty or invalid.');
        return;
      }
      
      // Parse header
      const header = lines[0].split(',').map(h => h.trim().toLowerCase());
      const nameIndex = header.indexOf('name');
      const categoryIndex = header.indexOf('category');
      const descriptionIndex = header.indexOf('description');
      
      if (nameIndex === -1 || categoryIndex === -1) {
        alert('Invalid template. Required columns: name, category');
        return;
      }
      
      const typesToImport = [];
      const errors = [];
      
      // Parse data rows (skip header)
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const name = values[nameIndex];
        const category = values[categoryIndex]?.toLowerCase();
        const description = descriptionIndex !== -1 ? values[descriptionIndex] : '';
        
        // Validate
        if (!name) {
          errors.push(`Row ${i + 1}: Name is required`);
          continue;
        }
        
        if (!category || !['income', 'expense'].includes(category)) {
          errors.push(`Row ${i + 1}: Category must be 'income' or 'expense'`);
          continue;
        }
        
        typesToImport.push({ name, category, description });
      }
      
      if (errors.length > 0) {
        alert('Import errors:\n' + errors.join('\n'));
      }
      
      if (typesToImport.length === 0) {
        alert('No valid types to import.');
        return;
      }
      
      // Import types to backend
      const successCount = await bulkCreateTypes(typesToImport);
      document.getElementById('typeResult').innerHTML = `<span style="color:green;">âœ“ Successfully imported ${successCount} types</span>`;
      fetchTypes();
      
    } catch (err) {
      alert('Error parsing file: ' + err.message);
    }
  };
  
  reader.readAsText(file);
  event.target.value = ''; // Reset input
}

// Bulk create types
async function bulkCreateTypes(types) {
  let successCount = 0;
  for (const type of types) {
    try {
      const res = await authFetch('/types', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(type)
      });
      if (res.ok) successCount++;
    } catch (err) {
      console.error('Failed to create type:', type.name, err);
    }
  }
  return successCount;
}

// Save and get selected currencies
function getSelectedCurrencies() {
  return JSON.parse(localStorage.getItem(CURRENCY_KEY) || '["USD","LBP"]');
}
function setSelectedCurrencies(arr) {
  localStorage.setItem(CURRENCY_KEY, JSON.stringify(arr));
  // If current currency is not in arr, switch to the first
  if (!arr.includes(getCurrency())) setCurrency(arr[0]);
  renderCurrencyFab()
}

// Set/get current currency
function setCurrency(code) {
  localStorage.setItem('appCurrency', code);
  renderCurrencyFab();
  updateCurrencyInSections(code);
  updateReportCurrencyDropdown();
  updateBalanceCurrencyDropdown();
  updateIncomeCurrencyDropdown();
  updateExpenseCurrencyDropdown();
  updateSavingsCurrencyDropdown();
  updateTransferCurrencyDropdown();
  if (typeof fetchIncome === 'function') fetchIncome();
  if (typeof fetchExpenses === 'function') fetchExpenses();
}
function getCurrency() {
  return localStorage.getItem('appCurrency') || getSelectedCurrencies()[0];
}

// Currency picker modal logic
/*
document.getElementById('chooseCurrenciesBtn').onclick = () => {
  const modal = document.getElementById('currencyPickerModal');
  const optionsDiv = document.getElementById('currencyOptions');
  const selected = getSelectedCurrencies();
  optionsDiv.innerHTML = '';
  SUPPORTED_CURRENCIES.forEach(cur => {
    const id = 'cur_' + cur.code;
    optionsDiv.innerHTML += `
      <label>
        <input type="checkbox" id="${id}" value="${cur.code}" ${selected.includes(cur.code) ? 'checked' : ''}>
        <span style="font-size:1.2em;">${cur.icon}</span> ${cur.label} (${cur.code})
      </label>
    `;
  });
  modal.style.display = 'flex';
};
*/
document.getElementById('closeCurrencyPicker').onclick = () => {
  document.getElementById('currencyPickerModal').style.display = 'none';
};
document.getElementById('saveCurrenciesBtn').onclick = async () => {
  console.log('Save currencies button clicked');
  const checked = Array.from(document.querySelectorAll('.currency-picker-checkbox:checked')).map(cb => cb.value);
  console.log('Checked currencies:', checked);
  
  if (checked.length === 0 || checked.length > MAX_CURRENCIES) {
    alert('Please select 1 or 2 currencies.');
    return;
  }
  
  // Save to localStorage first
  setSelectedCurrencies(checked);
  console.log('Saved to localStorage:', checked);
  
  // Close modal
  document.getElementById('currencyPickerModal').style.display = 'none';

  // Send to backend to save in UserCurrency table
  try {
    console.log('Sending to backend:', { currencies: checked });
    const response = await authFetch('/user/currencies', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ currencies: checked })
    });
    
    console.log('Backend response status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('âœ… Currencies saved to database successfully:', result);
      alert('âœ… Currencies saved successfully!');
    } else {
      const error = await response.json();
      console.error('âŒ Failed to save currencies:', error);
      alert('âš ï¸ Failed to save currencies: ' + (error.error || 'Unknown error'));
    }
  } catch (err) {
    console.error('âŒ Error saving currencies:', err);
    alert('âš ï¸ Error saving currencies: ' + err.message);
  }

  // Continue app flow
  let lastSection = localStorage.getItem('lastSection') || 'balances';
  showSection(lastSection);
  resetIdleTimer();
};

    // --- Currency Switch Logic ---
//const CURRENCY_KEY = 'appCurrency';

//function setCurrency(currency) {
  //localStorage.setItem(CURRENCY_KEY, currency);
  //document.getElementById('currencyUSD').classList.toggle('active', currency === 'USD');
  //document.getElementById('currencyLBP').classList.toggle('active', currency === 'LBP');
  //document.getElementById('currencyUSD').disabled = currency === 'USD';
  //document.getElementById('currencyLBP').disabled = currency === 'LBP';
  // Update all sections to reflect the selected currency
//  updateCurrencyInSections(currency);
//}

//function getCurrency() {
  //return localStorage.getItem(CURRENCY_KEY) || 'USD';
//}

//document.getElementById('currencyUSD').addEventListener('click', () => setCurrency('USD'));
//document.getElementById('currencyLBP').addEventListener('click', () => setCurrency('LBP'));



    // Update all sections to use the selected currency
function updateCurrencyInSections(currency) {
  // Set currency dropdowns if present
  ['incomeCurrency', 'expenseCurrency', 'savingsCurrency', 'transferCurrency', 'reportCurrency', 'balanceCurrency'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = currency;
  });
  // Update balances and brought forward in all sections
  showBalances();
  showSectionBalances('income', currency);
  showSectionBalances('expenses', currency);
  showSectionBalances('savings', currency);
  showSectionBalances('transfers', currency);
}

// Show balances (brought forward and actual)
async function showBalances() {
  // Only fetch if logged in
  if (!localStorage.getItem('jwtToken')) {
    // Optionally clear balances UI
    const actualBalances = document.getElementById('actualBalances');
    const broughtForward = document.getElementById('broughtForward');
    if (actualBalances) actualBalances.innerHTML = '';
    if (broughtForward) broughtForward.innerHTML = '';
    return;
  }
  try {
    const currency = getCurrency();
    const res = await authFetch('/balances', { credentials: 'include' });
    if (res.status === 401) {
      console.warn('Balances fetch returned 401 - token may be expired');
      forceLogoutOnError();
      return;
    }
    if (!res.ok) {
      console.error('Failed to fetch balances:', res.status, res.statusText);
      return;
    }
    let balances = await res.json();
    if (!Array.isArray(balances)) {
      document.getElementById('actualBalances').innerHTML = '<span style="color:red;">Could not load balances.</span>';
      return;
    }
    
    // Store balances globally for view switching
    window.balancesData = balances;
    
    // Find if the selected currency already has a balance
    const bal = balances.find(b => b.currency === currency) || { initialBalance: 0, moneyOnHand: 0 };

    // Render balances with view switcher
    const view = localStorage.getItem('balanceView') || 'cards';
    renderBalanceView(view);

    // Lock/unlock form as before
    const selected = getSelectedCurrencies();
    const hasAll = selected.every(cur => balances.some(b => b.currency === cur));
    const balanceForm = document.getElementById('balanceForm');
    const balanceResult = document.getElementById('balanceResult');
    // Disable the balance input if the selected currency already has a balance
    if (bal && bal.initialBalance > 0) {
      balanceResult.innerHTML = `<span style="color:green;">Initial balance for <b>${currency}</b> is set. You cannot change it.</span>`;
      if (balanceForm) balanceForm.querySelector('button[type="submit"]').disabled = true;
      if (balanceForm) balanceForm.querySelector('input[name="amount"]').disabled = true;
    } else {
      balanceResult.innerHTML = '';
      if (balanceForm) balanceForm.querySelector('button[type="submit"]').disabled = false;
      if (balanceForm) balanceForm.querySelector('input[name="amount"]').disabled = false;
    }

    // Show brought forward for selected currency
    const now = new Date();
    const params = new URLSearchParams({
      month: now.getMonth() + 1,
      year: now.getFullYear(),
      currency
    }).toString();
    const reportRes = await authFetch('/report/monthly?' + params, { credentials: 'include' }); // Updated authfetch to authFetch
    const report = await reportRes.json();
    document.getElementById('broughtForward').innerHTML =
      `<b>Brought Forward (month=${now.getMonth() + 1}, year=${now.getFullYear()}, currency=${currency}):</b> ${report.broughtForward}`;
  } catch (err) {
    forceLogoutOnError();
  }
}

function changeBalanceView(view) {
  localStorage.setItem('balanceView', view);
  renderBalanceView(view);
}

function renderBalanceView(view) {
  if (!window.balancesData || window.balancesData.length === 0) return;
  
  const balances = window.balancesData;
  
  // Calculate per-currency totals (don't mix currencies)
  const currencyTotals = {};
  balances.forEach(b => {
    if (!currencyTotals[b.currency]) {
      currencyTotals[b.currency] = { moneyOnHand: 0, savings: 0, total: 0 };
    }
    currencyTotals[b.currency].moneyOnHand += b.moneyOnHand;
    currencyTotals[b.currency].savings += b.savings;
    currencyTotals[b.currency].total += b.moneyOnHand + b.savings;
  });
  
  // Find largest balance by currency
  const largestBalance = balances.reduce((max, b) => 
    (b.moneyOnHand + b.savings) > (max.moneyOnHand + max.savings) ? b : max, 
    balances[0]
  );
  
  // Smart Insights Panel
  let html = `
    <div class="balance-insights-panel">
      <h3 style="margin:0 0 0.5em 0;font-size:1.4em;">ğŸ’¼ Portfolio Overview</h3>
      <div class="insights-grid">
  `;
  
  // Show per-currency totals
  const currencies = Object.keys(currencyTotals);
  currencies.forEach(currency => {
    const data = currencyTotals[currency];
    const savingsRate = data.total > 0 ? (data.savings / data.total * 100).toFixed(1) : 0;
    
    html += `
        <div class="insight-card">
          <div class="insight-icon">ğŸ’°</div>
          <div class="insight-label">${currency} Portfolio</div>
          <div class="insight-value">${data.total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          <div class="insight-subtext">
            ğŸ’µ ${data.moneyOnHand.toLocaleString(undefined, {minimumFractionDigits:0})} | 
            ğŸ¦ ${data.savings.toLocaleString(undefined, {minimumFractionDigits:0})} (${savingsRate}%)
          </div>
        </div>
    `;
  });
  
  // Add largest balance card
  if (largestBalance) {
    html += `
        <div class="insight-card">
          <div class="insight-icon">ğŸ†</div>
          <div class="insight-label">Largest Balance</div>
          <div class="insight-value">${largestBalance.currency}</div>
          <div class="insight-subtext">${(largestBalance.moneyOnHand + largestBalance.savings).toLocaleString(undefined, {minimumFractionDigits:2})}</div>
        </div>
    `;
  }
  
  html += `
      </div>
    </div>
  `;
  
  // View Switcher
  html += `
    <div class="data-view-switcher">
      <button class="data-view-btn ${view === 'cards' ? 'active' : ''}" onclick="changeBalanceView('cards')">ğŸƒ Cards</button>
      <button class="data-view-btn ${view === 'dashboard' ? 'active' : ''}" onclick="changeBalanceView('dashboard')">ğŸ“Š Dashboard</button>
      <button class="data-view-btn ${view === 'comparison' ? 'active' : ''}" onclick="changeBalanceView('comparison')">ğŸ“ˆ Comparison</button>
      <button class="data-view-btn ${view === 'table' ? 'active' : ''}" onclick="changeBalanceView('table')">ğŸ“‹ Table</button>
    </div>
  `;
  
  // Render selected view
  if (view === 'cards') {
    html += renderBalanceCards(balances);
  } else if (view === 'dashboard') {
    html += renderBalanceDashboard(balances, currencyTotals);
  } else if (view === 'comparison') {
    html += renderBalanceComparison(balances);
  } else if (view === 'table') {
    html += renderBalanceTable(balances);
  }
  
  document.getElementById('actualBalances').innerHTML = html;
}

function renderBalanceCards(balances) {
  let html = '<div class="currency-cards" style="margin-top:1.5em;">';
  
  balances.forEach(b => {
    const moneyOnHand = Number(b.moneyOnHand) || 0;
    const savings = Number(b.savings) || 0;
    const initialBalance = Number(b.initialBalance) || 0;
    const closingBalance = Number(b.closingBalance) || 0;
    const total = moneyOnHand + savings;
    const savingsPercent = total > 0 ? ((savings / total) * 100).toFixed(1) : 0;
    
    html += `
      <div class="balance-card">
        <div class="balance-card-header">
          <div class="balance-card-icon">ğŸ’³</div>
          <div class="balance-card-currency">${b.currency}</div>
        </div>
        <div class="balance-metrics">
          <div class="balance-metric balance-primary" title="Variable: b.moneyOnHand&#10;Formula: initialBalance + income - expenses + transfersIn - transfersOut">
            <div class="balance-metric-label">ğŸ’µ Money on Hand</div>
            <div class="balance-metric-value">${moneyOnHand.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="balance-metric" title="Variable: b.initialBalance&#10;Alias: initial_amount (DB)&#10;Description: Starting balance brought forward from previous month">
            <div class="balance-metric-label">Brought Forward</div>
            <div class="balance-metric-value">${initialBalance.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="balance-metric" title="Variable: b.closingBalance&#10;Alias: amount (DB)&#10;Description: Ending balance entered during month close">
            <div class="balance-metric-label">Closing Balance</div>
            <div class="balance-metric-value">${closingBalance.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="balance-metric" title="Variable: b.savings&#10;Description: Total savings amount in this currency">
            <div class="balance-metric-label">ğŸ¦ Savings</div>
            <div class="balance-metric-value">${savings.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="balance-metric" title="Variable: total&#10;Formula: moneyOnHand + savings">
            <div class="balance-metric-label">Total Assets</div>
            <div class="balance-metric-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
        </div>
        <div class="comparison-progress" style="margin-top:1em;" title="Variable: savingsPercent&#10;Formula: (savings / total) * 100">
          <div style="display:flex;justify-content:space-between;font-size:0.9em;margin-bottom:0.5em;">
            <span>Savings Rate</span>
            <span style="font-weight:bold;">${savingsPercent}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${savingsPercent}%"></div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function renderBalanceDashboard(balances, currencyTotals) {
  const maxTotal = Math.max(...balances.map(b => (Number(b.moneyOnHand) || 0) + (Number(b.savings) || 0)));
  
  // Calculate total portfolio across all currencies (for percentage display only, not summing amounts)
  const totalPortfolio = Object.values(currencyTotals).reduce((sum, curr) => sum + curr.total, 0);
  
  let html = `
    <div class="balance-dashboard" style="margin-top:1.5em;">
      <div class="balance-overview-chart">
        <div class="chart-title">ğŸ’° Total Assets by Currency</div>
        <div class="balance-chart-bars">
  `;
  
  balances.forEach(b => {
    const moneyOnHand = Number(b.moneyOnHand) || 0;
    const savings = Number(b.savings) || 0;
    const total = moneyOnHand + savings;
    const percentage = (total / maxTotal * 100);
    // Note: portfolioPercent is just for visual comparison between currencies, not actual monetary sum
    const portfolioPercent = totalPortfolio > 0 ? ((total / totalPortfolio) * 100).toFixed(1) : 0;
    
    html += `
      <div class="balance-chart-bar" title="Currency: ${b.currency}&#10;Variable: total = ${total}&#10;Formula: moneyOnHand (${moneyOnHand}) + savings (${savings})&#10;Percentage: ${portfolioPercent}%">
        <div class="balance-chart-label">${b.currency}</div>
        <div class="balance-chart-container">
          <div class="balance-chart-fill" style="width:${percentage}%">
            ${percentage > 20 ? portfolioPercent + '%' : ''}
          </div>
        </div>
        <div class="balance-chart-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
      <div class="balance-overview-chart">
        <div class="chart-title">ğŸ“Š Money on Hand vs Savings</div>
        <div class="balance-chart-bars">
  `;
  
  balances.forEach(b => {
    const moneyOnHand = Number(b.moneyOnHand) || 0;
    const savings = Number(b.savings) || 0;
    const maxValue = Math.max(moneyOnHand, savings, 1);
    const moneyPercent = (moneyOnHand / maxValue * 100);
    const savingsPercent = (savings / maxValue * 100);
    
    html += `
      <div style="margin-bottom:1.5em;">
        <div style="font-weight:bold;margin-bottom:0.8em;color:#667eea;">${b.currency}</div>
        <div class="balance-chart-bar" style="margin-bottom:0.5em;" title="Variable: b.moneyOnHand = ${moneyOnHand}&#10;Formula: initialBalance + income - expenses + transfersIn - transfersOut">
          <div style="min-width:120px;color:#555;">ğŸ’µ Money on Hand</div>
          <div class="balance-chart-container">
            <div class="balance-chart-fill" style="width:${moneyPercent}%;background:linear-gradient(90deg,#667eea,#764ba2)"></div>
          </div>
          <div class="balance-chart-value">${moneyOnHand.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
        </div>
        <div class="balance-chart-bar" title="Variable: b.savings = ${savings}">
          <div style="min-width:120px;color:#555;">ğŸ¦ Savings</div>
          <div class="balance-chart-container">
            <div class="balance-chart-fill" style="width:${savingsPercent}%;background:linear-gradient(90deg,#43e97b,#38f9d7)"></div>
          </div>
          <div class="balance-chart-value">${savings.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
        </div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
    </div>
  `;
  
  return html;
}

function renderBalanceComparison(balances) {
  let html = '<div class="balance-comparison" style="margin-top:1.5em;">';
  
  balances.forEach(b => {
    const moneyOnHand = Number(b.moneyOnHand) || 0;
    const savings = Number(b.savings) || 0;
    const initialBalance = Number(b.initialBalance) || 0;
    const closingBalance = Number(b.closingBalance) || 0;
    const total = moneyOnHand + savings;
    const savingsPercent = total > 0 ? ((savings / total) * 100).toFixed(1) : 0;
    const moneyPercent = total > 0 ? ((moneyOnHand / total) * 100).toFixed(1) : 0;
    
    html += `
      <div class="comparison-card">
        <div class="comparison-header">
          <div class="comparison-icon">ğŸ’³</div>
          <div class="comparison-title">${b.currency}</div>
        </div>
        <div class="comparison-stats">
          <div class="comparison-stat" title="Variable: b.initialBalance&#10;Alias: initial_amount (DB)">
            <div class="comparison-stat-label">Brought Forward</div>
            <div class="comparison-stat-value">${initialBalance.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="comparison-stat" title="Variable: b.closingBalance&#10;Alias: amount (DB)">
            <div class="comparison-stat-label">Closing Balance</div>
            <div class="comparison-stat-value">${closingBalance.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="comparison-stat" title="Variable: b.moneyOnHand&#10;Formula: initialBalance + income - expenses + transfersIn - transfersOut">
            <div class="comparison-stat-label">ğŸ’µ Money on Hand</div>
            <div class="comparison-stat-value" style="color:#667eea;">${moneyOnHand.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="comparison-progress" title="Variable: moneyPercent&#10;Formula: (moneyOnHand / total) * 100">
            <div style="font-size:0.85em;color:#999;margin-bottom:0.3em;">${moneyPercent}% of total</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${moneyPercent}%"></div>
            </div>
          </div>
          <div class="comparison-stat" title="Variable: b.savings">
            <div class="comparison-stat-label">ğŸ¦ Savings</div>
            <div class="comparison-stat-value" style="color:#43e97b;">${savings.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="comparison-progress" title="Variable: savingsPercent&#10;Formula: (savings / total) * 100">
            <div style="font-size:0.85em;color:#999;margin-bottom:0.3em;">${savingsPercent}% of total</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${savingsPercent}%;background:linear-gradient(90deg,#43e97b,#38f9d7)"></div>
            </div>
          </div>
          <div class="comparison-stat" style="background:#f9f9f9;margin-top:0.5em;padding:0.8em;border-radius:8px;" title="Variable: total&#10;Formula: moneyOnHand + savings">
            <div class="comparison-stat-label" style="font-weight:bold;">Total Assets</div>
            <div class="comparison-stat-value" style="font-size:1.2em;color:#667eea;">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function renderBalanceTable(balances) {
  let html = `
    <div class="balance-table-view" style="margin-top:1.5em;">
      <table class="balance-table">
        <thead>
          <tr>
            <th>Currency</th>
            <th title="Variable: initialBalance&#10;Alias: initial_amount (DB)">Brought Forward</th>
            <th title="Variable: closingBalance&#10;Alias: amount (DB)">Closing Balance</th>
            <th title="Variable: moneyOnHand&#10;Formula: initialBalance + income - expenses + transfersIn - transfersOut">Money on Hand</th>
            <th title="Variable: savings">Savings</th>
            <th title="Variable: total&#10;Formula: moneyOnHand + savings">Total Assets</th>
            <th title="Variable: savingsPercent&#10;Formula: (savings / total) * 100">Savings Rate</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  balances.forEach(b => {
    const moneyOnHand = Number(b.moneyOnHand) || 0;
    const savings = Number(b.savings) || 0;
    const initialBalance = Number(b.initialBalance) || 0;
    const closingBalance = Number(b.closingBalance) || 0;
    const total = moneyOnHand + savings;
    const savingsPercent = total > 0 ? ((savings / total) * 100).toFixed(1) : 0;
    
    html += `
      <tr>
        <td>
          <span class="balance-table-icon">ğŸ’³</span>
          <span class="balance-table-currency">${b.currency}</span>
        </td>
        <td title="Variable: b.initialBalance = ${initialBalance}">${initialBalance.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
        <td title="Variable: b.closingBalance = ${closingBalance}">${closingBalance.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
        <td style="color:#667eea;font-weight:600;" title="Variable: b.moneyOnHand = ${moneyOnHand}&#10;Formula: initialBalance + income - expenses + transfersIn - transfersOut">${moneyOnHand.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
        <td style="color:#43e97b;font-weight:600;" title="Variable: b.savings = ${savings}">${savings.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
        <td style="font-weight:bold;" title="Variable: total = ${total}&#10;Formula: ${moneyOnHand} + ${savings}">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
        <td title="Variable: savingsPercent = ${savingsPercent}&#10;Formula: (${savings} / ${total}) * 100">
          <div style="display:flex;align-items:center;gap:0.5em;">
            <div class="progress-bar" style="flex:1;min-width:60px;">
              <div class="progress-fill" style="width:${savingsPercent}%"></div>
            </div>
            <span style="font-weight:600;">${savingsPercent}%</span>
          </div>
        </td>
      </tr>
    `;
  });
  
  const totalMoneyOnHand = balances.reduce((sum, b) => sum + b.moneyOnHand, 0);
  const totalSavings = balances.reduce((sum, b) => sum + b.savings, 0);
  const grandTotal = totalMoneyOnHand + totalSavings;
  const avgSavingsRate = grandTotal > 0 ? ((totalSavings / grandTotal) * 100).toFixed(1) : 0;
  
  html += `
        </tbody>
        <tfoot>
          <tr style="background:#f5f5f5;font-weight:bold;">
            <td>TOTAL</td>
            <td colspan="2"></td>
            <td style="color:#667eea;" title="Variable: totalMoneyOnHand = ${totalMoneyOnHand}&#10;Formula: SUM of all moneyOnHand">${totalMoneyOnHand.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
            <td style="color:#43e97b;" title="Variable: totalSavings = ${totalSavings}&#10;Formula: SUM of all savings">${totalSavings.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
            <td style="font-size:1.1em;color:#333;" title="Variable: grandTotal = ${grandTotal}&#10;Formula: ${totalMoneyOnHand} + ${totalSavings}">${grandTotal.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
            <td title="Variable: avgSavingsRate = ${avgSavingsRate}&#10;Formula: (${totalSavings} / ${grandTotal}) * 100">${avgSavingsRate}%</td>
          </tr>
        </tfoot>
      </table>
    </div>
  `;
  
  return html;
}

// Set default date to today for all date fields
function setDefaultDates() {
  const now = new Date();
  const iso = now.toISOString().slice(0,16); // yyyy-MM-ddTHH:mm
  ['incomeDate', 'expenseDate', 'savingsDate', 'transferDate'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = iso;
  });
}

// Populate type dropdowns for income and expenses
async function populateTypeDropdowns() {
  const res = await authFetch('/types', { credentials: 'include' });
  let types = await res.json();
  if (!Array.isArray(types)) {
    // Show error or just return
    alert(types.error || "Failed to load types.");
    return;
  }
  // Expense types
  const expenseType = document.getElementById('expenseType');
  if (expenseType) {
    expenseType.innerHTML = '';
    types.filter(t => t.category === 'expense').forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.text = t.name;
      expenseType.appendChild(opt);
    });
  }
  // Income types
  const incomeType = document.getElementById('incomeType');
  if (incomeType) {
    incomeType.innerHTML = '';
    types.filter(t => t.category === 'income').forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.text = t.name;
      incomeType.appendChild(opt);
    });
  }
}

function hideSection(id) {
  const section = document.getElementById(id);
  if (section) section.style.display = 'none';
}
// Call these when showing the relevant section
function showSection(id) {
  // Skip if trying to show login/register (they don't exist anymore)
  if (id === 'login' || id === 'register') {
    return;
  }
  
  // Check if section exists
  const section = document.getElementById(id);
  if (!section) {
    console.warn('Section not found:', id);
    return;
  }
  
  document.querySelectorAll('.container section').forEach(sec => sec.style.display = 'none');
  section.style.display = 'block';
  setDefaultDates();
  // Save last section to localStorage
  localStorage.setItem('lastSection', id);


  const currency = getCurrency();
  if (id === 'income' || id === 'expenses') populateTypeDropdowns();
  if (id === 'income') {
    showSectionBalances('income', currency);
    fetchIncome();
  }
  if (id === 'expenses') {
    showSectionBalances('expenses', currency);
    fetchExpenses();
  }
  if (id === 'transfers') {
    showSectionBalances('transfers', currency);
    fetchTransfers();
  }
  if (id === 'savings') {
    showSectionBalances('savings', currency);
    lockSavingsFormIfExists();
    fetchSavings();
  }
  if (id === 'types') {
    fetchTypes();
  }
  if (id === 'balances') {
    updateBalanceCurrencyDropdown();
    showBalances();
  }
}

    // Register (no credentials needed)
    
    // Show login or register modal
    function showAuthModal(type) {
      closeAuthModal(); // Close any open modal first
      if (type === 'login') {
        document.getElementById('loginModal').style.display = 'flex';
      } else if (type === 'register') {
        document.getElementById('registerModal').style.display = 'flex';
      }
    }
    
    // Turnstile callbacks (used by modal)
    window.onTurnstileSuccess = function(token) {
      // Store token for modal form access
      window.turnstileToken = token;
      console.log('Turnstile verified');
    };
    
    window.onTurnstileError = function() {
      console.error('Turnstile verification failed');
      window.turnstileToken = null;
      alert('Security verification failed. Please refresh the page and try again.');
    };
    
    // Show profile after login
    function showProfile(user) {
      // Show profile in menu
      //document.getElementById('profileMenu').style.display = 'flex';
      const profileNameMenu = document.getElementById('profileNameMenu');
      const profilePicMenu = document.getElementById('profilePicMenu');
      
      if (profileNameMenu) {
        profileNameMenu.innerText = user.username;
      }
      if (profilePicMenu) {
        profilePicMenu.src = `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(user.username)}`;
      }
      
      const currencyFabContainer = document.getElementById('currencyFabContainer');
      if (currencyFabContainer) {
        currencyFabContainer.style.display = '';
      }
      
      // Hide auth links container in menu
      const authLinks = document.getElementById('authLinks');
      if (authLinks) authLinks.style.display = 'none';
    
      // (Optional) Hide profile section in main content if you have it
      if (document.getElementById('profile')) document.getElementById('profile').style.display = 'none';
      if (localStorage.getItem('jwtToken')) {
   //toremove
   checkMonthClose();
  }
    }
    
    function hideProfile() {
      const currencyFabContainer = document.getElementById('currencyFabContainer');
      if (currencyFabContainer) {
        currencyFabContainer.style.display = 'none';
      }
      //const profileMenu = document.getElementById('profileMenu');
      //if (profileMenu) profileMenu.style.display = 'none';
      
      // Show auth links container
      const authLinks = document.getElementById('authLinks');
      if (authLinks) authLinks.style.display = 'block';
      
      const registerLink = document.getElementById('registerLink');
      const loginLink = document.getElementById('loginLink');
      if (registerLink) registerLink.style.display = '';
      if (loginLink) loginLink.style.display = '';
    }
    
    // --- Month Close Workflow ---

const MONTH_CLOSE_KEY = 'lastClosedMonth';

function getCurrentMonthStr() {
  const now = new Date();
  return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
}

function getPreviousMonthStr() {
  const now = new Date();
  let year = now.getFullYear();
  let month = now.getMonth(); // 0-based, so this is previous month
  if (month === 0) { // January
    month = 12;
    year -= 1;
  }
  return `${year}-${String(month).padStart(2, '0')}`;
}

async function isPreviousMonthClosedBackend() {
  try {
    const token = localStorage.getItem('jwtToken');
    const res = await authFetch('/balances/needs-close');
    if (!res.ok) return false;
    const data = await res.json();
    return !data.needsClosing;
  } catch (e) {
    return false;
  }
}


function lockAllSections() {
  document.querySelectorAll('.container section, #profile').forEach(sec => {
    sec.style.pointerEvents = 'none';
    sec.style.opacity = '0.5';
  });
  document.getElementById('currencyFabContainer').style.pointerEvents = 'none';
  document.getElementById('currencyFabContainer').style.opacity = '0.5';
}

function unlockAllSections() {
  document.querySelectorAll('.container section, #profile').forEach(sec => {
    sec.style.pointerEvents = '';
    sec.style.opacity = '';
  });
  document.getElementById('currencyFabContainer').style.pointerEvents = '';
  document.getElementById('currencyFabContainer').style.opacity = '';
}

function showCloseMonthModal(balances) {
  // Show summary
  let summary = '';
  balances.forEach(b => {
    summary += `<div><b>${b.currency}</b>:<br>
      Money on Hand: <b>${b.moneyOnHand?.toLocaleString(undefined,{minimumFractionDigits:2}) ?? 0}</b><br>
      Savings: <b>${b.savings !== undefined ? b.savings.toLocaleString(undefined,{minimumFractionDigits:2}) : 'N/A'}</b>
    </div><hr>`;
  });
  summary += `<div style="color:#d32f2f;font-weight:bold;">You must close the previous month and set starting values for this month before continuing.</div>`;
  document.getElementById('closeMonthSummary').innerHTML = summary;

  // Render a row for each currency
  const container = document.getElementById('closeMonthCurrencies');
  container.innerHTML = '';
  balances.forEach(b => {
    container.innerHTML += `
      <div class="close-month-currency-row" data-currency="${b.currency}" style="margin-bottom:1em; border-bottom:1px solid #eee; padding-bottom:1em;">
        <div style="font-weight:bold; margin-bottom:0.5em;">${b.currency}</div>
        <label style="display:block;margin-bottom:0.3em;">Money on Hand:
          <input type="number" step="0.01" name="moneyOnHand" value="${b.moneyOnHand ?? ''}" required style="width:120px;">
        </label>
        <label style="display:block;margin-bottom:0.3em;">Savings:
          <input type="number" step="0.01" name="savings" value="${b.savings ?? ''}" required style="width:120px;">
        </label>
      </div>
    `;
  });

  document.getElementById('closeMonthModal').style.display = 'flex';
}


function hideCloseMonthModal() {
  document.getElementById('closeMonthModal').style.display = 'none';
  document.getElementById('closeMonthError').innerText = '';
}

async function manuallyCloseMonth() {
  // Fetch current month balances
  let balances = [];
  try {
    const currentMonth = getCurrentMonthStr();
    const res = await authFetch('/balances?month=' + currentMonth, { credentials: 'include' });
    balances = await res.json();
  } catch (e) {
    balances = [];
  }
  if (!Array.isArray(balances) || balances.length === 0) {
    alert('Could not load balances for the current month.');
    return;
  }
  console.log('Manual close month - Balances:', balances);
  showCloseMonthModal(balances);
}

async function resetDatabase() {
  const confirmMsg = 'âš ï¸ DANGER ZONE âš ï¸\n\n' +
    'This will permanently delete ALL:\n' +
    'â€¢ Income and Expense Entries\n' +
    'â€¢ Balances\n' +
    'â€¢ Savings\n' +
    'â€¢ Transfers\n' +
    'â€¢ Closed Months\n' +
    'â€¢ Month Close Audits\n\n' +
    'Your Types and Currencies will be preserved.\n\n' +
    'Type "RESET" to confirm:';
  
  const userInput = prompt(confirmMsg);
  if (userInput !== 'RESET') {
    alert('Reset cancelled.');
    return;
  }
  
  try {
    const res = await authFetch('/user/reset-database', {
      method: 'POST',
      credentials: 'include'
    });
    
    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(errorData.error || 'Failed to reset database');
    }
    
    const result = await res.json();
    alert('âœ… Database reset successfully!\n\n' + 
          'Deleted:\n' +
          `â€¢ ${result.deletedCounts.entries} entries\n` +
          `â€¢ ${result.deletedCounts.balances} balances\n` +
          `â€¢ ${result.deletedCounts.savings} savings\n` +
          `â€¢ ${result.deletedCounts.transfers} transfers\n` +
          `â€¢ ${result.deletedCounts.closedMonths} closed months\n` +
          `â€¢ ${result.deletedCounts.audits} audits`);
    
    // Refresh all data
    await refreshAllData();
    
    // Show the current section
    const currentSection = localStorage.getItem('lastSection') || 'balances';
    showSection(currentSection);
  } catch (err) {
    console.error('Reset database error:', err);
    alert('âŒ Error: ' + err.message);
  }
}

// Helper function to refresh all data after reset/restore
async function refreshAllData() {
  // Reset all data arrays
  transferData = [];
  transferOffset = 0;
  transferHasMore = true;
  
  // Fetch fresh data for each section
  await fetchTransfers({ reset: true });
  await fetchIncome({ reset: true });
  await fetchExpenses({ reset: true });
  await fetchSavings({ reset: true });
  await fetchTypes({ reset: true });
}

async function backupDatabase() {
  try {
    const res = await authFetch('/user/backup', {
      method: 'GET',
      credentials: 'include'
    });
    
    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(errorData.error || 'Failed to backup database');
    }
    
    const backup = await res.json();
    
    // Create download link
    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    // Create filename with date
    const date = new Date().toISOString().split('T')[0];
    const filename = `personal_finance_backup_${date}.json`;
    
    // Trigger download
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('âœ… Backup downloaded successfully!\n\nFile: ' + filename);
  } catch (err) {
    console.error('Backup error:', err);
    alert('âŒ Error: ' + (err.message || 'Failed to backup database'));
  }
}

async function restoreDatabase(file) {
  if (!file) return;
  
  const confirmMsg = 'âš ï¸ RESTORE DATABASE âš ï¸\n\n' +
    'This will REPLACE all your current data with the backup file:\n' +
    `â€¢ File: ${file.name}\n` +
    `â€¢ Size: ${(file.size / 1024).toFixed(2)} KB\n\n` +
    'Your current data will be DELETED!\n\n' +
    'Type "RESTORE" to confirm:';
  
  const userInput = prompt(confirmMsg);
  if (userInput !== 'RESTORE') {
    alert('Restore cancelled.');
    document.getElementById('restoreFileInput').value = ''; // Reset file input
    return;
  }
  
  try {
    // Read file
    const text = await file.text();
    const backup = JSON.parse(text);
    
    // Validate backup structure
    if (!backup.data || !backup.version) {
      throw new Error('Invalid backup file format');
    }
    
    // Send to server
    const res = await authFetch('/user/restore', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: backup.data }),
      credentials: 'include'
    });
    
    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(errorData.error || 'Failed to restore database');
    }
    
    const result = await res.json();
    
    let msg = 'âœ… Database restored successfully!\n\nRestored:\n';
    if (result.restoreCounts) {
      if (result.restoreCounts.types) msg += `â€¢ ${result.restoreCounts.types} types\n`;
      if (result.restoreCounts.userCurrencies) msg += `â€¢ ${result.restoreCounts.userCurrencies} currency selections\n`;
      if (result.restoreCounts.balances) msg += `â€¢ ${result.restoreCounts.balances} balances\n`;
      if (result.restoreCounts.entries) msg += `â€¢ ${result.restoreCounts.entries} entries\n`;
      if (result.restoreCounts.savings) msg += `â€¢ ${result.restoreCounts.savings} savings\n`;
      if (result.restoreCounts.transfers) msg += `â€¢ ${result.restoreCounts.transfers} transfers\n`;
      if (result.restoreCounts.closedMonths) msg += `â€¢ ${result.restoreCounts.closedMonths} closed months\n`;
      if (result.restoreCounts.audits) msg += `â€¢ ${result.restoreCounts.audits} audits`;
    }
    alert(msg);
    
    // Refresh all data
    await refreshAllData();
    
    // Refresh the current view
    const currentSection = localStorage.getItem('lastSection') || 'balances';
    showSection(currentSection);
  } catch (err) {
    console.error('Restore error:', err);
    alert('âŒ Error: ' + (err.message || 'Failed to restore database'));
  } finally {
    document.getElementById('restoreFileInput').value = ''; // Reset file input
  }
}

async function backupDatabase() {
  try {
    const res = await authFetch('/user/backup', {
      method: 'GET',
      credentials: 'include'
    });
    
    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(errorData.error || 'Failed to backup database');
    }
    
    const backup = await res.json();
    
    // Create download link
    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    // Create filename with date
    const date = new Date().toISOString().split('T')[0];
    const filename = `personal_finance_backup_${date}.json`;
    
    // Trigger download
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('âœ… Backup downloaded successfully!\n\nFile: ' + filename);
  } catch (err) {
    console.error('Backup error:', err);
    alert('âŒ Error: ' + (err.message || 'Failed to backup database'));
  }
}

async function restoreDatabase(file) {
  if (!file) return;
  
  const confirmMsg = 'âš ï¸ RESTORE DATABASE âš ï¸\n\n' +
    'This will REPLACE all your current data with the backup file:\n' +
    `â€¢ File: ${file.name}\n` +
    `â€¢ Size: ${(file.size / 1024).toFixed(2)} KB\n\n` +
    'Your current data will be DELETED!\n\n' +
    'Type "RESTORE" to confirm:';
  
  const userInput = prompt(confirmMsg);
  if (userInput !== 'RESTORE') {
    alert('Restore cancelled.');
    document.getElementById('restoreFileInput').value = ''; // Reset file input
    return;
  }
  
  try {
    // Read file
    const text = await file.text();
    const backup = JSON.parse(text);
    
    // Validate backup structure
    if (!backup.data || !backup.version) {
      throw new Error('Invalid backup file format');
    }
    
    // Send to server
    const res = await authFetch('/user/restore', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: backup.data }),
      credentials: 'include'
    });
    
    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(errorData.error || 'Failed to restore database');
    }
    
    const result = await res.json();
    
    let msg = 'âœ… Database restored successfully!\n\nRestored:\n';
    if (result.restoreCounts) {
      if (result.restoreCounts.types) msg += `â€¢ ${result.restoreCounts.types} types\n`;
      if (result.restoreCounts.userCurrencies) msg += `â€¢ ${result.restoreCounts.userCurrencies} currency selections\n`;
      if (result.restoreCounts.balances) msg += `â€¢ ${result.restoreCounts.balances} balances\n`;
      if (result.restoreCounts.entries) msg += `â€¢ ${result.restoreCounts.entries} entries\n`;
      if (result.restoreCounts.savings) msg += `â€¢ ${result.restoreCounts.savings} savings\n`;
      if (result.restoreCounts.transfers) msg += `â€¢ ${result.restoreCounts.transfers} transfers\n`;
      if (result.restoreCounts.closedMonths) msg += `â€¢ ${result.restoreCounts.closedMonths} closed months\n`;
      if (result.restoreCounts.audits) msg += `â€¢ ${result.restoreCounts.audits} audits`;
    }
    alert(msg);
    
    // Refresh the current view
    const currentSection = localStorage.getItem('lastSection') || 'balances';
    showSection(currentSection);
  } catch (err) {
    console.error('Restore error:', err);
    alert('âŒ Error: ' + (err.message || 'Failed to restore database'));
  } finally {
    document.getElementById('restoreFileInput').value = ''; // Reset file input
  }
}

async function checkMonthClose() {
  // DISABLED FOR TESTING - Remove this return to re-enable month closing checks
  unlockAllSections();
  hideCloseMonthModal();
  return;
  
  const closed = await isPreviousMonthClosedBackend();
  if (closed) {
    unlockAllSections();
    hideCloseMonthModal();
    return;
  }
  lockAllSections();

  // Fetch balances
  let balances = [];
  try {
    const prevMonth = getPreviousMonthStr();
    const res = await authFetch('/balances?month=' + prevMonth, { credentials: 'include' });
    balances = await res.json();
  } catch (e) {
    balances = [];
  }
  if (!Array.isArray(balances)) {
    document.getElementById('closeMonthSummary').innerHTML = '<span style="color:red;">Could not load balances.</span>';
    return;
  }
  console.log('Balances passed to modal:', balances);
  
  //toremove
  showCloseMonthModal(balances);
 
}

// Handle month close form submit
const closeMonthForm = document.getElementById('closeMonthForm');
if (closeMonthForm) {
  closeMonthForm.onsubmit = async function(e) {
    e.preventDefault();

  // Gather all currencies' balances from the form
  const balances = [];
  document.querySelectorAll('.close-month-currency-row').forEach(row => {
    balances.push({
      currency: row.dataset.currency,
      moneyOnHand: parseFloat(row.querySelector('input[name="moneyOnHand"]').value),
      savings: parseFloat(row.querySelector('input[name="savings"]').value),
     // balance: parseFloat(row.querySelector('input[name="balance"]').value)
    });
    
  });
  
  // Show confirmation dialog with all values
  const month = getPreviousMonthStr();
  let confirmMessage = `Close month ${month}?\n\n`;
  balances.forEach(b => {
    confirmMessage += `${b.currency}:\n`;
    confirmMessage += `  Money on Hand: ${b.moneyOnHand}\n`;
    confirmMessage += `  Savings: ${b.savings}\n\n`;
  });
  confirmMessage += 'Check the console (F12) for detailed JSON data.';
  
  // Log detailed data to console
  console.log('=== CLOSE MONTH DATA ===');
  console.log('Month:', month);
  console.log('Balances:', JSON.stringify(balances, null, 2));
  console.log('Full payload:', JSON.stringify({ month, balances }, null, 2));
  console.log('========================');
  
  if (!confirm(confirmMessage)) {
    return;
  }
  
// Get CSRF token from cookie
const csrfToken = getCookie('_csrf'); // <-- Use '_csrf' instead of 'XSRF-TOKEN'
  try {
    const res = await authFetch('/balances/close-month', { // Updated to authFetch
      method: 'POST',
      credentials: 'include',
       headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken // <-- Add this header
      },
      body: JSON.stringify({
        month: getPreviousMonthStr(),
        balances
      })
    });
    if (!res.ok) throw new Error('Failed to close month');
    localStorage.setItem('lastClosedMonth', getCurrentMonthStr());
    hideCloseMonthModal();
    unlockAllSections();
    showBalances && showBalances();
  } catch (err) {
    document.getElementById('closeMonthError').innerText = 'Error closing month. Please try again.';
  }
};
}

// Hide modal on outside click
document.getElementById('closeMonthModal').onclick = function(e) {
  if (e.target === this) hideCloseMonthModal();
};

    // On page load, check if user info is in localStorage
   window.addEventListener('DOMContentLoaded', function() {
  const currencyFabContainer = document.getElementById('currencyFabContainer');
  if (currencyFabContainer) {
    currencyFabContainer.style.display = 'none';
  }
  populateMonthYear();
  const token = localStorage.getItem('jwtToken');
  const userStr = localStorage.getItem('user');
 if (token && userStr) {
    // Optionally fetch user info from backend if needed
    const user = JSON.parse(userStr);
  showProfile(user);
    enableApp();
    openSidebar();
    showBalances();
    const lastSection = localStorage.getItem('lastSection') || 'balances';
    showSection(lastSection);
  } else {
    hideProfile();
    disableApp();
    hideApp();
  }
});
    
    // Populate month and year dropdowns with current values as default
    function populateMonthYear() {
      const now = new Date();
      const monthSelect = document.getElementById('reportMonth');
      const yearSelect = document.getElementById('reportYear');
      if (monthSelect && yearSelect) {
        monthSelect.innerHTML = '';
        yearSelect.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
          const opt = document.createElement('option');
          opt.value = m;
          opt.text = m;
          if (m === now.getMonth() + 1) opt.selected = true;
          monthSelect.appendChild(opt);
        }
        const thisYear = now.getFullYear();
        for (let y = thisYear - 5; y <= thisYear + 5; y++) {
          const opt = document.createElement('option');
          opt.value = y;
          opt.text = y;
          if (y === thisYear) opt.selected = true;
          yearSelect.appendChild(opt);
        }
      }
    }
    /*
    // After successful login:
    */

    // Income form handler
  document.getElementById('incomeForm').onsubmit = async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this));
  const res = await authFetch('/entries', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ ...data, category: 'income' })
  });
  // Optionally show a result message
const newItem = await res.json();
  document.getElementById('incomeResult').innerText = res.ok ? 'Income added!' : (newItem.error || 'Failed to add income');
  this.amount && (this.amount.value = '');
  this.note && (this.note.value = '');
  
  if (res.ok) {
    await showBalances();
    if (typeof fetchSavings === 'function') fetchSavings();
    // Refresh income data and re-render
    await fetchIncome({ reset: true });
  }
  //===============================
  //incomeData.unshift(newItem);
  //renderIncomeGrid();
  //--------
  //================================
  //document.getElementById('incomeResult').innerText = await res.text();
  //this.amount && (this.amount.value = '');
  //this.note && (this.note.value = '');
  //await showBalances();
  //if (typeof fetchSavings === 'function') fetchSavings();
  //fetchIncome({ reset: true }); // Always reload the list to ensure types and data are up to date
};

    let incomeOffset = 0;
let incomeLimit = 50;
let incomeHasMore = true;
let incomeData = [];
let incomeIsLoading = false;

async function fetchIncome({ reset = false } = {}) {
  if (!localStorage.getItem('jwtToken')) return; // <--- Add this line
  if (incomeIsLoading) return;
  
  incomeIsLoading = true;
  if (reset) {
    incomeOffset = 0; incomeHasMore = true; incomeData = [];
    document.getElementById('incomeGrid').innerHTML = '';
  }
  if (!incomeHasMore) return;
  try {
    const res = await authFetch(`/entries?category=income&limit=${incomeLimit}&offset=${incomeOffset}`, { credentials: 'include' });
    if (res.status === 401) { forceLogoutOnError(); return; }
    const data = await res.json();
    if (data.length < incomeLimit) incomeHasMore = false;
    incomeData = incomeData.concat(data);
    incomeOffset += data.length;
    renderIncomeGrid();
  } catch (err) { forceLogoutOnError(); }
  finally { incomeIsLoading = false; }
}

function toggleIncomeGroup(currency) {
  if (!window.incomeGroupState) window.incomeGroupState = {};
  // Collapse if already expanded, else expand only this group
  window.incomeGroupState.expanded = (window.incomeGroupState.expanded === currency) ? null : currency;
  renderIncomeGrid();
}

function renderIncomeGrid() {
  window.incomeDataGroups = {};
  incomeData.forEach(i => {
    if (!window.incomeDataGroups[i.currency]) window.incomeDataGroups[i.currency] = [];
    window.incomeDataGroups[i.currency].push(i);
  });
  
  const view = localStorage.getItem('incomeView') || 'cards';
  renderIncomeView(view);
}

function changeIncomeView(view) {
  localStorage.setItem('incomeView', view);
  renderIncomeView(view);
}

function renderIncomeView(view) {
  if (!window.incomeDataGroups) return;
  
  const viewSwitcher = `
    <div class="data-view-switcher">
      <button class="data-view-btn ${view === 'cards' ? 'active' : ''}" onclick="changeIncomeView('cards')">ğŸƒ Cards</button>
      <button class="data-view-btn ${view === 'tabs' ? 'active' : ''}" onclick="changeIncomeView('tabs')">ğŸ“‘ Tabs</button>
      <button class="data-view-btn ${view === 'columns' ? 'active' : ''}" onclick="changeIncomeView('columns')">âš Columns</button>
      <button class="data-view-btn ${view === 'timeline' ? 'active' : ''}" onclick="changeIncomeView('timeline')">ğŸ“… Timeline</button>
      <button class="data-view-btn ${view === 'dashboard' ? 'active' : ''}" onclick="changeIncomeView('dashboard')">ğŸ“Š Dashboard</button>
    </div>
  `;
  
  let html = viewSwitcher;
  
  if (view === 'cards') {
    html += renderIncomeCards();
  } else if (view === 'tabs') {
    html += renderIncomeTabs();
  } else if (view === 'columns') {
    html += renderIncomeColumns();
  } else if (view === 'timeline') {
    html += renderIncomeTimeline();
  } else if (view === 'dashboard') {
    html += renderIncomeDashboard();
  }
  
  document.getElementById('incomeGrid').innerHTML = html;
}

function renderIncomeCards() {
  let html = '<div class="currency-cards">';
  Object.keys(window.incomeDataGroups).forEach(currency => {
    const records = window.incomeDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const avg = total / records.length;
    const expanded = window.incomeCardState && window.incomeCardState[currency];
    
    html += `
      <div class="currency-card">
        <div class="currency-card-header">
          <div class="currency-card-icon">ğŸ’µ</div>
          <div class="currency-card-title">
            <div class="currency-card-name">${currency}</div>
            <div class="currency-card-count">${records.length} records</div>
          </div>
        </div>
        <div class="currency-card-stats">
          <div class="stat-item" title="Variable: total (${currency})&#10;Formula: SUM of all income amounts&#10;Value: ${total}">
            <div class="stat-label">Total</div>
            <div class="stat-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="stat-item" title="Variable: avg (${currency})&#10;Formula: total / count&#10;Value: ${total} / ${records.length} = ${avg}">
            <div class="stat-label">Average</div>
            <div class="stat-value">${avg.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
        </div>
        <div class="currency-card-toggle" onclick="toggleIncomeCard('${currency}')">
          ${expanded ? 'â–² Hide Details' : 'â–¼ Show Details'}
        </div>
        <div class="currency-card-details ${expanded ? 'expanded' : ''}">
          <table class="${getCurrentTableTheme()}" style="width:100%;font-size:0.9em;">
            <thead>
              <tr><th>Date</th><th>Type</th><th>Amount</th></tr>
            </thead>
            <tbody>
              ${records.slice(0, 5).map(r => `
                <tr>
                  <td>${r.date ? new Date(r.date).toLocaleDateString() : ''}</td>
                  <td>${r.Type ? r.Type.name : ''}</td>
                  <td>${r.amount}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  });
  html += '</div>';
  return html;
}

function toggleIncomeCard(currency) {
  if (!window.incomeCardState) window.incomeCardState = {};
  window.incomeCardState[currency] = !window.incomeCardState[currency];
  renderIncomeView(localStorage.getItem('incomeView') || 'cards');
}

function renderIncomeTabs() {
  const currencies = Object.keys(window.incomeDataGroups);
  const activeTab = window.incomeActiveTab || currencies[0];
  
  let html = '<div class="currency-tabs">';
  currencies.forEach(currency => {
    const records = window.incomeDataGroups[currency];
    html += `<button class="currency-tab ${activeTab === currency ? 'active' : ''}" onclick="switchIncomeTab('${currency}')">ğŸ’µ ${currency} (${records.length})</button>`;
  });
  html += '</div>';
  
  currencies.forEach(currency => {
    const records = window.incomeDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const avg = total / records.length;
    
    html += `
      <div class="currency-tab-content ${activeTab === currency ? 'active' : ''}">
        <div class="currency-summary">
          <div class="summary-stat" title="Variable: total (${currency})&#10;Formula: SUM of all income amounts&#10;Value: ${total}">
            <div class="summary-label">Total Income</div>
            <div class="summary-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="summary-stat" title="Variable: records.length&#10;Value: ${records.length}">
            <div class="summary-label">Records</div>
            <div class="summary-value">${records.length}</div>
          </div>
          <div class="summary-stat" title="Variable: avg (${currency})&#10;Formula: total / count&#10;Value: ${total} / ${records.length} = ${avg}">
            <div class="summary-label">Average</div>
            <div class="summary-value">${avg.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
        </div>
        <table class="${getCurrentTableTheme()}" style="width:100%;">
          <thead>
            <tr><th>Date</th><th>Type</th><th>Note</th><th>Amount</th><th>Action</th></tr>
          </thead>
          <tbody>
            ${records.map(r => `
              <tr>
                <td>${r.date ? new Date(r.date).toLocaleDateString() : ''}</td>
                <td>${r.Type ? r.Type.name : ''}</td>
                <td>${r.note || ''}</td>
                <td>${r.amount}</td>
                <td><button class="button danger" onclick="deleteIncome(${r.id})">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;font-weight:bold;">Total:</td>
              <td style="font-weight:bold;">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    `;
  });
  
  return html;
}

function switchIncomeTab(currency) {
  window.incomeActiveTab = currency;
  renderIncomeView('tabs');
}

function renderIncomeColumns() {
  let html = '<div class="currency-columns">';
  Object.keys(window.incomeDataGroups).forEach(currency => {
    const records = window.incomeDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const expanded = window.incomeColumnState && window.incomeColumnState[currency];
    const displayRecords = expanded ? records : records.slice(0, 5);
    
    html += `
      <div class="currency-column">
        <div class="currency-column-header">
          <div class="currency-column-icon">ğŸ’µ</div>
          <div class="currency-column-title">${currency}</div>
        </div>
        <div class="currency-column-total">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
        <div class="column-records">
          ${displayRecords.map(r => `
            <div class="column-record">
              <div class="record-date">${r.date ? new Date(r.date).toLocaleDateString() : ''}</div>
              <div class="record-type">${r.Type ? r.Type.name : ''}</div>
              <div class="record-amount">${r.amount}</div>
            </div>
          `).join('')}
        </div>
        ${!expanded && records.length > 5 ? `
          <div class="column-see-all">
            <button onclick="toggleIncomeColumn('${currency}')">See All ${records.length} Records</button>
          </div>
        ` : expanded ? `
          <div class="column-see-all">
            <button onclick="toggleIncomeColumn('${currency}')">Show Less</button>
          </div>
        ` : ''}
      </div>
    `;
  });
  html += '</div>';
  return html;
}

function toggleIncomeColumn(currency) {
  if (!window.incomeColumnState) window.incomeColumnState = {};
  window.incomeColumnState[currency] = !window.incomeColumnState[currency];
  renderIncomeView('columns');
}

function renderIncomeTimeline() {
  const allRecords = [];
  Object.keys(window.incomeDataGroups).forEach(currency => {
    window.incomeDataGroups[currency].forEach(r => {
      allRecords.push({...r, currency});
    });
  });
  
  allRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const currencies = [...new Set(allRecords.map(r => r.currency))];
  const activeFilters = window.incomeTimelineFilters || currencies;
  
  let html = `
    <div class="timeline-view">
      <div class="timeline-filters">
        <button class="timeline-filter ${activeFilters.length === currencies.length ? 'active' : ''}" onclick="filterIncomeTimeline('all')">All</button>
        ${currencies.map(c => `
          <button class="timeline-filter ${activeFilters.includes(c) ? 'active' : ''}" onclick="filterIncomeTimeline('${c}')">ğŸ’µ ${c}</button>
        `).join('')}
      </div>
  `;
  
  const groupedByDate = {};
  const filteredRecords = allRecords.filter(r => activeFilters.includes(r.currency));
  
  filteredRecords.forEach(r => {
    const date = new Date(r.date);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    let group;
    if (date.toDateString() === today.toDateString()) {
      group = 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
      group = 'Yesterday';
    } else if (date >= new Date(today.setDate(today.getDate() - 7))) {
      group = 'This Week';
    } else {
      group = date.toLocaleDateString('en-US', {month: 'long', year: 'numeric'});
    }
    
    if (!groupedByDate[group]) groupedByDate[group] = [];
    groupedByDate[group].push(r);
  });
  
  Object.keys(groupedByDate).forEach(group => {
    html += `
      <div class="timeline-group">
        <div class="timeline-group-title">${group}</div>
        ${groupedByDate[group].map(r => `
          <div class="timeline-item">
            <div class="timeline-badge">${r.currency}</div>
            <div class="timeline-content">
              <div class="timeline-type">${r.Type ? r.Type.name : ''}</div>
              <div class="timeline-note">${r.note || 'No note'}</div>
            </div>
            <div class="timeline-amount">${r.amount}</div>
          </div>
        `).join('')}
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function filterIncomeTimeline(filter) {
  const currencies = Object.keys(window.incomeDataGroups);
  if (filter === 'all') {
    window.incomeTimelineFilters = currencies;
  } else {
    if (!window.incomeTimelineFilters) window.incomeTimelineFilters = currencies;
    if (window.incomeTimelineFilters.includes(filter)) {
      window.incomeTimelineFilters = window.incomeTimelineFilters.filter(c => c !== filter);
      if (window.incomeTimelineFilters.length === 0) window.incomeTimelineFilters = currencies;
    } else {
      window.incomeTimelineFilters.push(filter);
    }
  }
  renderIncomeView('timeline');
}

function renderIncomeDashboard() {
  const currencies = Object.keys(window.incomeDataGroups);
  const activeCurrency = window.incomeDashboardCurrency || 'all';
  const allRecords = [];
  let grandTotal = 0;
  
  currencies.forEach(currency => {
    window.incomeDataGroups[currency].forEach(r => {
      allRecords.push({...r, currency});
      grandTotal += r.amount;
    });
  });
  
  let html = `
    <div class="dashboard-view">
      <div class="dashboard-summary">
  `;
  
  currencies.forEach(currency => {
    const records = window.incomeDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    
    html += `
      <div class="dashboard-card ${activeCurrency === currency ? 'active' : ''}" onclick="selectIncomeDashboardCurrency('${currency}')">
        <div class="dashboard-card-icon">ğŸ’µ</div>
        <div class="dashboard-card-currency">${currency}</div>
        <div class="dashboard-card-total">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
        <div class="dashboard-card-count">${records.length} records</div>
      </div>
    `;
  });
  
  html += `
      </div>
      <div class="dashboard-chart">
        <div class="dashboard-chart-title">Income Distribution by Currency</div>
        <div class="chart-bars">
  `;
  
  const maxTotal = Math.max(...currencies.map(c => window.incomeDataGroups[c].reduce((sum, r) => sum + Number(r.amount), 0)));
  
  currencies.forEach(currency => {
    const records = window.incomeDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const percentage = (total / maxTotal * 100);
    
    html += `
      <div class="chart-bar-item">
        <div class="chart-bar-label">${currency}</div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill" style="width: ${percentage}%"></div>
        </div>
        <div class="chart-bar-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
      <div class="dashboard-data">
        <div class="dashboard-data-title">${activeCurrency === 'all' ? 'All Transactions' : activeCurrency + ' Transactions'}</div>
        <table class="${getCurrentTableTheme()}" style="width:100%;">
          <thead>
            <tr><th>Date</th><th>Currency</th><th>Type</th><th>Note</th><th>Amount</th><th>Action</th></tr>
          </thead>
          <tbody>
            ${(activeCurrency === 'all' ? allRecords : allRecords.filter(r => r.currency === activeCurrency)).map(r => `
              <tr>
                <td>${r.date ? new Date(r.date).toLocaleDateString() : ''}</td>
                <td>${r.currency}</td>
                <td>${r.Type ? r.Type.name : ''}</td>
                <td>${r.note || ''}</td>
                <td>${r.amount}</td>
                <td><button class="button danger" onclick="deleteIncome(${r.id})">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  return html;
}

function selectIncomeDashboardCurrency(currency) {
  window.incomeDashboardCurrency = currency;
  renderIncomeView('dashboard');
}

// Generic helper functions for rendering data views (used by Income, Expense, etc.)
function renderDataCards(dataGroups, dataType, icon) {
  const stateKey = `${dataType}CardState`;
  let html = '<div class="currency-cards">';
  Object.keys(dataGroups).forEach(currency => {
    const records = dataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const avg = total / records.length;
    const expanded = window[stateKey] && window[stateKey][currency];
    
    html += `
      <div class="currency-card">
        <div class="currency-card-header">
          <div class="currency-card-icon">${icon}</div>
          <div class="currency-card-title">
            <div class="currency-card-name">${currency}</div>
            <div class="currency-card-count">${records.length} records</div>
          </div>
        </div>
        <div class="currency-card-stats">
          <div class="stat-item" title="Variable: total (${currency})&#10;Formula: SUM of all ${dataType} amounts&#10;Value: ${total}">
            <div class="stat-label">Total</div>
            <div class="stat-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="stat-item" title="Variable: avg (${currency})&#10;Formula: total / count&#10;Value: ${total} / ${records.length} = ${avg}">
            <div class="stat-label">Average</div>
            <div class="stat-value">${avg.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
        </div>
        <div class="currency-card-toggle" onclick="toggleDataCard('${dataType}', '${currency}')">
          ${expanded ? 'â–² Hide Details' : 'â–¼ Show Details'}
        </div>
        <div class="currency-card-details ${expanded ? 'expanded' : ''}">
          <table class="${getCurrentTableTheme()}" style="width:100%;font-size:0.9em;">
            <thead>
              <tr><th>Date</th><th>Type</th><th>Amount</th></tr>
            </thead>
            <tbody>
              ${records.slice(0, 5).map(r => `
                <tr>
                  <td>${r.date ? new Date(r.date).toLocaleDateString() : ''}</td>
                  <td>${r.Type ? r.Type.name : ''}</td>
                  <td>${r.amount}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  });
  html += '</div>';
  return html;
}

function toggleDataCard(dataType, currency) {
  const stateKey = `${dataType}CardState`;
  if (!window[stateKey]) window[stateKey] = {};
  window[stateKey][currency] = !window[stateKey][currency];
  if (dataType === 'income') renderIncomeView(localStorage.getItem('incomeView') || 'cards');
  if (dataType === 'expense') renderExpenseView(localStorage.getItem('expenseView') || 'cards');
}

function renderDataTabs(dataGroups, dataType, icon) {
  const currencies = Object.keys(dataGroups);
  const tabKey = `${dataType}ActiveTab`;
  const activeTab = window[tabKey] || currencies[0];
  
  let html = '<div class="currency-tabs">';
  currencies.forEach(currency => {
    const records = dataGroups[currency];
    html += `<button class="currency-tab ${activeTab === currency ? 'active' : ''}" onclick="switchDataTab('${dataType}', '${currency}')">${icon} ${currency} (${records.length})</button>`;
  });
  html += '</div>';
  
  currencies.forEach(currency => {
    const records = dataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const avg = total / records.length;
    
    html += `
      <div class="currency-tab-content ${activeTab === currency ? 'active' : ''}">
        <div class="currency-summary">
          <div class="summary-stat">
            <div class="summary-label">Total ${dataType === 'income' ? 'Income' : 'Expenses'}</div>
            <div class="summary-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="summary-stat">
            <div class="summary-label">Records</div>
            <div class="summary-value">${records.length}</div>
          </div>
          <div class="summary-stat">
            <div class="summary-label">Average</div>
            <div class="summary-value">${avg.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
        </div>
        <table class="${getCurrentTableTheme()}" style="width:100%;">
          <thead>
            <tr><th>Date</th><th>Type</th><th>Note</th><th>Amount</th><th>Action</th></tr>
          </thead>
          <tbody>
            ${records.map(r => `
              <tr>
                <td>${r.date ? new Date(r.date).toLocaleDateString() : ''}</td>
                <td>${r.Type ? r.Type.name : ''}</td>
                <td>${r.note || ''}</td>
                <td>${r.amount}</td>
                <td><button class="button danger" onclick="delete${dataType.charAt(0).toUpperCase() + dataType.slice(1)}(${r.id})">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;font-weight:bold;">Total:</td>
              <td style="font-weight:bold;">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    `;
  });
  
  return html;
}

function switchDataTab(dataType, currency) {
  window[`${dataType}ActiveTab`] = currency;
  if (dataType === 'income') renderIncomeView('tabs');
  if (dataType === 'expense') renderExpenseView('tabs');
}

function renderDataColumns(dataGroups, dataType, icon) {
  const stateKey = `${dataType}ColumnState`;
  let html = '<div class="currency-columns">';
  Object.keys(dataGroups).forEach(currency => {
    const records = dataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const expanded = window[stateKey] && window[stateKey][currency];
    const displayRecords = expanded ? records : records.slice(0, 5);
    
    html += `
      <div class="currency-column">
        <div class="currency-column-header">
          <div class="currency-column-icon">${icon}</div>
          <div class="currency-column-title">${currency}</div>
        </div>
        <div class="currency-column-total">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
        <div class="column-records">
          ${displayRecords.map(r => `
            <div class="column-record">
              <div class="record-date">${r.date ? new Date(r.date).toLocaleDateString() : ''}</div>
              <div class="record-type">${r.Type ? r.Type.name : ''}</div>
              <div class="record-amount">${r.amount}</div>
            </div>
          `).join('')}
        </div>
        ${!expanded && records.length > 5 ? `
          <div class="column-see-all">
            <button onclick="toggleDataColumn('${dataType}', '${currency}')">See All ${records.length} Records</button>
          </div>
        ` : expanded ? `
          <div class="column-see-all">
            <button onclick="toggleDataColumn('${dataType}', '${currency}')">Show Less</button>
          </div>
        ` : ''}
      </div>
    `;
  });
  html += '</div>';
  return html;
}

function toggleDataColumn(dataType, currency) {
  const stateKey = `${dataType}ColumnState`;
  if (!window[stateKey]) window[stateKey] = {};
  window[stateKey][currency] = !window[stateKey][currency];
  if (dataType === 'income') renderIncomeView('columns');
  if (dataType === 'expense') renderExpenseView('columns');
}

function renderDataTimeline(dataGroups, dataType, icon) {
  const allRecords = [];
  Object.keys(dataGroups).forEach(currency => {
    dataGroups[currency].forEach(r => {
      allRecords.push({...r, currency});
    });
  });
  
  allRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const currencies = [...new Set(allRecords.map(r => r.currency))];
  const filterKey = `${dataType}TimelineFilters`;
  const activeFilters = window[filterKey] || currencies;
  
  let html = `
    <div class="timeline-view">
      <div class="timeline-filters">
        <button class="timeline-filter ${activeFilters.length === currencies.length ? 'active' : ''}" onclick="filterDataTimeline('${dataType}', 'all')">All</button>
        ${currencies.map(c => `
          <button class="timeline-filter ${activeFilters.includes(c) ? 'active' : ''}" onclick="filterDataTimeline('${dataType}', '${c}')">${icon} ${c}</button>
        `).join('')}
      </div>
  `;
  
  const groupedByDate = {};
  const filteredRecords = allRecords.filter(r => activeFilters.includes(r.currency));
  
  filteredRecords.forEach(r => {
    const date = new Date(r.date);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    let group;
    if (date.toDateString() === today.toDateString()) {
      group = 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
      group = 'Yesterday';
    } else if (date >= new Date(today.setDate(today.getDate() - 7))) {
      group = 'This Week';
    } else {
      group = date.toLocaleDateString('en-US', {month: 'long', year: 'numeric'});
    }
    
    if (!groupedByDate[group]) groupedByDate[group] = [];
    groupedByDate[group].push(r);
  });
  
  Object.keys(groupedByDate).forEach(group => {
    html += `
      <div class="timeline-group">
        <div class="timeline-group-title">${group}</div>
        ${groupedByDate[group].map(r => `
          <div class="timeline-item">
            <div class="timeline-badge">${r.currency}</div>
            <div class="timeline-content">
              <div class="timeline-type">${r.Type ? r.Type.name : ''}</div>
              <div class="timeline-note">${r.note || 'No note'}</div>
            </div>
            <div class="timeline-amount">${r.amount}</div>
          </div>
        `).join('')}
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function filterDataTimeline(dataType, filter) {
  const dataGroups = dataType === 'income' ? window.incomeDataGroups : window.expenseDataGroups;
  const currencies = Object.keys(dataGroups);
  const filterKey = `${dataType}TimelineFilters`;
  
  if (filter === 'all') {
    window[filterKey] = currencies;
  } else {
    if (!window[filterKey]) window[filterKey] = currencies;
    if (window[filterKey].includes(filter)) {
      window[filterKey] = window[filterKey].filter(c => c !== filter);
      if (window[filterKey].length === 0) window[filterKey] = currencies;
    } else {
      window[filterKey].push(filter);
    }
  }
  
  if (dataType === 'income') renderIncomeView('timeline');
  if (dataType === 'expense') renderExpenseView('timeline');
}

function renderDataDashboard(dataGroups, dataType, icon, deleteFn) {
  const currencies = Object.keys(dataGroups);
  const currencyKey = `${dataType}DashboardCurrency`;
  const activeCurrency = window[currencyKey] || 'all';
  const allRecords = [];
  let grandTotal = 0;
  
  currencies.forEach(currency => {
    dataGroups[currency].forEach(r => {
      allRecords.push({...r, currency});
      grandTotal += r.amount;
    });
  });
  
  let html = `
    <div class="dashboard-view">
      <div class="dashboard-summary">
  `;
  
  currencies.forEach(currency => {
    const records = dataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    
    html += `
      <div class="dashboard-card ${activeCurrency === currency ? 'active' : ''}" onclick="selectDataDashboardCurrency('${dataType}', '${currency}')">
        <div class="dashboard-card-icon">${icon}</div>
        <div class="dashboard-card-currency">${currency}</div>
        <div class="dashboard-card-total">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
        <div class="dashboard-card-count">${records.length} records</div>
      </div>
    `;
  });
  
  html += `
      </div>
      <div class="dashboard-chart">
        <div class="dashboard-chart-title">${dataType === 'income' ? 'Income' : 'Expense'} Distribution by Currency</div>
        <div class="chart-bars">
  `;
  
  const maxTotal = Math.max(...currencies.map(c => dataGroups[c].reduce((sum, r) => sum + Number(r.amount), 0)));
  
  currencies.forEach(currency => {
    const records = dataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const percentage = (total / maxTotal * 100);
    
    html += `
      <div class="chart-bar-item">
        <div class="chart-bar-label">${currency}</div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill" style="width: ${percentage}%"></div>
        </div>
        <div class="chart-bar-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
      <div class="dashboard-data">
        <div class="dashboard-data-title">${activeCurrency === 'all' ? 'All Transactions' : activeCurrency + ' Transactions'}</div>
        <table class="${getCurrentTableTheme()}" style="width:100%;">
          <thead>
            <tr><th>Date</th><th>Currency</th><th>Type</th><th>Note</th><th>Amount</th><th>Action</th></tr>
          </thead>
          <tbody>
            ${(activeCurrency === 'all' ? allRecords : allRecords.filter(r => r.currency === activeCurrency)).map(r => `
              <tr>
                <td>${r.date ? new Date(r.date).toLocaleDateString() : ''}</td>
                <td>${r.currency}</td>
                <td>${r.Type ? r.Type.name : ''}</td>
                <td>${r.note || ''}</td>
                <td>${r.amount}</td>
                <td><button class="button danger" onclick="${deleteFn}(${r.id})">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  return html;
}

function selectDataDashboardCurrency(dataType, currency) {
  window[`${dataType}DashboardCurrency`] = currency;
  if (dataType === 'income') renderIncomeView('dashboard');
  if (dataType === 'expense') renderExpenseView('dashboard');
}

// Infinite scroll event
document.getElementById('incomeGrid').addEventListener('scroll', function() {
  if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) fetchIncome();
});


    async function deleteIncome(id) {
      await authFetch('/income/' + id, { method: 'DELETE', credentials: 'include' });
      fetchIncome();
    }
    
document.getElementById('expenseForm').onsubmit = async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this));
  const res = await authFetch('/entries', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ ...data, category: 'expense' })
  });
  // Optionally show a result message
 const newItem = await res.json();
  document.getElementById('expenseResult').innerText = res.ok ? 'Expense added!' : (newItem.error || 'Failed to add expense');
  this.amount && (this.amount.value = '');
  this.note && (this.note.value = '');
  
  if (res.ok) {
    await showBalances();
    if (typeof fetchSavings === 'function') fetchSavings();
    // Refresh expense data and re-render
    await fetchExpenses({ reset: true });
  }
  //====================================================
  //expenseData.unshift(newItem);
  //renderExpenseGrid();
  //====================================================
//  document.getElementById('expenseResult').innerText = await res.text();
 // this.amount && (this.amount.value = '');
 // this.note && (this.note.value = '');
 // await showBalances();
 // if (typeof fetchSavings === 'function') fetchSavings();
  //fetchExpenses({ reset: true }); // Always reload the list to ensure types and data are up to date
};

    let expenseOffset = 0;
let expenseLimit = 50;
let expenseHasMore = true;
let expenseData = [];
let expenseIsLoading = false;

async function fetchExpenses({ reset = false } = {}) {
  if (!localStorage.getItem('jwtToken')) return; // <--- Add this line

  if (expenseIsLoading) return;
  expenseIsLoading = true;
  if (reset) {
    expenseOffset = 0; expenseHasMore = true; expenseData = [];
    document.getElementById('expenseGrid').innerHTML = '';
  }
  if (!expenseHasMore) return;
  try {
    const res = await authFetch(`/entries?category=expense&limit=${expenseLimit}&offset=${expenseOffset}`, { credentials: 'include' });
    if (res.status === 401) { forceLogoutOnError(); return; }
    const data = await res.json();
    if (data.length < expenseLimit) expenseHasMore = false;
    expenseData = expenseData.concat(data);
    expenseOffset += data.length;
    renderExpenseGrid();
  } catch (err) { forceLogoutOnError(); }
  finally { expenseIsLoading = false; }
}
function toggleExpenseGroup(currency) {
  if (!window.expenseGroupState) window.expenseGroupState = {};
  // Collapse if already expanded, else expand only this group
  window.expenseGroupState.expanded = (window.expenseGroupState.expanded === currency) ? null : currency;
  renderExpenseGrid();
}

function renderExpenseGrid() {
  window.expenseDataGroups = {};
  expenseData.forEach(i => {
    if (!window.expenseDataGroups[i.currency]) window.expenseDataGroups[i.currency] = [];
    window.expenseDataGroups[i.currency].push(i);
  });
  
  const view = localStorage.getItem('expenseView') || 'cards';
  renderExpenseView(view);
}

function changeExpenseView(view) {
  localStorage.setItem('expenseView', view);
  renderExpenseView(view);
}

function renderExpenseView(view) {
  if (!window.expenseDataGroups) return;
  
  const viewSwitcher = `
    <div class="data-view-switcher">
      <button class="data-view-btn ${view === 'cards' ? 'active' : ''}" onclick="changeExpenseView('cards')">ğŸƒ Cards</button>
      <button class="data-view-btn ${view === 'tabs' ? 'active' : ''}" onclick="changeExpenseView('tabs')">ğŸ“‘ Tabs</button>
      <button class="data-view-btn ${view === 'columns' ? 'active' : ''}" onclick="changeExpenseView('columns')">âš Columns</button>
      <button class="data-view-btn ${view === 'timeline' ? 'active' : ''}" onclick="changeExpenseView('timeline')">ğŸ“… Timeline</button>
      <button class="data-view-btn ${view === 'dashboard' ? 'active' : ''}" onclick="changeExpenseView('dashboard')">ğŸ“Š Dashboard</button>
    </div>
  `;
  
  let html = viewSwitcher;
  const dataType = 'expense';
  
  if (view === 'cards') {
    html += renderDataCards(window.expenseDataGroups, dataType, 'ğŸ’¸');
  } else if (view === 'tabs') {
    html += renderDataTabs(window.expenseDataGroups, dataType, 'ğŸ’¸');
  } else if (view === 'columns') {
    html += renderDataColumns(window.expenseDataGroups, dataType, 'ğŸ’¸');
  } else if (view === 'timeline') {
    html += renderDataTimeline(window.expenseDataGroups, dataType, 'ğŸ’¸');
  } else if (view === 'dashboard') {
    html += renderDataDashboard(window.expenseDataGroups, dataType, 'ğŸ’¸', 'deleteExpense');
  }
  
  document.getElementById('expenseGrid').innerHTML = html;
}

// Infinite scroll event
document.getElementById('expenseGrid').addEventListener('scroll', function() {
  if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) fetchExpenses();
});


    
    async function deleteExpense(id) {
      await authFetch('/expenses/' + id, { method: 'DELETE', credentials: 'include' });
      fetchExpenses();
    }
    
    // Types
    document.getElementById('typeForm').onsubmit = async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      const res = await authFetch('/types', {  // Corrected authfetch to authFetch
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        credentials: 'include'
      });
      document.getElementById('typeResult').innerText = await res.text();
    };
    let typeOffset = 0, typeLimit = 30, typeHasMore = true, typeIsLoading = false, typeData = [];

    async function fetchTypes({ reset = false } = {}) {
  if (typeIsLoading) return;
  typeIsLoading = true;
  if (reset) {
    typeOffset = 0; typeHasMore = true; typeData = [];
    document.getElementById('typeGrid').innerHTML = '';
  }
  if (!typeHasMore) return;
  try {
    const res = await authFetch(`/types?limit=${typeLimit}&offset=${typeOffset}`, { credentials: 'include' });
    if (res.status === 401) { forceLogoutOnError(); return; }
    const data = await res.json();
    if (data.length < typeLimit) typeHasMore = false;
    typeData = typeData.concat(data);
    typeOffset += data.length;
    renderTypeGridWithViews(); // Use new multi-view system
  } catch (err) { forceLogoutOnError(); }
  finally { typeIsLoading = false; }
}


// Infinite scroll event (disabled for multi-view - all types loaded at once)
/*document.getElementById('typeGrid').addEventListener('scroll', function() {
  if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) fetchTypes();
});*/

// On add new type
document.getElementById('typeForm').onsubmit = async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this));
  const res = await authFetch('/types', {  // Corrected authfetch to authFetch
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(data)
  });
  const newItem = await res.json();
  this.name.value = '';
  typeData.unshift(newItem); // Show new item instantly
  renderTypeGridWithViews(); // Use new multi-view system
};
    
    async function deleteType(id) {
      await authFetch('/types/' + id, { method: 'DELETE', credentials: 'include' }); // Corrected authfetch to authFetch
      typeData = typeData.filter(t => t.id !== id); // Remove from local data
      delete window.typeStatistics[id]; // Remove stats
      renderTypeView(); // Re-render current view
    }
    
    // Savings
    document.getElementById('savingsForm').onsubmit = async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      const res = await authFetch('/savings', {  // Corrected authfetch to authFetch
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(data)
      });
      document.getElementById('savingsResult').innerText = await res.text();
      this.amount.value = '';
      this.note.value = '';
      showBalances();
    };
    async function fetchSavings() {
      try {

        const res = await authFetch('/savings', { credentials: 'include' }); // Corrected authfetch to authFetch
        if (res.status === 401) {
          forceLogoutOnError();
          return;
        }
        const data = await res.json();
        let html = `<table class="${getCurrentTableTheme()}">
        <tr>
          <th>Date</th>
          <th>Note</th>
          <th>Amount</th>
          <th>Currency</th>
          <th>Action</th>
        </tr>`;
      data.forEach(i => {
        html += `<tr>
          <td>${i.date ? new Date(i.date).toLocaleDateString() : ''}</td>
          <td>${i.note || ''}</td>
          <td>${i.amount}</td>
          <td>${i.currency}</td>
          <td><button class="button danger" onclick="deleteSavings(${i.id})">Delete</button></td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById('savingsGrid').innerHTML = html;
    } catch (err) {
      forceLogoutOnError();
    }
    }
    async function deleteSavings(id) {
      await authFetch('/savings/' + id, { method: 'DELETE', credentials: 'include' });
     
      fetchSavings();
    }
    
    // Transfers
    document.getElementById('transferForm').onsubmit = async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      const res = await authFetch('/transfers', {  // Corrected authfetch to authFetch
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(data)
      });
      document.getElementById('transferResult').innerText = await res.text();
      this.amount.value = '';
      this.note.value = '';
      
      // Refresh balance display for the current currency in the transfers section
      const currentCurrency = getCurrency();
      showSectionBalances('transfers', currentCurrency);
      
      // Reload transfers immediately to show the new record
      await fetchTransfers({ reset: true });
      
      // Also refresh savings display if on savings section
      await fetchSavings({ reset: true });
    };
    let transferOffset = 0, transferLimit = 30, transferHasMore = true, transferIsLoading = false, transferData = [];

    async function fetchTransfers({ reset = false } = {}) {
  if (transferIsLoading) return;
  transferIsLoading = true;
  if (reset) {
    transferOffset = 0; transferHasMore = true; transferData = [];
    document.getElementById('transferGrid').innerHTML = '';
  }
 
  if (!transferHasMore) return;
  try {
const res = await authFetch(`/transfers?limit=${transferLimit}&offset=${transferOffset}`, { credentials: 'include' });
    if (res.status === 401) { forceLogoutOnError(); return; }
    const data = await res.json();
    if (data.length < transferLimit) transferHasMore = false;
    transferData = transferData.concat(data);
    transferOffset += data.length;
    renderTransferGrid();
  } catch (err) { forceLogoutOnError(); }
  finally { transferIsLoading = false; }
}

function renderTransferGrid() {
  // Group transfers by currency
  window.transferDataGroups = {};
  transferData.forEach(t => {
    if (!window.transferDataGroups[t.currency]) window.transferDataGroups[t.currency] = [];
    window.transferDataGroups[t.currency].push(t);
  });
  
  const view = localStorage.getItem('transferView') || 'cards';
  renderTransferView(view);
}

function changeTransferView(view) {
  localStorage.setItem('transferView', view);
  renderTransferView(view);
}

function renderTransferView(view) {
  const viewSwitcher = `
    <div class="data-view-switcher">
      <button class="data-view-btn ${view === 'cards' ? 'active' : ''}" onclick="changeTransferView('cards')">ğŸƒ Cards</button>
      <button class="data-view-btn ${view === 'tabs' ? 'active' : ''}" onclick="changeTransferView('tabs')">ğŸ“‘ Tabs</button>
      <button class="data-view-btn ${view === 'columns' ? 'active' : ''}" onclick="changeTransferView('columns')">âš Columns</button>
      <button class="data-view-btn ${view === 'timeline' ? 'active' : ''}" onclick="changeTransferView('timeline')">ğŸ“… Timeline</button>
      <button class="data-view-btn ${view === 'dashboard' ? 'active' : ''}" onclick="changeTransferView('dashboard')">ğŸ“Š Dashboard</button>
    </div>
  `;
  
  let html = viewSwitcher;
  
  if (view === 'cards') {
    html += renderTransferCards();
  } else if (view === 'tabs') {
    html += renderTransferTabs();
  } else if (view === 'columns') {
    html += renderTransferColumns();
  } else if (view === 'timeline') {
    html += renderTransferTimeline();
  } else if (view === 'dashboard') {
    html += renderTransferDashboard();
  }
  
  document.getElementById('transferGrid').innerHTML = html;
}

function renderTransferCards() {
  const stateKey = 'transferCardState';
  let html = '<div class="currency-cards">';
  Object.keys(window.transferDataGroups).forEach(currency => {
    const records = window.transferDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const avg = total / records.length;
    const toSavings = records.filter(r => r.from_account === 'Balance').length;
    const fromSavings = records.filter(r => r.from_account === 'Savings').length;
    const expanded = window[stateKey] && window[stateKey][currency];
    
    html += `
      <div class="currency-card">
        <div class="currency-card-header">
          <div class="currency-card-icon">ğŸ¦</div>
          <div class="currency-card-title">
            <div class="currency-card-name">${currency}</div>
            <div class="currency-card-count">${records.length} transfers</div>
          </div>
        </div>
        <div class="currency-card-stats">
          <div class="stat-item" title="Variable: total (${currency})&#10;Formula: SUM of all transfer amounts&#10;Value: ${total}">
            <div class="stat-label">Total Moved</div>
            <div class="stat-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="stat-item" title="Variable: toSavings (${currency})&#10;Formula: COUNT where from_account = 'Balance'&#10;Value: ${toSavings}">
            <div class="stat-label">To Savings</div>
            <div class="stat-value">${toSavings}</div>
          </div>
          <div class="stat-item" title="Variable: fromSavings (${currency})&#10;Formula: COUNT where from_account = 'Savings'&#10;Value: ${fromSavings}">
            <div class="stat-label">From Savings</div>
            <div class="stat-value">${fromSavings}</div>
          </div>
        </div>
        <div class="currency-card-toggle" onclick="toggleTransferCard('${currency}')">
          ${expanded ? 'â–² Hide Details' : 'â–¼ Show Details'}
        </div>
        <div class="currency-card-details ${expanded ? 'expanded' : ''}">
          <table class="${getCurrentTableTheme()}" style="width:100%;font-size:0.9em;">
            <thead>
              <tr><th>Date</th><th>From</th><th>To</th><th>Amount</th></tr>
            </thead>
            <tbody>
              ${records.slice(0, 5).map(r => `
                <tr>
                  <td>${r.date ? new Date(r.date).toLocaleDateString() : ''}</td>
                  <td>${r.from_account}</td>
                  <td>${r.to_account}</td>
                  <td>${r.amount}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  });
  html += '</div>';
  return html;
}

function toggleTransferCard(currency) {
  if (!window.transferCardState) window.transferCardState = {};
  window.transferCardState[currency] = !window.transferCardState[currency];
  renderTransferView('cards');
}

function renderTransferTabs() {
  const currencies = Object.keys(window.transferDataGroups);
  const activeTab = window.transferActiveTab || currencies[0];
  
  let html = '<div class="currency-tabs">';
  currencies.forEach(currency => {
    const records = window.transferDataGroups[currency];
    html += `<button class="currency-tab ${activeTab === currency ? 'active' : ''}" onclick="switchTransferTab('${currency}')">ğŸ¦ ${currency} (${records.length})</button>`;
  });
  html += '</div>';
  
  currencies.forEach(currency => {
    const records = window.transferDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const toSavings = records.filter(r => r.from_account === 'Balance').length;
    const fromSavings = records.filter(r => r.from_account === 'Savings').length;
    
    html += `
      <div class="currency-tab-content ${activeTab === currency ? 'active' : ''}">
        <div class="currency-summary">
          <div class="summary-stat">
            <div class="summary-label">Total Transferred</div>
            <div class="summary-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
          </div>
          <div class="summary-stat">
            <div class="summary-label">To Savings</div>
            <div class="summary-value">${toSavings}</div>
          </div>
          <div class="summary-stat">
            <div class="summary-label">From Savings</div>
            <div class="summary-value">${fromSavings}</div>
          </div>
        </div>
        <table class="${getCurrentTableTheme()}" style="width:100%;">
          <thead>
            <tr><th>Date</th><th>From</th><th>To</th><th>Amount</th><th>Note</th><th>Action</th></tr>
          </thead>
          <tbody>
            ${records.map(r => `
              <tr>
                <td>${r.date ? new Date(r.date).toLocaleDateString() : ''}</td>
                <td>${r.from_account}</td>
                <td>${r.to_account}</td>
                <td>${r.amount}</td>
                <td>${r.note || ''}</td>
                <td><button class="button danger" onclick="deleteTransfer(${r.id})">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;font-weight:bold;">Total:</td>
              <td style="font-weight:bold;">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    `;
  });
  
  return html;
}

function switchTransferTab(currency) {
  window.transferActiveTab = currency;
  renderTransferView('tabs');
}

function renderTransferColumns() {
  let html = '<div class="currency-columns">';
  Object.keys(window.transferDataGroups).forEach(currency => {
    const records = window.transferDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const expanded = window.transferColumnState && window.transferColumnState[currency];
    const displayRecords = expanded ? records : records.slice(0, 5);
    
    html += `
      <div class="currency-column">
        <div class="currency-column-header">
          <div class="currency-column-icon">ğŸ¦</div>
          <div class="currency-column-title">${currency}</div>
        </div>
        <div class="currency-column-total">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
        <div class="column-records">
          ${displayRecords.map(r => `
            <div class="column-record">
              <div class="record-date">${r.date ? new Date(r.date).toLocaleDateString() : ''}</div>
              <div class="record-type">${r.from_account} â†’ ${r.to_account}</div>
              <div class="record-amount">${r.amount}</div>
            </div>
          `).join('')}
        </div>
        ${!expanded && records.length > 5 ? `
          <div class="column-see-all">
            <button onclick="toggleTransferColumn('${currency}')">See All ${records.length} Transfers</button>
          </div>
        ` : expanded ? `
          <div class="column-see-all">
            <button onclick="toggleTransferColumn('${currency}')">Show Less</button>
          </div>
        ` : ''}
      </div>
    `;
  });
  html += '</div>';
  return html;
}

function toggleTransferColumn(currency) {
  if (!window.transferColumnState) window.transferColumnState = {};
  window.transferColumnState[currency] = !window.transferColumnState[currency];
  renderTransferView('columns');
}

function renderTransferTimeline() {
  const allRecords = [];
  Object.keys(window.transferDataGroups).forEach(currency => {
    window.transferDataGroups[currency].forEach(r => {
      allRecords.push({...r, currency});
    });
  });
  
  allRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const currencies = [...new Set(allRecords.map(r => r.currency))];
  const activeFilters = window.transferTimelineFilters || currencies;
  
  let html = `
    <div class="timeline-view">
      <div class="timeline-filters">
        <button class="timeline-filter ${activeFilters.length === currencies.length ? 'active' : ''}" onclick="filterTransferTimeline('all')">All</button>
        ${currencies.map(c => `
          <button class="timeline-filter ${activeFilters.includes(c) ? 'active' : ''}" onclick="filterTransferTimeline('${c}')">ğŸ¦ ${c}</button>
        `).join('')}
      </div>
  `;
  
  const groupedByDate = {};
  const filteredRecords = allRecords.filter(r => activeFilters.includes(r.currency));
  
  filteredRecords.forEach(r => {
    const date = new Date(r.date);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    let group;
    if (date.toDateString() === today.toDateString()) {
      group = 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
      group = 'Yesterday';
    } else if (date >= new Date(today.setDate(today.getDate() - 7))) {
      group = 'This Week';
    } else {
      group = date.toLocaleDateString('en-US', {month: 'long', year: 'numeric'});
    }
    
    if (!groupedByDate[group]) groupedByDate[group] = [];
    groupedByDate[group].push(r);
  });
  
  Object.keys(groupedByDate).forEach(group => {
    html += `
      <div class="timeline-group">
        <div class="timeline-group-title">${group}</div>
        ${groupedByDate[group].map(r => `
          <div class="timeline-item">
            <div class="timeline-badge">${r.currency}</div>
            <div class="timeline-content">
              <div class="timeline-type">${r.from_account} â†’ ${r.to_account}</div>
              <div class="timeline-note">${r.note || 'No note'}</div>
            </div>
            <div class="timeline-amount">${r.amount}</div>
          </div>
        `).join('')}
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function filterTransferTimeline(filter) {
  const currencies = Object.keys(window.transferDataGroups);
  
  if (filter === 'all') {
    window.transferTimelineFilters = currencies;
  } else {
    if (!window.transferTimelineFilters) window.transferTimelineFilters = currencies;
    if (window.transferTimelineFilters.includes(filter)) {
      window.transferTimelineFilters = window.transferTimelineFilters.filter(c => c !== filter);
      if (window.transferTimelineFilters.length === 0) window.transferTimelineFilters = currencies;
    } else {
      window.transferTimelineFilters.push(filter);
    }
  }
  
  renderTransferView('timeline');
}

function renderTransferDashboard() {
  const currencies = Object.keys(window.transferDataGroups);
  const activeCurrency = window.transferDashboardCurrency || 'all';
  const allRecords = [];
  
  currencies.forEach(currency => {
    window.transferDataGroups[currency].forEach(r => {
      allRecords.push({...r, currency});
    });
  });
  
  let html = `
    <div class="dashboard-view">
      <div class="dashboard-summary">
  `;
  
  currencies.forEach(currency => {
    const records = window.transferDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    
    html += `
      <div class="dashboard-card ${activeCurrency === currency ? 'active' : ''}" onclick="selectTransferDashboardCurrency('${currency}')">
        <div class="dashboard-card-icon">ğŸ¦</div>
        <div class="dashboard-card-currency">${currency}</div>
        <div class="dashboard-card-total">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
        <div class="dashboard-card-count">${records.length} transfers</div>
      </div>
    `;
  });
  
  html += `
      </div>
      <div class="dashboard-chart">
        <div class="dashboard-chart-title">Transfer Volume by Currency</div>
        <div class="chart-bars">
  `;
  
  const maxTotal = Math.max(...currencies.map(c => window.transferDataGroups[c].reduce((sum, r) => sum + Number(r.amount), 0)));
  
  currencies.forEach(currency => {
    const records = window.transferDataGroups[currency];
    const total = records.reduce((sum, r) => sum + Number(r.amount), 0);
    const percentage = (total / maxTotal * 100);
    
    html += `
      <div class="chart-bar-item">
        <div class="chart-bar-label">${currency}</div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill" style="width: ${percentage}%"></div>
        </div>
        <div class="chart-bar-value">${total.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
      <div class="dashboard-data">
        <div class="dashboard-data-title">${activeCurrency === 'all' ? 'All Transfers' : activeCurrency + ' Transfers'}</div>
        <table class="${getCurrentTableTheme()}" style="width:100%;">
          <thead>
            <tr><th>Date</th><th>Currency</th><th>From</th><th>To</th><th>Amount</th><th>Note</th><th>Action</th></tr>
          </thead>
          <tbody>
            ${(activeCurrency === 'all' ? allRecords : allRecords.filter(r => r.currency === activeCurrency)).map(r => `
              <tr>
                <td>${r.date ? new Date(r.date).toLocaleDateString() : ''}</td>
                <td>${r.currency}</td>
                <td>${r.from_account}</td>
                <td>${r.to_account}</td>
                <td>${r.amount}</td>
                <td>${r.note || ''}</td>
                <td><button class="button danger" onclick="deleteTransfer(${r.id})">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  return html;
}

function selectTransferDashboardCurrency(currency) {
  window.transferDashboardCurrency = currency;
  renderTransferView('dashboard');
}

// Place these in your main script block in index.html (or in menu.js if you prefer)

//let typeData = [];
//let typeIsLoading = false;



// Render expandable, scrollable type groups with Clusterize.js
function renderTypeGrid() {
  // Group types by category
  const groups = {};
  typeData.forEach(type => {
    if (!groups[type.category]) groups[type.category] = [];
    groups[type.category].push(type);
  });

  if (!window.typeGroupState) window.typeGroupState = {};

  let html = `<div class="type-groups" style="margin-top:1em;">`;
  Object.keys(groups).forEach(category => {
    const expanded = !!window.typeGroupState[category];
    const count = groups[category].length;
    html += `
      <div class="type-group" style="margin-bottom:1em;">
        <div class="type-group-header"
          style="cursor:pointer;display:flex;align-items:center;gap:0.7em;font-size:1.1em;font-weight:bold;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);color:white;padding:0.9em 1.3em;border-radius:14px;box-shadow:0 4px 12px rgba(102,126,234,0.25);transition:background 0.2s,transform 0.2s;"
          onclick="expandTypeGroup('${category}')"
        >
          <span style="font-size:2em;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));">${category === 'income' ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
          <span style="font-size:1.2em;letter-spacing:1px;text-transform:capitalize;">${category} (${count})</span>
          <span style="margin-left:auto;display:flex;align-items:center;">
            <svg width="32" height="32" viewBox="0 0 24 24" style="transition:transform 0.4s cubic-bezier(.4,0,.2,1);transform:${expanded ? 'rotate(90deg)' : 'rotate(0deg)'}">
              <defs>
                <linearGradient id="arrowGradientType${category}" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#ffffff"/>
                  <stop offset="100%" stop-color="#f0f0f0"/>
                </linearGradient>
              </defs>
              <polyline points="6 9 12 15 18 9" fill="none" stroke="url(#arrowGradientType${category})" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </div>
        <div class="type-group-body${expanded ? ' expanded' : ''}" style="overflow:hidden;${expanded ? '' : 'max-height:0;'}">
          <div class="type-group-inner">
            <div id="typeClusterizeScroll_${category}" class="clusterize-scroll" style="max-height:350px;overflow:auto;">
              <table class="${getCurrentTableTheme()}" style="width:100%;">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="typeClusterizeContent_${category}" class="clusterize-content"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  html += `</div>`;
  document.getElementById('typeGrid').innerHTML = html;

  // Initialize Clusterize for each expanded group

  Object.keys(groups).forEach(category => {
    if (window.typeGroupState[category]) {
      const rows = groups[category].map(i => `
        <tr>
          <td>${i.name}</td>
          <td>${i.category}</td>
          <td><button class="button danger" onclick="deleteType(${i.id})">Delete</button></td>
        </tr>
      `);
      new Clusterize({
        rows,
        scrollId: `typeClusterizeScroll_${category}`,
        contentId: `typeClusterizeContent_${category}`
      });
    }
  });
}

// Expand/collapse logic for type groups (only one open at a time)

function expandTypeGroup(category) {
  if (!window.typeGroupState) window.typeGroupState = {};
  const wasOpen = !!window.typeGroupState[category];
  // Collapse all groups
  Object.keys(window.typeGroupState).forEach(k => window.typeGroupState[k] = false);
  // Toggle: expand if not open, collapse if open
  if (!wasOpen) window.typeGroupState[category] = true;
  renderTypeGrid(); // <-- Only re-render, do NOT fetch again
}

// ==================== Types Multi-View System ====================

// Calculate usage statistics for types (per currency)
async function calculateTypeStatistics() {
  if (!window.typeStatistics) {
    window.typeStatistics = {};
  }
  
  // Fetch income and expense entries
  const [incomeResponse, expenseResponse] = await Promise.all([
    authFetch('/entries?category=income'),
    authFetch('/entries?category=expense')
  ]);
  
  const incomeEntries = await incomeResponse.json();
  const expenseEntries = await expenseResponse.json();
  
  // Initialize stats for all types with currency breakdown
  typeData.forEach(type => {
    window.typeStatistics[type.id] = {
      currencies: {}, // Store stats per currency
      totalUsageCount: 0,
      lastUsed: null,
      firstUsed: null
    };
  });
  
  // Process income entries
  incomeEntries.forEach(entry => {
    if (entry.typeId && window.typeStatistics[entry.typeId]) {
      const stats = window.typeStatistics[entry.typeId];
      const currency = entry.currency;
      
      // Initialize currency stats if not exists
      if (!stats.currencies[currency]) {
        stats.currencies[currency] = {
          usageCount: 0,
          totalAmount: 0,
          avgAmount: 0,
          entries: []
        };
      }
      
      // Update currency-specific stats
      const currencyStats = stats.currencies[currency];
      currencyStats.usageCount++;
      currencyStats.totalAmount += Number(entry.amount) || 0;
      currencyStats.entries.push(entry);
      
      // Update total usage count
      stats.totalUsageCount++;
      
      // Update dates
      const entryDate = new Date(entry.date);
      if (!stats.lastUsed || entryDate > new Date(stats.lastUsed)) {
        stats.lastUsed = entry.date;
      }
      if (!stats.firstUsed || entryDate < new Date(stats.firstUsed)) {
        stats.firstUsed = entry.date;
      }
    }
  });
  
  // Process expense entries
  expenseEntries.forEach(entry => {
    if (entry.typeId && window.typeStatistics[entry.typeId]) {
      const stats = window.typeStatistics[entry.typeId];
      const currency = entry.currency;
      
      // Initialize currency stats if not exists
      if (!stats.currencies[currency]) {
        stats.currencies[currency] = {
          usageCount: 0,
          totalAmount: 0,
          avgAmount: 0,
          entries: []
        };
      }
      
      // Update currency-specific stats
      const currencyStats = stats.currencies[currency];
      currencyStats.usageCount++;
      currencyStats.totalAmount += Number(entry.amount) || 0;
      currencyStats.entries.push(entry);
      
      // Update total usage count
      stats.totalUsageCount++;
      
      // Update dates
      const entryDate = new Date(entry.date);
      if (!stats.lastUsed || entryDate > new Date(stats.lastUsed)) {
        stats.lastUsed = entry.date;
      }
      if (!stats.firstUsed || entryDate < new Date(stats.firstUsed)) {
        stats.firstUsed = entry.date;
      }
    }
  });
  
  // Calculate averages per currency
  Object.keys(window.typeStatistics).forEach(typeId => {
    const stats = window.typeStatistics[typeId];
    Object.keys(stats.currencies).forEach(currency => {
      const currencyStats = stats.currencies[currency];
      if (currencyStats.usageCount > 0) {
        currencyStats.avgAmount = currencyStats.totalAmount / currencyStats.usageCount;
      }
    });
  });
}

// Change type view
function changeTypeView(view) {
  localStorage.setItem('typeView', view);
  renderTypeView(view);
}

// Main render function that routes to appropriate view
async function renderTypeView(view) {
  const selectedView = view || localStorage.getItem('typeView') || 'list';
  
  // Calculate statistics if not already done
  if (!window.typeStatistics) {
    await calculateTypeStatistics();
  }
  
  let html = `
    <div class="type-view-switcher">
      <button class="type-view-btn ${selectedView === 'cards' ? 'active' : ''}" onclick="changeTypeView('cards')">ğŸƒ Cards</button>
      <button class="type-view-btn ${selectedView === 'table' ? 'active' : ''}" onclick="changeTypeView('table')">ğŸ“‹ Table</button>
      <button class="type-view-btn ${selectedView === 'stats' ? 'active' : ''}" onclick="changeTypeView('stats')">ğŸ“Š Stats</button>
      <button class="type-view-btn ${selectedView === 'list' ? 'active' : ''}" onclick="changeTypeView('list')">ğŸ“ List</button>
    </div>
  `;
  
  if (typeData.length === 0) {
    html += `
      <div class="type-empty-state">
        <div class="type-empty-icon">ğŸ“‹</div>
        <div class="type-empty-text">No types created yet</div>
        <div class="type-empty-hint">Create your first income or expense type using the form above</div>
      </div>
    `;
  } else {
    switch (selectedView) {
      case 'cards':
        html += renderTypeCards();
        break;
      case 'table':
        html += renderTypeTable();
        break;
      case 'stats':
        html += renderTypeStats();
        break;
      case 'list':
      default:
        html += renderTypeList();
        break;
    }
  }
  
  document.getElementById('typeGrid').innerHTML = html;
}

// Cards View
function renderTypeCards() {
  let html = '<div class="type-cards">';
  
  typeData.forEach(type => {
    const stats = window.typeStatistics[type.id] || { totalUsageCount: 0, currencies: {}, lastUsed: null };
    const icon = type.category === 'income' ? 'ğŸŸ¢' : 'ğŸ”´';
    const cardClass = type.category === 'income' ? 'income-type' : 'expense-type';
    const lastUsedText = stats.lastUsed ? new Date(stats.lastUsed).toLocaleDateString() : 'Never';
    
    // Build currency breakdown
    const currencies = Object.keys(stats.currencies);
    let currencyBreakdown = '';
    
    if (currencies.length > 0) {
      currencyBreakdown = currencies.map(currency => {
        const currStats = stats.currencies[currency];
        return `
          <div style="margin-top:1em;padding-top:1em;border-top:1px solid rgba(102,126,234,0.1);">
            <div style="font-weight:700;color:#667eea;margin-bottom:0.5em;">ğŸ’µ ${currency}</div>
            <div class="type-card-stats">
              <div class="type-stat">
                <div class="type-stat-label">Times Used</div>
                <div class="type-stat-value">${currStats.usageCount}</div>
              </div>
              <div class="type-stat">
                <div class="type-stat-label">Total Amount</div>
                <div class="type-stat-value amount">${currStats.totalAmount.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
              </div>
              <div class="type-stat">
                <div class="type-stat-label">Avg Amount</div>
                <div class="type-stat-value amount">${currStats.avgAmount.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    html += `
      <div class="type-card ${cardClass}">
        <div class="type-card-header">
          <div class="type-card-icon">${icon}</div>
          <div class="type-card-title">
            <div class="type-card-name">${type.name}</div>
            <div class="type-card-category">${type.category}</div>
          </div>
          <div class="type-card-badge">${stats.totalUsageCount > 0 ? 'ğŸ”¥ Active' : 'ğŸ’¤ Unused'}</div>
        </div>
        
        ${type.description ? `<div class="type-card-description">"${type.description}"</div>` : '<div class="type-card-description" style="opacity:0.5;">No description</div>'}
        
        <div class="type-card-stats">
          <div class="type-stat">
            <div class="type-stat-label">Total Uses</div>
            <div class="type-stat-value">${stats.totalUsageCount}</div>
          </div>
          <div class="type-stat">
            <div class="type-stat-label">Currencies</div>
            <div class="type-stat-value">${currencies.length}</div>
          </div>
          <div class="type-stat">
            <div class="type-stat-label">Last Used</div>
            <div class="type-stat-value" style="font-size:0.9em;">${lastUsedText.split('/').slice(0,2).join('/')}</div>
          </div>
        </div>
        
        ${currencyBreakdown}
        
        <div class="type-card-footer" style="margin-top:1em;">
          <div class="type-card-actions" style="margin-left:auto;">
            <button class="button danger" onclick="deleteType(${type.id})" style="padding:0.4em 1em;font-size:0.9em;">Delete</button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

// Table View
function renderTypeTable() {
  let html = `
    <div class="type-table-view">
      <table class="type-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Category</th>
            <th>Description</th>
            <th>Currency</th>
            <th>Usage Count</th>
            <th>Total Amount</th>
            <th>Avg Amount</th>
            <th>Last Used</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  typeData.forEach(type => {
    const stats = window.typeStatistics[type.id] || { totalUsageCount: 0, currencies: {}, lastUsed: null };
    const icon = type.category === 'income' ? 'ğŸŸ¢' : 'ğŸ”´';
    const lastUsedText = stats.lastUsed ? new Date(stats.lastUsed).toLocaleDateString() : 'Never';
    const currencies = Object.keys(stats.currencies);
    
    if (currencies.length === 0) {
      // Type never used
      html += `
        <tr>
          <td>
            <div class="type-table-name">
              <span class="type-table-icon">${icon}</span>
              ${type.name}
            </div>
          </td>
          <td><span class="type-table-category ${type.category}">${type.category}</span></td>
          <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${type.description || '-'}</td>
          <td>-</td>
          <td><span class="type-usage-count">0</span></td>
          <td><span class="type-amount">0.00</span></td>
          <td>0.00</td>
          <td style="color:#888;">Never</td>
          <td><button class="button danger" onclick="deleteType(${type.id})">Delete</button></td>
        </tr>
      `;
    } else {
      // Show one row per currency
      currencies.forEach((currency, index) => {
        const currStats = stats.currencies[currency];
        html += `
          <tr>
            ${index === 0 ? `
            <td rowspan="${currencies.length}">
              <div class="type-table-name">
                <span class="type-table-icon">${icon}</span>
                ${type.name}
              </div>
            </td>
            <td rowspan="${currencies.length}"><span class="type-table-category ${type.category}">${type.category}</span></td>
            <td rowspan="${currencies.length}" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${type.description || '-'}</td>
            ` : ''}
            <td><strong>${currency}</strong></td>
            <td><span class="type-usage-count">${currStats.usageCount}</span></td>
            <td><span class="type-amount">${currStats.totalAmount.toLocaleString(undefined, {minimumFractionDigits:2})}</span></td>
            <td>${currStats.avgAmount.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
            ${index === 0 ? `
            <td rowspan="${currencies.length}" style="color:#888;">${lastUsedText}</td>
            <td rowspan="${currencies.length}"><button class="button danger" onclick="deleteType(${type.id})">Delete</button></td>
            ` : ''}
          </tr>
        `;
      });
    }
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  return html;
}

// Stats/Analytics View
function renderTypeStats() {
  // Calculate overall statistics
  const incomeTypes = typeData.filter(t => t.category === 'income');
  const expenseTypes = typeData.filter(t => t.category === 'expense');
  
  const usedTypes = typeData.filter(t => (window.typeStatistics[t.id]?.totalUsageCount || 0) > 0).length;
  const unusedTypes = typeData.length - usedTypes;
  
  // Get top 5 by total usage count (across all currencies)
  const topByUsage = [...typeData]
    .map(t => ({ ...t, stats: window.typeStatistics[t.id] }))
    .sort((a, b) => (b.stats?.totalUsageCount || 0) - (a.stats?.totalUsageCount || 0))
    .slice(0, 5);
  
  // Get top 5 by amount - group by currency
  // Create array of [type, currency, amount] tuples
  const typeAmounts = [];
  typeData.forEach(type => {
    const stats = window.typeStatistics[type.id];
    if (stats && stats.currencies) {
      Object.keys(stats.currencies).forEach(currency => {
        typeAmounts.push({
          type,
          currency,
          amount: stats.currencies[currency].totalAmount
        });
      });
    }
  });
  const topByAmount = typeAmounts
    .sort((a, b) => b.amount - a.amount)
    .slice(0, 5);
  
  let html = `
    <div class="type-stats-view">
      <div class="type-stats-grid">
        <div class="type-stat-card">
          <div class="type-stat-card-icon">ğŸ“Š</div>
          <div class="type-stat-card-label">Total Types</div>
          <div class="type-stat-card-value">${typeData.length}</div>
        </div>
        <div class="type-stat-card">
          <div class="type-stat-card-icon">âœ…</div>
          <div class="type-stat-card-label">Active Types</div>
          <div class="type-stat-card-value">${usedTypes}</div>
        </div>
        <div class="type-stat-card">
          <div class="type-stat-card-icon">ğŸ’¤</div>
          <div class="type-stat-card-label">Unused Types</div>
          <div class="type-stat-card-value">${unusedTypes}</div>
        </div>
      </div>
      
      <div class="type-charts-section">
        <div class="type-chart-title">ğŸ“ˆ Top 5 Types by Usage</div>
        <div class="type-chart-bars">
  `;
  
  const maxUsage = topByUsage[0]?.stats?.totalUsageCount || 1;
  topByUsage.forEach(type => {
    const count = type.stats?.totalUsageCount || 0;
    const percentage = (count / maxUsage) * 100;
    const icon = type.category === 'income' ? 'ğŸŸ¢' : 'ğŸ”´';
    const currencies = type.stats?.currencies ? Object.keys(type.stats.currencies).join(', ') : '';
    
    html += `
      <div class="type-chart-bar">
        <div class="type-chart-label">${icon} ${type.name}${currencies ? ` (${currencies})` : ''}</div>
        <div class="type-chart-container">
          <div class="type-chart-fill ${type.category}" style="width: ${percentage}%">${count}</div>
        </div>
        <div class="type-chart-value">${count} times</div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
      
      <div class="type-charts-section">
        <div class="type-chart-title">ğŸ’° Top 5 Types by Amount (per Currency)</div>
        <div class="type-chart-bars">
  `;
  
  const maxAmount = topByAmount[0]?.amount || 1;
  topByAmount.forEach(item => {
    const amount = item.amount || 0;
    const percentage = (amount / maxAmount) * 100;
    const icon = item.type.category === 'income' ? 'ğŸŸ¢' : 'ğŸ”´';
    
    html += `
      <div class="type-chart-bar">
        <div class="type-chart-label">${icon} ${item.type.name} <span style="font-size:0.85em;color:#888;">(${item.currency})</span></div>
        <div class="type-chart-container">
          <div class="type-chart-fill ${item.type.category}" style="width: ${percentage}%">${amount.toLocaleString(undefined, {minimumFractionDigits:0})}</div>
        </div>
        <div class="type-chart-value">${amount.toLocaleString(undefined, {minimumFractionDigits:2})} ${item.currency}</div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
    </div>
  `;
  
  return html;
}

// List View (Enhanced version of current view)
function renderTypeList() {
  const groups = {};
  typeData.forEach(type => {
    if (!groups[type.category]) groups[type.category] = [];
    groups[type.category].push(type);
  });
  
  let html = '<div class="type-list-view">';
  
  Object.keys(groups).forEach(category => {
    const count = groups[category].length;
    const icon = category === 'income' ? 'ğŸŸ¢' : 'ğŸ”´';
    
    html += `
      <div class="type-list-category">
        <div class="type-list-header">
          <span class="type-list-icon">${icon}</span>
          <span style="text-transform:capitalize;">${category} Types (${count})</span>
        </div>
        <div class="type-list-items">
    `;
    
    groups[category].forEach(type => {
      const stats = window.typeStatistics[type.id] || { totalUsageCount: 0, currencies: {} };
      const currenciesUsed = Object.keys(stats.currencies);
      const usageText = stats.totalUsageCount > 0 
        ? `Used ${stats.totalUsageCount} times${currenciesUsed.length > 0 ? ` (${currenciesUsed.join(', ')})` : ''}`
        : 'Never used';
      
      html += `
        <div class="type-list-item">
          <div>
            <div class="type-list-item-name">${type.name}</div>
            ${type.description ? `<div class="type-list-item-description">${type.description}</div>` : ''}
            <div class="type-list-item-description" style="color:#667eea;font-weight:600;">${usageText}</div>
          </div>
          <button class="button danger" onclick="deleteType(${type.id})" style="padding:0.5em 1em;">Delete</button>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

// Modify existing renderTypeGrid to use multi-view
async function renderTypeGridWithViews() {
  await calculateTypeStatistics();
  renderTypeView();
}

// ==================== End Types Multi-View System ====================

/*function expandTypeGroup(category) {
  if (!window.typeGroupState) window.typeGroupState = {};
  const wasOpen = !!window.typeGroupState[category];
  // Collapse all groups
  Object.keys(window.typeGroupState).forEach(k => window.typeGroupState[k] = false);
  // Toggle: expand if not open, collapse if open
  if (!wasOpen) window.typeGroupState[category] = true;
  fetchTypes();
}*/


// Infinite scroll event
document.getElementById('transferGrid').addEventListener('scroll', function() {
  if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) fetchTransfers();
});

// On add new transfer
document.getElementById('transferForm').onsubmit = async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this));
  try {
    const res = await authFetch('/transfers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      const error = await res.json();
      alert('Error: ' + (error.error || 'Failed to create transfer'));
      return;
    }
    const newItem = await res.json();
    this.amount.value = '';
    this.note.value = '';
    
    // Refresh all related data
    await fetchTransfers({ reset: true }); // Reload all transfers to show the new record at the top
    showSectionBalances('transfers', getCurrency()); // Refresh balance display
    await fetchSavings({ reset: true }); // Refresh savings
  } catch (err) {
    console.error('Transfer error:', err);
    alert('Failed to create transfer');
  }
};
   
    async function deleteTransfer(id) {
      await authFetch('/transfers/' + id, { method: 'DELETE', credentials: 'include' });
      fetchTransfers();
    }
    
    function getCurrentTableTheme() {
      // Returns the current table theme class based on the selected theme
      const theme = localStorage.getItem('appTheme') || 'fancy-table';
      return theme;
    }
    
    async function showSectionBalances(section, currency) {
      // Fetch and display balances for the section including transfer information
      const currentMonth = getCurrentMonthStr();
      
      try {
        const res = await authFetch('/balances?month=' + currentMonth, { credentials: 'include' });
        const balances = await res.json();
        
        if (!Array.isArray(balances) || balances.length === 0) {
          return;
        }
        
        // Find the balance for the current currency
        const balanceData = balances.find(b => b.currency === currency);
        if (!balanceData) return;
        
        let html = `
          <div style="background:#f5f5f5; padding:1em; border-radius:8px; margin-bottom:1em;">
            <h3 style="margin-top:0; color:#333;">Current Month Overview (${currency})</h3>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1em; margin-bottom:1em;">
              <div>
                <strong>Initial Balance:</strong>
                <div style="font-size:1.2em; color:#2196f3;">${balanceData.initialBalance?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
              </div>
              <div>
                <strong>Money on Hand:</strong>
                <div style="font-size:1.2em; color:#4caf50;">${balanceData.moneyOnHand?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
              </div>
              <div>
                <strong>Total Savings:</strong>
                <div style="font-size:1.2em; color:#ff9800;">${balanceData.savings?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
              </div>
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:0.8em; font-size:0.9em;">
              <div style="background:#e8f5e9; padding:0.5em; border-radius:4px;">
                <strong>Income:</strong> +${balanceData.incomeSum?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}
              </div>
              <div style="background:#ffebee; padding:0.5em; border-radius:4px;">
                <strong>Expenses:</strong> -${balanceData.expenseSum?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}
              </div>
              <div style="background:#e3f2fd; padding:0.5em; border-radius:4px;">
                <strong>From Savings:</strong> +${balanceData.incomingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}
              </div>
              <div style="background:#fff3e0; padding:0.5em; border-radius:4px;">
                <strong>To Savings:</strong> -${balanceData.outgoingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}
              </div>
            </div>
          </div>
        `;
        
        if (section === 'income') {
          document.getElementById('incomeBalances').innerHTML = html;
        } else if (section === 'expenses') {
          document.getElementById('expensesBalances').innerHTML = html;
        } else if (section === 'savings') {
          document.getElementById('savingsBalances').innerHTML = html;
        } else if (section === 'transfers') {
          document.getElementById('transfersBalances').innerHTML = html;
        }
      } catch (err) {
        console.error('Error loading balances:', err);
      }
    }

    function updateReportCurrencyDropdown() {
      const select = document.getElementById('reportCurrency');
      if (!select) return;
      select.innerHTML = '';
      getSelectedCurrencies().forEach(cur => {
        const option = document.createElement('option');
        option.value = cur;
        option.text = cur;
        select.appendChild(option);
      });
      select.value = getCurrency();
    }
    
    // Disable app (show only login/register)
    function disableApp() {
      // Hide all menu links and sections except login/register
      document.querySelectorAll('.menu-link').forEach(link => link.style.display = 'none');
      const registerLink = document.getElementById('registerLink');
      const loginLink = document.getElementById('loginLink');
      if (registerLink) registerLink.style.display = '';
      if (loginLink) loginLink.style.display = '';
      document.querySelectorAll('.container section').forEach(sec => sec.style.display = 'none');
      // Optionally show only the login section
      const loginSection = document.getElementById('login');
      if (loginSection) loginSection.style.display = 'block';
       document.body.classList.remove('logged-in');
    }
    
    function enableApp() {
      document.querySelectorAll('.menu-link').forEach(link => {
        // Hide login/register links, show all others
        if (link.id === 'loginLink' || link.id === 'registerLink') {
          link.style.display = 'none';
        } else {
          link.style.display = '';
        }
      });
       document.body.classList.add('logged-in');
       
      // Update all currency dropdowns with user's selected currencies
      updateReportCurrencyDropdown();
      updateBalanceCurrencyDropdown();
      updateIncomeCurrencyDropdown();
      updateExpenseCurrencyDropdown();
      updateSavingsCurrencyDropdown();
      updateTransferCurrencyDropdown();
    }
    
    function updateBalanceCurrencyDropdown() {
      const select = document.getElementById('balanceCurrency');
      if (!select) return;
      select.innerHTML = '';
      getSelectedCurrencies().forEach(cur => {
        const option = document.createElement('option');
        option.value = cur;
        option.text = cur;
        select.appendChild(option);
      });
      select.value = getCurrency();
    }
    
    function updateIncomeCurrencyDropdown() {
      const select = document.getElementById('incomeCurrency');
      if (!select) return;
      select.innerHTML = '';
      getSelectedCurrencies().forEach(cur => {
        const option = document.createElement('option');
        option.value = cur;
        option.text = cur;
        select.appendChild(option);
      });
      select.value = getCurrency();
    }
    
    function updateExpenseCurrencyDropdown() {
      const select = document.getElementById('expenseCurrency');
      if (!select) return;
      select.innerHTML = '';
      getSelectedCurrencies().forEach(cur => {
        const option = document.createElement('option');
        option.value = cur;
        option.text = cur;
        select.appendChild(option);
      });
      select.value = getCurrency();
    }
    
    function updateSavingsCurrencyDropdown() {
      const select = document.getElementById('savingsCurrency');
      if (!select) return;
      select.innerHTML = '';
      getSelectedCurrencies().forEach(cur => {
        const option = document.createElement('option');
        option.value = cur;
        option.text = cur;
        select.appendChild(option);
      });
      select.value = getCurrency();
    }
    
    function updateTransferCurrencyDropdown() {
      const select = document.getElementById('transferCurrency');
      if (!select) return;
      select.innerHTML = '';
      getSelectedCurrencies().forEach(cur => {
        const option = document.createElement('option');
        option.value = cur;
        option.text = cur;
        select.appendChild(option);
      });
      select.value = getCurrency();
    }
    
    function lockSavingsFormIfExists() {
      // Example: lock the savings form if initial savings are set (customize as needed)
      const savingsForm = document.getElementById('savingsForm');
      if (!savingsForm) return;
      // You can add logic here to disable the form or its button if needed
      // For now, we'll just enable it
      savingsForm.querySelector('button[type="submit"]').disabled = false;
    }
    
    // Monthly report submission
    document.getElementById('reportForm').onsubmit = async function(e) {
      e.preventDefault();
      try {
        const data = Object.fromEntries(new FormData(this));
        const params = new URLSearchParams(data).toString();
        const res = await authFetch('/report/monthly?' + params, { credentials: 'include' });
        if (res.status === 401) {
          forceLogoutOnError();
          return;
        }
        const report = await res.json();
        window.currentBalanceReport = report;
        renderBalanceReport(report, localStorage.getItem('balanceReportView') || 'flow');
        document.getElementById('reportResult').innerHTML = renderBalanceReport(report, localStorage.getItem('balanceReportView') || 'flow');
        renderSavingsReport(report);
      } catch (err) {
        forceLogoutOnError();
      }
    };

    function showReportTab(tab) {
  document.getElementById('reportTabBalance').style.display = tab === 'balance' ? '' : 'none';
  document.getElementById('reportTabSavings').style.display = tab === 'savings' ? '' : 'none';
  document.getElementById('tabBalance').classList.toggle('active', tab === 'balance');
  document.getElementById('tabSavings').classList.toggle('active', tab === 'savings');
}

function changeBalanceReportView(view) {
  localStorage.setItem('balanceReportView', view);
  if (window.currentBalanceReport) {
    document.getElementById('reportResult').innerHTML = renderBalanceReport(window.currentBalanceReport, view);
  }
}

function changeSavingsView(view) {
  localStorage.setItem('savingsReportView', view);
  if (window.currentSavingsReport) {
    document.getElementById('savingsReportResult').innerHTML = generateSavingsReportHTML(window.currentSavingsReport, view);
  }
}

function renderBalanceReport(report, view) {
  const viewSwitcher = `
    <div class="report-view-switcher">
      <button class="view-btn ${view === 'flow' ? 'active' : ''}" onclick="changeBalanceReportView('flow')">ğŸ“Š Flow</button>
      <button class="view-btn ${view === 'table' ? 'active' : ''}" onclick="changeBalanceReportView('table')">ğŸ“‹ Table</button>
      <button class="view-btn ${view === 'circle' ? 'active' : ''}" onclick="changeBalanceReportView('circle')">â­• Infographic</button>
      <button class="view-btn ${view === 'bars' ? 'active' : ''}" onclick="changeBalanceReportView('bars')">ğŸ“¶ Progress</button>
    </div>
  `;

  const maxAmount = Math.max(
    report.broughtForward || 0,
    report.totalIncome || 0,
    report.totalExpenses || 0,
    report.incomingTransfers || 0,
    report.outgoingTransfers || 0,
    Math.abs(report.net || 0)
  );

  if (view === 'flow') {
    return viewSwitcher + `
      <div class="report-flow">
        <div class="flow-item neutral">
          <div class="flow-icon">ğŸ“¦</div>
          <div class="flow-content">
            <div class="flow-label">Brought Forward</div>
            <div class="flow-value">${report.broughtForward?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
        <div class="flow-arrow">â•</div>
        <div class="flow-item credit">
          <div class="flow-icon">ğŸ’°</div>
          <div class="flow-content">
            <div class="flow-label">Total Income</div>
            <div class="flow-value">${report.totalIncome?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
        <div class="flow-arrow">â•</div>
        <div class="flow-item credit">
          <div class="flow-icon">ğŸ¦â¬‡ï¸</div>
          <div class="flow-content">
            <div class="flow-label">Transfers from Savings</div>
            <div class="flow-value">${report.incomingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
        <div class="flow-arrow">â–</div>
        <div class="flow-item debit">
          <div class="flow-icon">ğŸ’¸</div>
          <div class="flow-content">
            <div class="flow-label">Total Expenses</div>
            <div class="flow-value">${report.totalExpenses?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
        <div class="flow-arrow">â–</div>
        <div class="flow-item debit">
          <div class="flow-icon">ğŸ¦â¬†ï¸</div>
          <div class="flow-content">
            <div class="flow-label">Transfers to Savings</div>
            <div class="flow-value">${report.outgoingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
        <div class="flow-arrow">ğŸŸ°</div>
        <div class="flow-item net">
          <div class="flow-icon">ğŸ§®</div>
          <div class="flow-content">
            <div class="flow-label">Net Balance</div>
            <div class="flow-value">${report.net?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
      </div>
    `;
  } else if (view === 'table') {
    return viewSwitcher + `
      <div class="report-table">
        <div class="report-table-header">
          <div>ğŸ’° Credits (+)</div>
          <div>ğŸ’¸ Debits (âˆ’)</div>
        </div>
        <div class="report-table-body">
          <div class="table-column">
            <div class="table-item">
              <div class="table-item-label"><span>ğŸ“¦</span> Brought Forward</div>
              <div class="table-item-value">${report.broughtForward?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
            </div>
            <div class="table-item">
              <div class="table-item-label"><span>ğŸ’°</span> Total Income</div>
              <div class="table-item-value">${report.totalIncome?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
            </div>
            <div class="table-item">
              <div class="table-item-label"><span>ğŸ¦â¬‡ï¸</span> From Savings</div>
              <div class="table-item-value">${report.incomingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
            </div>
          </div>
          <div class="table-column">
            <div class="table-item">
              <div class="table-item-label"><span>ğŸ’¸</span> Total Expenses</div>
              <div class="table-item-value">${report.totalExpenses?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
            </div>
            <div class="table-item">
              <div class="table-item-label"><span>ğŸ¦â¬†ï¸</span> To Savings</div>
              <div class="table-item-value">${report.outgoingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
            </div>
          </div>
        </div>
        <div class="report-table-footer">
          <div class="table-net">ğŸ§® NET BALANCE</div>
          <div class="table-net-value">${report.net?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
        </div>
      </div>
    `;
  } else if (view === 'circle') {
    return viewSwitcher + `
      <div class="report-infographic">
        <div class="infographic-center">
          <div class="infographic-label">NET BALANCE</div>
          <div class="infographic-value">${report.net?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
        </div>
        <div class="infographic-items">
          <div class="infographic-item">
            <div class="infographic-item-icon">ğŸ“¦</div>
            <div class="infographic-item-label">Brought Forward</div>
            <div class="infographic-item-value">${report.broughtForward?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="infographic-item">
            <div class="infographic-item-icon">ğŸ’°</div>
            <div class="infographic-item-label">Total Income</div>
            <div class="infographic-item-value">${report.totalIncome?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="infographic-item">
            <div class="infographic-item-icon">ğŸ’¸</div>
            <div class="infographic-item-label">Total Expenses</div>
            <div class="infographic-item-value">${report.totalExpenses?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="infographic-item">
            <div class="infographic-item-icon">ğŸ¦â¬‡ï¸</div>
            <div class="infographic-item-label">From Savings</div>
            <div class="infographic-item-value">${report.incomingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="infographic-item">
            <div class="infographic-item-icon">ğŸ¦â¬†ï¸</div>
            <div class="infographic-item-label">To Savings</div>
            <div class="infographic-item-value">${report.outgoingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
      </div>
    `;
  } else if (view === 'bars') {
    return viewSwitcher + `
      <div class="report-bars">
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ“¦</span> Brought Forward</div>
            <div class="bar-value">${report.broughtForward?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill credit" style="width: ${(report.broughtForward / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ’°</span> Total Income</div>
            <div class="bar-value">${report.totalIncome?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill credit" style="width: ${(report.totalIncome / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ’¸</span> Total Expenses</div>
            <div class="bar-value">${report.totalExpenses?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill debit" style="width: ${(report.totalExpenses / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ¦â¬‡ï¸</span> Transfers from Savings</div>
            <div class="bar-value">${report.incomingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill credit" style="width: ${(report.incomingTransfers / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ¦â¬†ï¸</span> Transfers to Savings</div>
            <div class="bar-value">${report.outgoingTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill debit" style="width: ${(report.outgoingTransfers / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ§®</span> Net Balance</div>
            <div class="bar-value">${report.net?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill net" style="width: ${(Math.abs(report.net) / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
      </div>
    `;
  }
  return '';
}

function renderSavingsReport(report) {
  window.currentSavingsReport = report;
  const view = localStorage.getItem('savingsReportView') || 'flow';
  document.getElementById('savingsReportResult').innerHTML = generateSavingsReportHTML(report, view);
}

function generateSavingsReportHTML(report, view) {
  const viewSwitcher = `
    <div class="report-view-switcher">
      <button class="view-btn ${view === 'flow' ? 'active' : ''}" onclick="changeSavingsView('flow')">ğŸ“Š Flow</button>
      <button class="view-btn ${view === 'table' ? 'active' : ''}" onclick="changeSavingsView('table')">ğŸ“‹ Table</button>
      <button class="view-btn ${view === 'circle' ? 'active' : ''}" onclick="changeSavingsView('circle')">â­• Infographic</button>
      <button class="view-btn ${view === 'bars' ? 'active' : ''}" onclick="changeSavingsView('bars')">ğŸ“¶ Progress</button>
    </div>
  `;

  if (view === 'flow') {
    return viewSwitcher + `
      <div class="report-flow">
        <div class="flow-item credit">
          <div class="flow-icon">ğŸ’°</div>
          <div class="flow-content">
            <div class="flow-label">Savings This Month</div>
            <div class="flow-value">${report.savingsThisMonth?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
        <div class="flow-arrow">â•</div>
        <div class="flow-item credit">
          <div class="flow-icon">ğŸ¦â¬‡ï¸</div>
          <div class="flow-content">
            <div class="flow-label">Transfers from Balance</div>
            <div class="flow-value">${report.incomingSavingsTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
        <div class="flow-arrow">â–</div>
        <div class="flow-item debit">
          <div class="flow-icon">ğŸ¦â¬†ï¸</div>
          <div class="flow-content">
            <div class="flow-label">Transfers to Balance</div>
            <div class="flow-value">${report.outgoingSavingsTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
        <div class="flow-arrow">ğŸŸ°</div>
        <div class="flow-item net">
          <div class="flow-icon">ğŸ§®</div>
          <div class="flow-content">
            <div class="flow-label">Total Savings This Month</div>
            <div class="flow-value">${report.totalSavingsThisMonth?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
      </div>
    `;
  } else if (view === 'table') {
    return viewSwitcher + `
      <div class="report-table">
        <div class="report-table-header">
          <div>ğŸ’° Credits (+)</div>
          <div>ğŸ’¸ Debits (âˆ’)</div>
        </div>
        <div class="report-table-body">
          <div class="table-column">
            <div class="table-item">
              <div class="table-item-label"><span>ğŸ’°</span> Savings This Month</div>
              <div class="table-item-value">${report.savingsThisMonth?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
            </div>
            <div class="table-item">
              <div class="table-item-label"><span>ğŸ¦â¬‡ï¸</span> From Balance</div>
              <div class="table-item-value">${report.incomingSavingsTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
            </div>
          </div>
          <div class="table-column">
            <div class="table-item">
              <div class="table-item-label"><span>ğŸ¦â¬†ï¸</span> To Balance</div>
              <div class="table-item-value">${report.outgoingSavingsTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
            </div>
          </div>
        </div>
        <div class="report-table-footer">
          <div class="table-net">ğŸ§® TOTAL SAVINGS THIS MONTH</div>
          <div class="table-net-value">${report.totalSavingsThisMonth?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
        </div>
      </div>
    `;
  } else if (view === 'circle') {
    return viewSwitcher + `
      <div class="report-infographic">
        <div class="infographic-center">
          <div class="infographic-label">TOTAL SAVINGS</div>
          <div class="infographic-value">${report.totalSavingsThisMonth?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
        </div>
        <div class="infographic-items">
          <div class="infographic-item">
            <div class="infographic-item-icon">ğŸ’°</div>
            <div class="infographic-item-label">Savings This Month</div>
            <div class="infographic-item-value">${report.savingsThisMonth?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="infographic-item">
            <div class="infographic-item-icon">ğŸ¦â¬‡ï¸</div>
            <div class="infographic-item-label">From Balance</div>
            <div class="infographic-item-value">${report.incomingSavingsTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="infographic-item">
            <div class="infographic-item-icon">ğŸ¦â¬†ï¸</div>
            <div class="infographic-item-label">To Balance</div>
            <div class="infographic-item-value">${report.outgoingSavingsTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
        </div>
      </div>
    `;
  } else if (view === 'bars') {
    const maxAmount = Math.max(
      report.savingsThisMonth || 0,
      report.incomingSavingsTransfers || 0,
      report.outgoingSavingsTransfers || 0,
      Math.abs(report.totalSavingsThisMonth || 0)
    );
    
    return viewSwitcher + `
      <div class="report-bars">
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ’°</span> Savings This Month</div>
            <div class="bar-value">${report.savingsThisMonth?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill credit" style="width: ${(report.savingsThisMonth / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ¦â¬‡ï¸</span> Transfers from Balance</div>
            <div class="bar-value">${report.incomingSavingsTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill credit" style="width: ${(report.incomingSavingsTransfers / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ¦â¬†ï¸</span> Transfers to Balance</div>
            <div class="bar-value">${report.outgoingSavingsTransfers?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill debit" style="width: ${(report.outgoingSavingsTransfers / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-header">
            <div class="bar-label"><span>ğŸ§®</span> Total Savings This Month</div>
            <div class="bar-value">${report.totalSavingsThisMonth?.toLocaleString(undefined, {minimumFractionDigits:2}) ?? 0}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill net" style="width: ${(Math.abs(report.totalSavingsThisMonth) / maxAmount * 100) || 0}%"></div>
          </div>
        </div>
      </div>
    `;
  }
  return '';
}
    function expandTransferGroup(group) {
  if (!window.transferGroupState) window.transferGroupState = {};
  const wasOpen = !!window.transferGroupState[group];
  // Collapse all groups
  Object.keys(window.transferGroupState).forEach(k => window.transferGroupState[k] = false);
  // Toggle: expand if not open, collapse if open
  if (!wasOpen) window.transferGroupState[group] = true;
  renderTransferGrid(); // Just re-render, don't fetch
}
    function expandIncomeGroup(currency) {
      if (!window.incomeGroupState) window.incomeGroupState = {};
      const wasOpen = !!window.incomeGroupState[currency];
      Object.keys(window.incomeGroupState).forEach(k => window.incomeGroupState[k] = false);
      if (!wasOpen) window.incomeGroupState[currency] = true;
      fetchIncome();
    }
    function expandExpenseGroup(currency) {
      if (!window.expenseGroupState) window.expenseGroupState = {};
      const wasOpen = !!window.expenseGroupState[currency];
      Object.keys(window.expenseGroupState).forEach(k => window.expenseGroupState[k] = false);
      if (!wasOpen) window.expenseGroupState[currency] = true;
      fetchExpenses();
    }
  
let idleTimeout;

function resetIdleTimer() {
  clearTimeout(idleTimeout);
  idleTimeout = setTimeout(() => {
    logout();
    setTimeout(() => {
      alert('You have been logged out due to inactivity.');
    }, 100); // slight delay to ensure UI updates before alert
  }, 5 * 60 * 1000); // 5 minutes
}
// Attach event listeners for user activity
['mousemove', 'keydown', 'mousedown', 'touchstart'].forEach(evt =>
  document.addEventListener(evt, () => {
    // Only reset timer if logged in
    if (localStorage.getItem('jwtToken')) {
      resetIdleTimer();
    }
  })
);

// Start the timer after successful login
async function onLoginSuccess(user, isInitialLoad = false) {
  hideSection('login');
  hideSection('register');
  showProfile(user || JSON.parse(localStorage.getItem('user')));
  enableApp();
  openSidebar();
  showBalances();
  
  // Load dashboard data and counters
  if (typeof loadDashboardData === 'function') {
    loadDashboardData();
  }
  
  // Load recent entries
  if (typeof loadRecentEntries === 'function') {
    loadRecentEntries();
  }
  
  // Fetch user's currencies from backend
  try {
    const res = await authFetch('/user/currencies', { showExpiredAlert: !isInitialLoad });
    if (res.ok) {
      const data = await res.json();
      const currencies = data.currencies || [];
      
      if (currencies.length === 0) {
        // No currencies in database - force user to select
        console.log('No currencies found, showing picker');
        showCurrencyPickerModal();
      } else {
        // Save currencies to localStorage
        const currencyCodes = currencies.map(c => c.currencyCode);
        console.log('Currencies found:', currencyCodes);
        setSelectedCurrencies(currencyCodes);
        
        let lastSection = localStorage.getItem('lastSection') || 'balances';
        if (lastSection === 'login' || lastSection === 'register') {
          lastSection = 'balances';
          localStorage.setItem('lastSection', lastSection);
        }
        showSection(lastSection);
        resetIdleTimer();
      }
    } else {
      // API error - show picker as fallback
      console.log('API error, showing picker');
      showCurrencyPickerModal();
    }
  } catch (err) {
    console.error('Failed to fetch currencies:', err);
    // Don't show picker on error - user might already have currencies
    // Check localStorage first
    const localCurrencies = getSelectedCurrencies();
    if (localCurrencies && localCurrencies.length > 0) {
      console.log('Using currencies from localStorage:', localCurrencies);
      let lastSection = localStorage.getItem('lastSection') || 'balances';
      if (lastSection === 'login' || lastSection === 'register') {
        lastSection = 'balances';
        localStorage.setItem('lastSection', lastSection);
      }
      showSection(lastSection);
      resetIdleTimer();
    } else {
      console.log('No currencies in localStorage, showing picker');
      showCurrencyPickerModal();
    }
  }
}

// Show currency picker modal
function showCurrencyPickerModal() {
  console.log('Showing currency picker modal');
  const modal = document.getElementById('currencyPickerModal');
  const optionsDiv = document.getElementById('currencyOptions');
  
  // Clear previous content
  optionsDiv.innerHTML = '';
  
  // Get currently selected currencies from localStorage
  const currentlySelected = getSelectedCurrencies();
  console.log('Currently selected currencies:', currentlySelected);
  
  SUPPORTED_CURRENCIES.forEach(cur => {
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems = 'center';
    label.style.marginBottom = '0.8em';
    label.style.padding = '0.8em';
    label.style.border = '2px solid #ddd';
    label.style.borderRadius = '8px';
    label.style.cursor = 'pointer';
    label.style.transition = 'all 0.2s';
    label.style.background = 'white';
    label.style.fontSize = '1.1em';
    
    const isChecked = currentlySelected.includes(cur.code);
    
    // Create checkbox
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'currency-picker-checkbox';
    checkbox.value = cur.code;
    checkbox.checked = isChecked;
    checkbox.style.width = '20px';
    checkbox.style.height = '20px';
    checkbox.style.marginRight = '0.8em';
    checkbox.style.cursor = 'pointer';
    
    // Create icon span
    const icon = document.createElement('span');
    icon.style.fontSize = '1.5em';
    icon.style.marginRight = '0.5em';
    icon.textContent = cur.icon;
    
    // Create label text
    const text = document.createElement('span');
    text.innerHTML = `<strong>${cur.label}</strong> <span style="color:#666;">(${cur.code})</span>`;
    
    // Add change listener to update styling
    checkbox.addEventListener('change', () => {
      if (checkbox.checked) {
        label.style.background = '#e8f5e9';
        label.style.borderColor = '#4caf50';
        label.style.borderWidth = '3px';
        label.style.fontWeight = '600';
      } else {
        label.style.background = 'white';
        label.style.borderColor = '#ddd';
        label.style.borderWidth = '2px';
        label.style.fontWeight = 'normal';
      }
      
      // Validate selection (max 2 currencies)
      const checkedCount = document.querySelectorAll('.currency-picker-checkbox:checked').length;
      if (checkedCount > MAX_CURRENCIES) {
        checkbox.checked = false;
        label.style.background = 'white';
        label.style.borderColor = '#ddd';
        label.style.borderWidth = '2px';
        label.style.fontWeight = 'normal';
        alert(`You can only select up to ${MAX_CURRENCIES} currencies.`);
      }
    });
    
    // Apply initial styling if checked
    if (isChecked) {
      label.style.background = '#e8f5e9';
      label.style.borderColor = '#4caf50';
      label.style.borderWidth = '3px';
      label.style.fontWeight = '600';
    }
    
    // Add hover effect
    label.addEventListener('mouseenter', () => {
      if (!checkbox.checked) {
        label.style.background = '#f8f9fa';
        label.style.borderColor = '#4caf50';
      }
    });
    label.addEventListener('mouseleave', () => {
      if (!checkbox.checked) {
        label.style.background = 'white';
        label.style.borderColor = '#ddd';
      }
    });
    
    // Append elements
    label.appendChild(checkbox);
    label.appendChild(icon);
    label.appendChild(text);
    optionsDiv.appendChild(label);
  });
  
  // If no currencies selected, pre-check USD and LBP as defaults
  if (currentlySelected.length === 0) {
    setTimeout(() => {
      const usdBox = optionsDiv.querySelector('input[value="USD"]');
      const lbpBox = optionsDiv.querySelector('input[value="LBP"]');
      if (usdBox) {
        usdBox.checked = true;
        usdBox.dispatchEvent(new Event('change'));
      }
      if (lbpBox) {
        lbpBox.checked = true;
        lbpBox.dispatchEvent(new Event('change'));
      }
    }, 50);
  }
  
  modal.style.display = 'flex';
}

// Helper function to save currencies to backend
async function saveCurrenciesToBackend(currencies) {
  try {
    await authFetch('/user/currencies', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ currencies })
    });
    console.log('Currencies saved to database');
  } catch (err) {
    console.error('Failed to save currencies:', err);
  }
}

// Clear the timer on logout
function logout() {
  clearTimeout(idleTimeout); // Clear idle timer if running
  if (typeof stopSessionTimer === 'function') {
    stopSessionTimer(); // Stop session timer
  }
  localStorage.removeItem('user');
  localStorage.removeItem('jwtToken'); // Also remove token for security
  hideProfile();
  disableApp();
  hideApp(); // Show initial screen instead of login section
}
  </script>
  <script src="js/menu.js?v=20251206c"></script>
  <script>
// Sidebar logic
console.log('Sidebar script loaded');
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const sidebarBackdrop = document.getElementById('sidebarBackdrop');
  const menuLinks = sidebar.querySelectorAll('.menu-link');
  const container = document.querySelector('.container'); // Now this will not be null
console.log('Elements found:', {sidebar, sidebarToggle, sidebarBackdrop, menuLinks: menuLinks.length});

  function openSidebar() {
    console.log('Opening sidebar');
    console.log('Sidebar element:', sidebar);
    console.log('Sidebar classList before:', sidebar.classList.toString());
    sidebar.classList.add('show');
    console.log('Sidebar classList after:', sidebar.classList.toString());
    sidebarToggle.classList.add('active');
    // CSS handles: backdrop display, container margin, toggle visibility
    // Only prevent body scroll on mobile
    if (window.innerWidth <= 700) {
      document.body.style.overflow = 'hidden';
    }
  }
  
  function closeSidebar() {
    console.log('Closing sidebar');
    sidebar.classList.remove('show');
    sidebarToggle.classList.remove('active');
    // CSS handles: backdrop display, container margin, toggle visibility
    document.body.style.overflow = '';
  }

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded fired');
  // Transfer dropdown sync logic (unchanged)
  const fromSelect = document.getElementById('transferFrom');
  const toSelect = document.getElementById('transferTo');
  function syncTransferDropdowns() {
    if (fromSelect.value === 'money_on_hand') {
      toSelect.value = 'savings';
    } else {
      toSelect.value = 'money_on_hand';
    }
  }
  fromSelect && fromSelect.addEventListener('change', syncTransferDropdowns);
  toSelect && toSelect.addEventListener('change', function() {
    if (toSelect.value === 'money_on_hand') {
      fromSelect.value = 'savings';
    } else {
      fromSelect.value = 'money_on_hand';
    }
  });
  syncTransferDropdowns();

  
  function hideAllSections() {
    document.querySelectorAll('.container section').forEach(sec => sec.style.display = 'none');
  }


  sidebarToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    e.preventDefault();
    console.log('Toggle clicked, sidebar.show:', sidebar.classList.contains('show'));
    if (sidebar.classList.contains('show')) {
      closeSidebar();
    } else {
      openSidebar();
    }
  });

  sidebarBackdrop.addEventListener('click', closeSidebar);

  menuLinks.forEach(link => {
    link.addEventListener('click', function() {
      closeSidebar();
    });
  });

  document.addEventListener('click', function(e) {
    if (
      sidebar.classList.contains('show') &&
      !sidebar.contains(e.target) &&
      !e.target.closest('#sidebarToggle')
    ) {
      closeSidebar();
    }
  });

  // Always start collapsed
  closeSidebar();
});
</script>

<!-- Enhanced Menu Features Script -->
<script src="js/enhancements.js?v=20251206"></script>

<!--Start of Tawk.to Script-->
<script type="text/javascript">
// Only load Tawk.to chat widget if user is signed in
(function() {
  const token = localStorage.getItem('jwtToken');
  if (!token) {
    return; // Don't load chat widget at all if not signed in
  }
  
  // User is signed in, load the widget
  var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
  var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
  s1.async=true;
  s1.src='https://embed.tawk.to/6932679a1fe45f1982d312ef/1jbme9d75';
  s1.charset='UTF-8';
  s1.setAttribute('crossorigin','*');
  s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to Script-->

</body>
</html>